var Me=Object.defineProperty;var Te=(r,e,n)=>e in r?Me(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n;var Rt=(r,e,n)=>(Te(r,typeof e!="symbol"?e+"":e,n),n);import{r as S,a as ke,g as Pe,R as $t}from"./vendor-1.1.0-57209f9c.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();var de={exports:{}},Ft={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ge=S,Oe=Symbol.for("react.element"),Ae=Symbol.for("react.fragment"),Ee=Object.prototype.hasOwnProperty,Be=Ge.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,xe={key:!0,ref:!0,__self:!0,__source:!0};function pe(r,e,n){var o,s={},a=null,l=null;n!==void 0&&(a=""+n),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(l=e.ref);for(o in e)Ee.call(e,o)&&!xe.hasOwnProperty(o)&&(s[o]=e[o]);if(r&&r.defaultProps)for(o in e=r.defaultProps,e)s[o]===void 0&&(s[o]=e[o]);return{$$typeof:Oe,type:r,key:a,ref:l,props:s,_owner:Be.current}}Ft.Fragment=Ae;Ft.jsx=pe;Ft.jsxs=pe;de.exports=Ft;var P=de.exports,Jt={},ee=ke;Jt.createRoot=ee.createRoot,Jt.hydrateRoot=ee.hydrateRoot;var ge={exports:{}},Le="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",_e=Le,Ne=_e;function me(){}function ye(){}ye.resetWarningCache=me;var Ie=function(){function r(o,s,a,l,f,i){if(i!==Ne){var c=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw c.name="Invariant Violation",c}}r.isRequired=r;function e(){return r}var n={array:r,bigint:r,bool:r,func:r,number:r,object:r,string:r,symbol:r,any:r,arrayOf:e,element:r,elementType:r,instanceOf:e,node:r,objectOf:e,oneOf:e,oneOfType:e,shape:e,exact:e,checkPropTypes:ye,resetWarningCache:me};return n.PropTypes=n,n};ge.exports=Ie();var je=ge.exports;const L=Pe(je);function $e(r,e){r.prototype=Object.create(e.prototype),r.prototype.constructor=r,Zt(r,e)}function Zt(r,e){return Zt=Object.setPrototypeOf||function(n,o){return n.__proto__=o,n},Zt(r,e)}var Z={BASE:"base",BODY:"body",HEAD:"head",HTML:"html",LINK:"link",META:"meta",NOSCRIPT:"noscript",SCRIPT:"script",STYLE:"style",TITLE:"title",FRAGMENT:"Symbol(react.fragment)"},ze={rel:["amphtml","canonical","alternate"]},Ye={type:["application/ld+json"]},De={charset:"",name:["robots","description"],property:["og:type","og:title","og:url","og:image","og:image:alt","og:description","twitter:url","twitter:title","twitter:description","twitter:image","twitter:image:alt","twitter:card","twitter:site"]};Object.keys(Z).map(function(r){return Z[r]});var Dt={accesskey:"accessKey",charset:"charSet",class:"className",contenteditable:"contentEditable",contextmenu:"contextMenu","http-equiv":"httpEquiv",itemprop:"itemProp",tabindex:"tabIndex"};Object.keys(Dt).reduce(function(r,e){return r[Dt[e]]=e,r},{});var Fe=function(r){return Array.isArray(r)?r.join(""):r},qt=function(r,e){return Array.isArray(r)?r.reduce(function(n,o){return function(s,a){for(var l=Object.keys(s),f=0;f<l.length;f+=1)if(a[l[f]]&&a[l[f]].includes(s[l[f]]))return!0;return!1}(o,e)?n.priority.push(o):n.default.push(o),n},{priority:[],default:[]}):{default:r}},We=[Z.NOSCRIPT,Z.SCRIPT,Z.STYLE],Vt=function(r,e){return e===void 0&&(e=!0),e===!1?String(r):String(r).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")},oe=function(r){return Object.keys(r).reduce(function(e,n){var o=r[n]!==void 0?n+'="'+r[n]+'"':""+n;return e?e+" "+o:o},"")},ne=function(r,e){return e===void 0&&(e={}),Object.keys(r).reduce(function(n,o){return n[Dt[o]||o]=r[o],n},e)},Yt=function(r,e){return e.map(function(n,o){var s,a=((s={key:o})["data-rh"]=!0,s);return Object.keys(n).forEach(function(l){var f=Dt[l]||l;f==="innerHTML"||f==="cssText"?a.dangerouslySetInnerHTML={__html:n.innerHTML||n.cssText}:a[f]=n[l]}),$t.createElement(r,a)})},wt=function(r,e,n){switch(r){case Z.TITLE:return{toComponent:function(){return s=e.titleAttributes,(a={key:o=e.title})["data-rh"]=!0,l=ne(s,a),[$t.createElement(Z.TITLE,l,o)];var o,s,a,l},toString:function(){return function(o,s,a,l){var f=oe(a),i=Fe(s);return f?"<"+o+' data-rh="true" '+f+">"+Vt(i,l)+"</"+o+">":"<"+o+' data-rh="true">'+Vt(i,l)+"</"+o+">"}(r,e.title,e.titleAttributes,n)}};case"bodyAttributes":case"htmlAttributes":return{toComponent:function(){return ne(e)},toString:function(){return oe(e)}};default:return{toComponent:function(){return Yt(r,e)},toString:function(){return function(o,s,a){return s.reduce(function(l,f){var i=Object.keys(f).filter(function(b){return!(b==="innerHTML"||b==="cssText")}).reduce(function(b,y){var g=f[y]===void 0?y:y+'="'+Vt(f[y],a)+'"';return b?b+" "+g:g},""),c=f.innerHTML||f.cssText||"",h=We.indexOf(o)===-1;return l+"<"+o+' data-rh="true" '+i+(h?"/>":">"+c+"</"+o+">")},"")}(r,e,n)}}}},Xe=function(r){var e=r.baseTag,n=r.bodyAttributes,o=r.encode,s=r.htmlAttributes,a=r.noscriptTags,l=r.styleTags,f=r.title,i=f===void 0?"":f,c=r.titleAttributes,h=r.linkTags,b=r.metaTags,y=r.scriptTags,g={toComponent:function(){},toString:function(){return""}};if(r.prioritizeSeoTags){var T=function(Y){var I=Y.linkTags,W=Y.scriptTags,V=Y.encode,z=qt(Y.metaTags,De),O=qt(I,ze),D=qt(W,Ye);return{priorityMethods:{toComponent:function(){return[].concat(Yt(Z.META,z.priority),Yt(Z.LINK,O.priority),Yt(Z.SCRIPT,D.priority))},toString:function(){return wt(Z.META,z.priority,V)+" "+wt(Z.LINK,O.priority,V)+" "+wt(Z.SCRIPT,D.priority,V)}},metaTags:z.default,linkTags:O.default,scriptTags:D.default}}(r);g=T.priorityMethods,h=T.linkTags,b=T.metaTags,y=T.scriptTags}return{priority:g,base:wt(Z.BASE,e,o),bodyAttributes:wt("bodyAttributes",n,o),htmlAttributes:wt("htmlAttributes",s,o),link:wt(Z.LINK,h,o),meta:wt(Z.META,b,o),noscript:wt(Z.NOSCRIPT,a,o),script:wt(Z.SCRIPT,y,o),style:wt(Z.STYLE,l,o),title:wt(Z.TITLE,{title:i,titleAttributes:c},o)}},zt=[],He=function(r,e){var n=this;e===void 0&&(e=typeof document<"u"),this.instances=[],this.value={setHelmet:function(o){n.context.helmet=o},helmetInstances:{get:function(){return n.canUseDOM?zt:n.instances},add:function(o){(n.canUseDOM?zt:n.instances).push(o)},remove:function(o){var s=(n.canUseDOM?zt:n.instances).indexOf(o);(n.canUseDOM?zt:n.instances).splice(s,1)}}},this.context=r,this.canUseDOM=e,e||(r.helmet=Xe({baseTag:[],bodyAttributes:{},encodeSpecialCharacters:!0,htmlAttributes:{},linkTags:[],metaTags:[],noscriptTags:[],scriptTags:[],styleTags:[],title:"",titleAttributes:{}}))},Ue=$t.createContext({}),qe=L.shape({setHelmet:L.func,helmetInstances:L.shape({get:L.func,add:L.func,remove:L.func})}),Ve=typeof document<"u",It=function(r){function e(n){var o;return(o=r.call(this,n)||this).helmetData=new He(o.props.context,e.canUseDOM),o}return $e(e,r),e.prototype.render=function(){return $t.createElement(Ue.Provider,{value:this.helmetData.value},this.props.children)},e}(S.Component);It.canUseDOM=Ve,It.propTypes={context:L.shape({helmet:L.shape()}),children:L.node.isRequired},It.defaultProps={context:{}},It.displayName="HelmetProvider";qe.isRequired;L.object,L.object,L.oneOfType([L.arrayOf(L.node),L.node]),L.string,L.bool,L.bool,L.object,L.arrayOf(L.object),L.arrayOf(L.object),L.arrayOf(L.object),L.func,L.arrayOf(L.object),L.arrayOf(L.object),L.string,L.object,L.string,L.bool,L.object;class Ke extends S.Component{constructor(){super(...arguments);Rt(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,o){console.error("Uncaught error:",n,o)}render(){return this.state.hasError?this.props.fallback||P.jsxs("div",{className:"error-boundary",children:[P.jsx("h2",{children:"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"}),P.jsx("p",{children:"ê²Œìž„ì„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”."}),P.jsx("button",{onClick:()=>window.location.reload(),children:"ìƒˆë¡œê³ ì¹¨"})]}):this.props.children}}const Je="modulepreload",Ze=function(r){return"/ChipPuzzleGame/"+r},re={},Nt=function(e,n,o){if(!n||n.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(n.map(a=>{if(a=Ze(a),a in re)return;re[a]=!0;const l=a.endsWith(".css"),f=l?'[rel="stylesheet"]':"";if(!!o)for(let h=s.length-1;h>=0;h--){const b=s[h];if(b.href===a&&(!l||b.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${f}`))return;const c=document.createElement("link");if(c.rel=l?"stylesheet":Je,l||(c.as="script",c.crossOrigin=""),c.href=a,document.head.appendChild(c),l)return new Promise((h,b)=>{c.addEventListener("load",h),c.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${a}`)))})})).then(()=>e()).catch(a=>{const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a})},Qe=(r,e)=>{const n=r[e];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((o,s)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(s.bind(null,new Error("Unknown variable dynamic import: "+e)))})},Se=["en","ko","zh","ja"],to="en",eo={en:"English",ko:"í•œêµ­ì–´",zh:"ä¸­æ–‡",ja:"æ—¥æœ¬èªž"};class se{constructor(){Rt(this,"supportedLanguages",Se);Rt(this,"defaultLanguage",to)}detectBrowserLanguage(){const e=navigator.language.split("-")[0];return this.supportedLanguages.includes(e)?e:this.defaultLanguage}getStoredLanguage(){try{return localStorage.getItem("language")}catch(e){return console.error("Failed to get stored language:",e),null}}setLanguage(e){if(this.supportedLanguages.includes(e))try{localStorage.setItem("language",e),window.dispatchEvent(new CustomEvent("languageChanged",{detail:e}))}catch(n){console.error("Failed to set language:",n)}}getCurrentLanguage(){const e=this.getStoredLanguage();return e&&this.supportedLanguages.includes(e)?e:this.detectBrowserLanguage()}}const Kt={},Wt=()=>{const[r,e]=S.useState(()=>new se().getCurrentLanguage()),[n,o]=S.useState(null),[s,a]=S.useState(!0);return S.useEffect(()=>{(async()=>{a(!0);try{if(Kt[r]){o(Kt[r]),a(!1);return}const h=await Qe(Object.assign({"../locales/en.json":()=>Nt(()=>import("./en-1.1.0-b0bc0d43.js"),[]),"../locales/ja.json":()=>Nt(()=>import("./ja-1.1.0-0635fea6.js"),[]),"../locales/ko.json":()=>Nt(()=>import("./ko-1.1.0-f4262f42.js"),[]),"../locales/zh.json":()=>Nt(()=>import("./zh-1.1.0-ea7490c2.js"),[])}),`../locales/${r}.json`);Kt[r]=h.default,o(h.default)}catch(h){console.error(`Failed to load translations for ${r}:`,h);try{const b=await Nt(()=>import("./en-1.1.0-b0bc0d43.js"),[]);o(b.default)}catch(b){console.error("Failed to load fallback translations:",b)}}finally{a(!1)}})();const c=h=>{e(h.detail)};return window.addEventListener("languageChanged",c),()=>{window.removeEventListener("languageChanged",c)}},[r]),{language:r,setLanguage:i=>{new se().setLanguage(i)},t:i=>{if(s||!n)return i;const c=i.split(".");let h=n;for(const b of c)if(h=h==null?void 0:h[b],h===void 0)break;return h||i},isLoading:s}},be=()=>{const{language:r,setLanguage:e}=Wt();return P.jsx("select",{value:r,onChange:n=>e(n.target.value),className:"language-selector","aria-label":"Language selector",children:Se.map(n=>P.jsx("option",{value:n,children:eo[n]},n))})};class oo{constructor(){Rt(this,"audioCtx",null);Rt(this,"enabled",!0)}getContext(){if(!this.enabled)return null;try{if(!this.audioCtx){const e=window.AudioContext||window.webkitAudioContext;if(!e)return console.warn("Web Audio API is not supported in this browser."),this.enabled=!1,null;try{this.audioCtx=new e,this.audioCtx.state==="suspended"&&this.audioCtx.resume().catch(n=>{console.warn("Failed to resume AudioContext",n)})}catch(n){return console.warn("Failed to create AudioContext",n),this.enabled=!1,null}}return this.audioCtx}catch(e){return console.warn("Failed to initialize AudioContext",e),this.enabled=!1,null}}setEnabled(e){this.enabled=e}playTone(e,n,o="sine",s=.2){const a=this.getContext();if(!a)return;const l=a.createOscillator(),f=a.createGain();l.type=o,l.frequency.value=e,f.gain.value=s,l.connect(f),f.connect(a.destination);const i=a.currentTime;l.start(i),l.stop(i+n),f.gain.setValueAtTime(s,i),f.gain.linearRampToValueAtTime(0,i+n)}playClick(){this.playTone(440,.08,"square",.15)}playMatch(){this.playTone(660,.12,"triangle",.2)}playSpecial(){this.playTone(880,.16,"sawtooth",.22)}playStageClear(){this.getContext()&&(this.playTone(880,.15,"triangle",.22),setTimeout(()=>{this.playTone(1046.5,.18,"triangle",.22)},120))}playGameOver(){const e=this.getContext();if(!e)return;const n=440,o=220,s=.4,a=e.createOscillator(),l=e.createGain();a.type="sawtooth",a.frequency.setValueAtTime(n,e.currentTime),a.frequency.exponentialRampToValueAtTime(o,e.currentTime+s),l.gain.value=.22,l.gain.setValueAtTime(.22,e.currentTime),l.gain.linearRampToValueAtTime(0,e.currentTime+s),a.connect(l),l.connect(e.destination),a.start(e.currentTime),a.stop(e.currentTime+s)}}const gt=new oo;const ae=r=>`/ChipPuzzleGame/${r}`,no=({onNavigate:r,currentScreen:e})=>{const{t:n}=Wt(),[o,s]=S.useState(()=>{const i=localStorage.getItem("chipPuzzleGame_soundEnabled");return i!==null?JSON.parse(i):!0});S.useEffect(()=>{gt.setEnabled(o),localStorage.setItem("chipPuzzleGame_soundEnabled",JSON.stringify(o))},[o]);const a=i=>{r&&r(i)},l=()=>{s(!o),o||gt.playClick()},f=!1;return P.jsx("header",{className:"header",children:P.jsxs("div",{className:"header-content",children:[P.jsxs("div",{className:"header-left",children:[f,P.jsxs("div",{className:"header-logo",onClick:()=>a("stageSelect"),style:{cursor:"pointer",display:"flex",alignItems:"center",gap:"12px"},children:[P.jsx("img",{src:ae("ChipGames_Logo.png"),onError:i=>{const c=i.target;c.src&&!c.src.includes(".svg")&&(c.src=ae("ChipGames_Logo.svg"))},alt:"CHIP GAMES",style:{height:"40px",width:"auto"}}),P.jsx("span",{className:"header-game-title",children:n("header.gameTitle")})]})]}),P.jsxs("nav",{className:"header-nav",children:[P.jsx("button",{className:"header-nav-button",onClick:()=>a("stageSelect"),children:n("header.playGame")}),P.jsx("button",{className:"header-nav-button",onClick:()=>a("guide"),children:n("header.guide")}),P.jsx("button",{className:"header-nav-button",onClick:()=>a("help"),children:n("header.help")})]}),P.jsxs("div",{className:"header-right",children:[P.jsx("button",{className:"header-sound-button",onClick:l,title:n(o?"header.soundOff":"header.soundOn"),children:o?"ðŸ”Š":"ðŸ”‡"}),P.jsx(be,{})]})]})})};const ro="1.1.0",so=()=>{const{t:r}=Wt();return P.jsx("footer",{className:"footer",children:P.jsxs("div",{className:"footer-content",children:[P.jsxs("div",{className:"footer-links",children:[P.jsx("a",{href:"#privacy",children:r("footer.privacyPolicy")}),P.jsx("a",{href:"#contact",children:r("footer.contactUs")})]}),P.jsx(be,{}),P.jsxs("div",{className:"footer-copyright",children:[r("footer.copyright")," | v",ro]})]})})};const ao=({children:r})=>P.jsx("div",{className:"game-container",children:r}),we={aspectRatio:16/9,gridRows:9,gridCols:9,pixelRatio:window.devicePixelRatio||1};const io=({config:r,onReady:e,onResize:n})=>{const o=S.useRef(null),s=S.useRef(null),a=S.useRef(e),l=S.useRef(n),f=S.useRef(!1);return S.useEffect(()=>{a.current=e},[e]),S.useEffect(()=>{l.current=n},[n]),S.useEffect(()=>{const i=o.current,c=s.current;if(!i||!c)return;const h=i.getContext("2d");if(!h){console.error("Failed to get 2D context");return}const b=()=>{const g=window.devicePixelRatio||1,T=c.clientWidth,Y=c.clientHeight,I=r.aspectRatio||we.aspectRatio||16/9,W=1200,V=675;let z,O;const D=Math.min(T,W),ct=Math.min(Y,V);D/ct>I?(O=ct,z=O*I):(z=D,O=z/I),i.width=z*g,i.height=O*g,h.scale(g,g),i.style.width=`${z}px`,i.style.height=`${O}px`,i.style.display="block",i.style.maxWidth="100%",i.style.maxHeight="100%",!f.current&&a.current&&(f.current=!0,a.current(i,h)),f.current&&l.current&&setTimeout(()=>{l.current&&l.current(i,h)},0)};b();const y=new ResizeObserver(()=>{b()});return y.observe(c),()=>{y.disconnect(),f.current=!1}},[r]),P.jsx("div",{ref:s,className:"game-canvas-wrapper",children:P.jsx("canvas",{ref:o,className:"game-canvas"})})},Lt=["red","yellow","blue","green","purple","orange"],jt={red:{light:"#e74c3c",dark:"#c0392b"},yellow:{light:"#f1c40f",dark:"#f39c12"},blue:{light:"#3498db",dark:"#2980b9"},green:{light:"#2ecc71",dark:"#27ae60"},purple:{light:"#9b59b6",dark:"#8e44ad"},orange:{light:"#e67e22",dark:"#d35400"}};class lo{constructor(e,n){Rt(this,"ctx");Rt(this,"cellSize");this.ctx=e,this.cellSize=n}render(e,n=1){this.ctx.save();const o=e.x+this.cellSize/2,s=e.y+this.cellSize/2;switch(this.ctx.translate(o,s),this.ctx.scale(e.scale||1,e.scale||1),this.ctx.rotate(e.rotation||0),this.ctx.globalAlpha=n,e.type){case"normal":this.renderNormalGem(e);break;case"striped":this.renderStripedGem(e);break;case"wrapped":this.renderWrappedGem(e);break;case"colorBomb":this.renderColorBomb(e);break}this.ctx.restore()}renderNormalGem(e){const n=jt[e.color],o=this.cellSize*.85,s=-o/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.roundRect(s+2,s+2,o,o,o*.2),this.ctx.fill();const a=this.ctx.createLinearGradient(s,s,s+o,s+o);a.addColorStop(0,n.light),a.addColorStop(1,n.dark),this.ctx.fillStyle=a,this.roundRect(s,s,o,o,o*.2),this.ctx.fill(),this.renderColorPattern(e.color,s,o),this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.roundRect(s,s,o,o*.4,o*.2),this.ctx.fill(),this.ctx.strokeStyle=this.getBorderColor(e.color),this.ctx.lineWidth=o*.06,this.roundRect(s,s,o,o,o*.2),this.ctx.stroke()}getBorderColor(e){return{red:"rgba(231, 76, 60, 0.9)",yellow:"rgba(241, 196, 15, 0.9)",blue:"rgba(52, 152, 219, 0.9)",green:"rgba(46, 204, 113, 0.9)",purple:"rgba(155, 89, 182, 0.9)",orange:"rgba(230, 126, 34, 0.9)"}[e]}renderColorPattern(e,n,o){switch(this.ctx.save(),this.ctx.globalAlpha=.5,e){case"red":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.18,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="rgba(192, 57, 43, 0.5)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.1,0,Math.PI*2),this.ctx.fill();break;case"yellow":this.ctx.fillStyle="rgba(255, 255, 255, 0.7)",this.drawStar(0,0,o*.1,o*.18,5),this.ctx.fill();break;case"blue":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.moveTo(0,-o*.18),this.ctx.lineTo(o*.18,0),this.ctx.lineTo(0,o*.18),this.ctx.lineTo(-o*.18,0),this.ctx.closePath(),this.ctx.fill();break;case"green":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.moveTo(0,-o*.18),this.ctx.lineTo(-o*.15,o*.12),this.ctx.lineTo(o*.15,o*.12),this.ctx.closePath(),this.ctx.fill();break;case"purple":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.fillRect(-o*.12,-o*.12,o*.24,o*.24);break;case"orange":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath();for(let s=0;s<6;s++){const a=Math.PI/3*s,l=Math.cos(a)*o*.15,f=Math.sin(a)*o*.15;s===0?this.ctx.moveTo(l,f):this.ctx.lineTo(l,f)}this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle="rgba(211, 84, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.08,0,Math.PI*2),this.ctx.fill();break}this.ctx.restore()}renderStripedGem(e){const n=jt[e.color],o=this.cellSize*.85,s=-o/2,a=this.ctx.createLinearGradient(s,s,s+o,s+o);if(a.addColorStop(0,n.light),a.addColorStop(1,n.dark),this.ctx.fillStyle=a,this.roundRect(s,s,o,o,o*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.6)",this.ctx.lineWidth=o*.1,this.ctx.lineCap="round",e.stripedDirection==="horizontal")for(let l=0;l<3;l++){const f=s+o/4*(l+1);this.ctx.beginPath(),this.ctx.moveTo(s,f),this.ctx.lineTo(s+o,f),this.ctx.stroke()}else for(let l=0;l<3;l++){const f=s+o/4*(l+1);this.ctx.beginPath(),this.ctx.moveTo(f,s),this.ctx.lineTo(f,s+o),this.ctx.stroke()}}renderWrappedGem(e){const n=jt[e.color],o=this.cellSize*.85,s=-o/2,a=this.ctx.createLinearGradient(s,s,s+o,s+o);a.addColorStop(0,n.light),a.addColorStop(1,n.dark),this.ctx.fillStyle=a,this.roundRect(s,s,o,o,o*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=o*.08,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(s,s),this.ctx.lineTo(s+o,s+o),this.ctx.moveTo(s+o,s),this.ctx.lineTo(s,s+o),this.ctx.stroke()}renderColorBomb(e){const n=this.cellSize*.85,o=-n/2,s=this.ctx.createLinearGradient(o,o,o+n,o+n);s.addColorStop(0,"#ff6b6b"),s.addColorStop(.2,"#ffd93d"),s.addColorStop(.4,"#4ecdc4"),s.addColorStop(.6,"#95e1d3"),s.addColorStop(.8,"#a29bfe"),s.addColorStop(1,"#fd79a8"),this.ctx.fillStyle=s,this.roundRect(o,o,n,n,n*.2),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 255, 255, 0.9)",this.drawStar(0,0,n*.3,n*.6,5),this.ctx.fill()}roundRect(e,n,o,s,a){this.ctx.beginPath(),this.ctx.moveTo(e+a,n),this.ctx.lineTo(e+o-a,n),this.ctx.quadraticCurveTo(e+o,n,e+o,n+a),this.ctx.lineTo(e+o,n+s-a),this.ctx.quadraticCurveTo(e+o,n+s,e+o-a,n+s),this.ctx.lineTo(e+a,n+s),this.ctx.quadraticCurveTo(e,n+s,e,n+s-a),this.ctx.lineTo(e,n+a),this.ctx.quadraticCurveTo(e,n,e+a,n),this.ctx.closePath()}drawStar(e,n,o,s,a){this.ctx.beginPath();for(let l=0;l<a*2;l++){const f=Math.PI*l/a,i=l%2===0?s:o,c=e+Math.cos(f)*i,h=n+Math.sin(f)*i;l===0?this.ctx.moveTo(c,h):this.ctx.lineTo(c,h)}this.ctx.closePath()}}const ie={rows:9,cols:9};function Gt(r){var o,s;const e=[],n=new Set;for(let a=0;a<r.length;a++){let l=1,f=(o=r[a][0])==null?void 0:o.color,i=0;for(let c=1;c<=r[a].length;c++){const h=r[a][c];if(h&&h.color===f&&f)l++;else{if(l>=3&&f){const b=[];for(let y=0;y<l;y++){const g={row:a,col:i+y},T=`${g.row},${g.col}`;n.has(T)||(b.push(g),n.add(T))}b.length>0&&e.push({type:"horizontal",positions:b})}h?(l=1,f=h.color,i=c):(l=0,f=void 0)}}}if(r.length>0)for(let a=0;a<r[0].length;a++){let l=1,f=(s=r[0][a])==null?void 0:s.color,i=0;for(let c=1;c<=r.length;c++){const h=c<r.length?r[c][a]:null;if(h&&h.color===f&&f)l++;else{if(l>=3&&f){const b=[];for(let y=0;y<l;y++){const g={row:i+y,col:a},T=`${g.row},${g.col}`;n.has(T)||(b.push(g),n.add(T))}b.length>0&&e.push({type:"vertical",positions:b})}h?(l=1,f=h.color,i=c):(l=0,f=void 0)}}}return e}class co{constructor(e){Rt(this,"seed");this.seed=e}next(){return this.seed=(this.seed*9301+49297)%233280,this.seed/233280}}function le(r){const e=new co(r),n=uo(r),o=fo(r),s=ho(r),a=po(n.rows,n.cols,e);return{stageNumber:r,gridSize:n,targetScore:o,maxMoves:s,goals:[{type:"score",target:o,current:0}],initialBoard:a}}function uo(r){return r<=100?{rows:9,cols:9}:r<=300?{rows:8,cols:8}:r<=600?{rows:7,cols:7}:{rows:6,cols:6}}function fo(r){const o=Math.floor(r/100)*500;return 1e3+r*50+o}function ho(r){const n=Math.floor(r/20),o=20;return r>500?Math.max(o,50-n-Math.floor((r-500)/10)):Math.max(o,50-n)}function po(r,e,n){const o=[];for(let s=0;s<r;s++){o[s]=[];for(let a=0;a<e;a++){const l=Lt[Math.floor(n.next()*Lt.length)];o[s][a]={id:`${s}-${a}-${Date.now()}`,color:l,type:"normal",position:{row:s,col:a},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}}return go(o,n)}function go(r,e){var a,l,f,i,c;let o=0;const s=e?()=>e.next():()=>Math.random();try{for(;o<100;){const h=Gt(r);if(h.length===0)return r;for(const b of h)for(const y of b.positions){const g=(a=r[y.row])==null?void 0:a[y.col];if(g){const T=Lt.indexOf(g.color),Y=Lt.filter((V,z)=>z!==T);if(Y.length===0)continue;let I=g.color,W=0;for(;W<10&&I===g.color;){const V=Math.floor(s()*Y.length),z=Y[V];[(l=r[y.row-1])==null?void 0:l[y.col],(f=r[y.row+1])==null?void 0:f[y.col],(i=r[y.row])==null?void 0:i[y.col-1],(c=r[y.row])==null?void 0:c[y.col+1]].filter(Boolean).some(ct=>(ct==null?void 0:ct.color)===z)?W++:I=z}I===g.color&&Y.length>0&&(I=Y[0]),g.color=I}}o++}}catch(h){console.error("Error in ensureNoInitialMatches:",h)}return r}function ce(r,e=50){var a;const n=r.map(l=>[...l]),o=n.length,s=((a=n[0])==null?void 0:a.length)||0;for(let l=0;l<s;l++){let f=o-1;for(let i=o-1;i>=0;i--)if(n[i][l]!==null){if(f!==i){const c=n[i][l];n[f][l]=c,(c.y===void 0||c.y===0)&&(c.y=i*e),c.targetY=f,c.position.row=f,n[i][l]=null}f--}for(let i=f;i>=0;i--){const c=mo(i,l);c.y=-e*(f-i+1),c.targetY=i,n[i][l]=c}}return n}function mo(r,e){const n=Lt[Math.floor(Math.random()*Lt.length)];return{id:`${Date.now()}-${r}-${e}-${Math.random()}`,color:n,type:"normal",position:{row:r,col:e},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}function yo(r){const e=[];for(const n of r){const o=n.positions.length;if(o===4){const s=Math.floor(o/2),a=n.positions[s];e.push({position:a,type:"striped",stripedDirection:n.type==="horizontal"?"horizontal":"vertical"})}else if(o>=5){const s=Math.floor(o/2),a=n.positions[s];e.push({position:a,type:"colorBomb"})}}return e}function So(r){const e=[],n=r.filter(s=>s.type==="horizontal"),o=r.filter(s=>s.type==="vertical");for(const s of n)for(const a of o){const l=s.positions.find(f=>a.positions.some(i=>f.row===i.row&&f.col===i.col));l&&e.push({position:l,type:"wrapped"})}return e}function bo(r){const e=So(r),n=r.filter(a=>!e.some(l=>{var f,i;return l.position.row===((f=a.positions[0])==null?void 0:f.row)&&l.position.col===((i=a.positions[0])==null?void 0:i.col)})),o=[];o.push(...e);const s=yo(n);for(const a of s)e.some(f=>f.position.row===a.position.row&&f.position.col===a.position.col)||o.push(a);return o}function wo(r,e,n){var l,f,i;const o=[],{row:s,col:a}=r.position;if(n==="horizontal")for(let c=0;c<((l=e[0])==null?void 0:l.length);c++)(f=e[s])!=null&&f[c]&&o.push({row:s,col:c});else for(let c=0;c<e.length;c++)(i=e[c])!=null&&i[a]&&o.push({row:c,col:a});return{positionsToRemove:o,score:o.length*20}}function vo(r,e){var a,l;const n=[],{row:o,col:s}=r.position;for(let f=o-1;f<=o+1;f++)for(let i=s-1;i<=s+1;i++)f>=0&&f<e.length&&i>=0&&i<(((a=e[0])==null?void 0:a.length)||0)&&((l=e[f])!=null&&l[i])&&n.push({row:f,col:i});return{positionsToRemove:n,score:n.length*30}}function Co(r,e){var s,a;const n=[],o=r.color;for(let l=0;l<e.length;l++)for(let f=0;f<(((s=e[l])==null?void 0:s.length)||0);f++){const i=(a=e[l])==null?void 0:a[f];i&&i.color===o&&n.push({row:l,col:f})}return{positionsToRemove:n,score:n.length*50}}function Ro(r,e,n){var f,i,c;const o=[],{row:s,col:a}=r.position;for(let h=0;h<((f=n[0])==null?void 0:f.length);h++)(i=n[s])!=null&&i[h]&&o.push({row:s,col:h});for(let h=0;h<n.length;h++)(c=n[h])!=null&&c[a]&&o.push({row:h,col:a});const l=Array.from(new Set(o.map(h=>`${h.row},${h.col}`))).map(h=>{const[b,y]=h.split(",").map(Number);return{row:b,col:y}});return{positionsToRemove:l,score:l.length*30}}function Mo(r,e,n){var c,h,b,y;const o=[],s=r.type==="striped"?r:e,a=r.type==="wrapped"?r:e,l=s.stripedDirection||"horizontal",{row:f,col:i}=a.position;if(l==="horizontal"){for(let g=f-1;g<=f+1;g++)if(g>=0&&g<n.length)for(let T=0;T<((c=n[0])==null?void 0:c.length);T++)(h=n[g])!=null&&h[T]&&o.push({row:g,col:T})}else for(let g=i-1;g<=i+1;g++)if(g>=0&&g<(((b=n[0])==null?void 0:b.length)||0))for(let T=0;T<n.length;T++)(y=n[T])!=null&&y[g]&&o.push({row:T,col:g});return{positionsToRemove:o,score:o.length*40}}function To(r,e,n){var f,i,c,h;const o=[],s=r.type==="striped"?r:e,a=s.color;if((s.stripedDirection||"horizontal")==="horizontal")for(let b=0;b<n.length;b++)for(let y=0;y<(((f=n[b])==null?void 0:f.length)||0);y++){const g=(i=n[b])==null?void 0:i[y];g&&g.color===a&&o.push({row:b,col:y})}else for(let b=0;b<(((c=n[0])==null?void 0:c.length)||0);b++)for(let y=0;y<n.length;y++){const g=(h=n[y])==null?void 0:h[b];g&&g.color===a&&o.push({row:y,col:b})}return{positionsToRemove:o,score:o.length*60}}function ko(r,e,n){var l,f;const o=[],{row:s,col:a}=r.position;for(let i=s-2;i<=s+2;i++)for(let c=a-2;c<=a+2;c++)i>=0&&i<n.length&&c>=0&&c<(((l=n[0])==null?void 0:l.length)||0)&&((f=n[i])!=null&&f[c])&&o.push({row:i,col:c});return{positionsToRemove:o,score:o.length*50}}function Po(r,e,n){var l,f;const o=[],a=(r.type==="wrapped"?r:e).color;for(let i=0;i<n.length;i++)for(let c=0;c<(((l=n[i])==null?void 0:l.length)||0);c++){const h=(f=n[i])==null?void 0:f[c];h&&h.color===a&&o.push({row:i,col:c})}return{positionsToRemove:o,score:o.length*70}}function Go(r,e,n){var s,a;const o=[];for(let l=0;l<n.length;l++)for(let f=0;f<(((s=n[l])==null?void 0:s.length)||0);f++)(a=n[l])!=null&&a[f]&&o.push({row:l,col:f});return{positionsToRemove:o,score:o.length*100}}function Oo(r,e,n){switch([r.type,e.type].sort().join("+")){case"striped+striped":return Ro(r,e,n);case"striped+wrapped":return Mo(r,e,n);case"colorBomb+striped":return To(r,e,n);case"wrapped+wrapped":return ko(r,e,n);case"colorBomb+wrapped":return Po(r,e,n);case"colorBomb+colorBomb":return Go(r,e,n);default:return null}}function Ao(r,e){switch(r.type){case"striped":return wo(r,e,r.stripedDirection||"horizontal");case"wrapped":return vo(r,e);case"colorBomb":return Co(r,e);default:return{positionsToRemove:[],score:0}}}const Eo=r=>{const[e,n]=S.useState(()=>{const i=le(r);return{board:i.initialBoard||[],score:0,moves:i.maxMoves,goals:i.goals,isGameOver:!1,isPaused:!1,currentStage:r,isAnimating:!1,selectedGem:null,comboCount:0}});S.useEffect(()=>{const i=le(r);n({board:i.initialBoard||[],score:0,moves:i.maxMoves,goals:i.goals,isGameOver:!1,isPaused:!1,currentStage:r,isAnimating:!1,selectedGem:null,comboCount:0})},[r]);const o=S.useRef(null),s=S.useCallback((i,c)=>{n(h=>{var y,g;if(h.isGameOver)return h;const b=((y=h.selectedGem)==null?void 0:y.row)===i&&((g=h.selectedGem)==null?void 0:g.col)===c?null:{row:i,col:c};return o.current=b,{...h,selectedGem:b}})},[]),a=S.useCallback((i,c)=>{n(h=>{var z;if(h.isGameOver||h.moves<=0)return h;const b=Math.abs(i.row-c.row),y=Math.abs(i.col-c.col);if(!(b===1&&y===0||b===0&&y===1))return h;const g=h.board.map(O=>O.map(D=>D?{...D}:null)),T=g[i.row][i.col],Y=g[c.row][c.col];if(T&&Y&&T.type!=="normal"&&Y.type!=="normal"){const O=Oo(T,Y,g);if(O){const D=new Set;for(const A of O.positionsToRemove)D.add(`${A.row},${A.col}`);for(const A of D){const[j,rt]=A.split(","),d=Number(j),yt=Number(rt);!Number.isNaN(d)&&!Number.isNaN(yt)&&g[d]&&(g[d][yt]=null)}const ct=ce(g,50),Ot=h.score+O.score,Tt=h.goals.map(A=>A.type==="score"?{...A,current:Math.min(A.current+O.score,A.target)}:A),vt=Gt(ct).length>0,dt=Tt.every(A=>A.current>=A.target),Ct=h.moves<=0&&!dt;return{...h,board:ct,score:Ot,goals:Tt,moves:h.moves-1,isAnimating:vt&&!dt&&!Ct,selectedGem:null,comboCount:0,isGameOver:Ct||h.isGameOver}}}const I=g[i.row][i.col];g[i.row][i.col]=g[c.row][c.col],g[c.row][c.col]=I,g[i.row][i.col]&&(g[i.row][i.col].position={...i}),g[c.row][c.col]&&(g[c.row][c.col].position={...c});const W=Gt(g);if(W.length===0)return h;const V=bo(W);for(const O of V){const D=(z=g[O.position.row])==null?void 0:z[O.position.col];D&&(D.type=O.type,O.stripedDirection&&(D.stripedDirection=O.stripedDirection))}return{...h,board:g,moves:h.moves-1,isAnimating:!0,selectedGem:null,comboCount:0}})},[]),l=S.useCallback(()=>{n(i=>{var dt,Ct;if(!i.isAnimating)return i;const c=Gt(i.board);if(c.length===0)return{...i,isAnimating:!1};const h=i.board.map(A=>A.map(j=>j?{...j}:null)),b=new Set;let y=0;const g=new Set;for(const A of c)for(const j of A.positions){const rt=(dt=h[j.row])==null?void 0:dt[j.col];rt&&rt.type!=="normal"&&g.add(`${j.row},${j.col}`)}for(const A of g){const[j,rt]=A.split(","),d=Number(j),yt=Number(rt);if(!Number.isNaN(d)&&!Number.isNaN(yt)&&((Ct=h[d])!=null&&Ct[yt])){const Et=h[d][yt],Bt=Ao(Et,h);for(const xt of Bt.positionsToRemove)b.add(`${xt.row},${xt.col}`);y+=Bt.score}}for(const A of c)for(const j of A.positions)b.add(`${j.row},${j.col}`);for(const A of b){const[j,rt]=A.split(","),d=Number(j),yt=Number(rt);!Number.isNaN(d)&&!Number.isNaN(yt)&&h[d]&&(h[d][yt]=null)}const T=ce(h,50),I=Gt(T).length>0,W=I?i.comboCount+1:0,V=1+Math.min(W,5)*.15,z=c.reduce((A,j)=>{const rt=j.positions.length;let d=10;return rt>=6?d=80:rt>=5?d=40:rt>=4&&(d=20),A+rt*d},0),O=z+y,D=Math.floor(O*(V-1)),ct=i.score+O+D,Ot=z+y+D,Tt=i.goals.map(A=>A.type==="score"?{...A,current:Math.min(A.current+Ot,A.target)}:A),mt=Tt.every(A=>A.current>=A.target),vt=i.moves<=0&&!mt;return{...i,board:T,score:ct,goals:Tt,isGameOver:vt||i.isGameOver,isAnimating:I&&!mt&&!vt,comboCount:W}})},[]),f=S.useCallback(()=>{n(i=>({...i,isPaused:!i.isPaused}))},[]);return{gameState:e,selectGem:s,swapGems:a,processMatches:l,togglePause:f}};function ue(r){const{score:e,goals:n,moves:o,currentStage:s}=r;if(n.length===0)return 0;const a=n[0];if(a.current<a.target)return 0;const l=a.current/a.target,f=Math.max(20,50-Math.floor(s/20)),i=o/f,c=Math.min(e/(a.target*1.5),1);let h=0;return l>=1&&(h=1,(l>=1.2||i>=.4)&&(h=2),l>=1.5&&i>=.5&&c>=.8&&(h=3)),Math.min(h,3)}class Bo{constructor(e){Rt(this,"particles",[]);Rt(this,"ctx");this.ctx=e}emit(e,n,o,s=20){const a=jt[o];for(let l=0;l<s;l++){const f=Math.PI*2*l/s+Math.random()*.5,i=2+Math.random()*3;this.particles.push({x:e,y:n,vx:Math.cos(f)*i,vy:Math.sin(f)*i,life:1,maxLife:1,color:Math.random()>.5?a.light:a.dark,size:3+Math.random()*4,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}emitExplosion(e,n,o,s=50,a=30){const l=jt[o];for(let f=0;f<a;f++){const i=Math.random()*Math.PI*2,c=Math.random()*s,h=1+Math.random()*2;this.particles.push({x:e+Math.cos(i)*c*.3,y:n+Math.sin(i)*c*.3,vx:Math.cos(i)*h,vy:Math.sin(i)*h,life:1,maxLife:1,color:Math.random()>.5?l.light:l.dark,size:4+Math.random()*6,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.3})}}update(e=16){for(let n=this.particles.length-1;n>=0;n--){const o=this.particles[n];o.x+=o.vx,o.y+=o.vy,o.vy+=.1,o.vx*=.98,o.vy*=.98,o.rotation+=o.rotationSpeed,o.life-=e/1e3,o.life<=0&&this.particles.splice(n,1)}}render(){this.ctx.save();for(const e of this.particles){const n=e.life/e.maxLife,o=e.size*n;this.ctx.globalAlpha=n,this.ctx.fillStyle=e.color,this.ctx.translate(e.x,e.y),this.ctx.rotate(e.rotation),this.ctx.fillRect(-o/2,-o/2,o,o),this.ctx.setTransform(1,0,0,1,0,0)}this.ctx.globalAlpha=1,this.ctx.restore()}clear(){this.particles=[]}get count(){return this.particles.length}}function fe(r){var a,l,f,i;const e=r.length,n=((a=r[0])==null?void 0:a.length)||0,o=[],s=[];for(let c=0;c<e;c++)for(let h=0;h<n;h++){const b=(l=r[c])==null?void 0:l[h];if(b){if(h<n-1){const y=(f=r[c])==null?void 0:f[h+1];if(y&&y.color!==b.color){const g=he(r,c,h,c,h+1),T=Gt(g);if(T.length>0){const Y=T.some(W=>W.positions.length>=4),I={from:{row:c,col:h},to:{row:c,col:h+1}};Y?o.push(I):s.push(I)}}}if(c<e-1){const y=(i=r[c+1])==null?void 0:i[h];if(y&&y.color!==b.color){const g=he(r,c,h,c+1,h),T=Gt(g);if(T.length>0){const Y=T.some(W=>W.positions.length>=4),I={from:{row:c,col:h},to:{row:c+1,col:h}};Y?o.push(I):s.push(I)}}}}}return o.length>0?o[0]:s.length>0?s[0]:null}function he(r,e,n,o,s){const a=r.map(f=>f.map(i=>i?{...i}:null)),l=a[e][n];return a[e][n]=a[o][s],a[o][s]=l,a}const xo=({stageNumber:r=1,currentScreen:e="stageSelect",onNavigate:n,onStartStage:o})=>{const s=S.useRef(!1),a=S.useRef(null),l=S.useRef(null),f=S.useRef(null),i=S.useRef(null),c=S.useRef(null),h=S.useRef(null),b=S.useRef(new Map),y=S.useRef(null),g=S.useRef(!1),T=S.useRef(null),Y=S.useRef(""),I=S.useRef(!1),W=S.useRef(null),V=S.useRef(null),z=S.useRef(null),O=S.useRef(null),D=S.useRef(!1),ct=S.useRef(!1),Ot=S.useRef(!1),Tt=S.useRef(!1),[mt,vt]=S.useState(!1),{t:dt}=Wt(),[Ct,A]=S.useState(1),[j,rt]=S.useState(1),{gameState:d,selectGem:yt,swapGems:Et,processMatches:Bt,togglePause:xt}=Eo(r),[st,ve]=S.useState(()=>{const m=ie.cols,G=ie.rows;return{aspectRatio:we.aspectRatio,cellSize:50,gridRows:G,gridCols:m,pixelRatio:window.devicePixelRatio||1,logicalWidth:0,logicalHeight:0}});S.useEffect(()=>{var t;if(e==="game"&&d.board.length>0){const m=d.board.length,G=((t=d.board[0])==null?void 0:t.length)||9;ve(M=>({...M,gridRows:m,gridCols:G}))}},[e,d.board,r]),S.useEffect(()=>{const t=localStorage.getItem("chipPuzzleGame_progress");if(t)try{const m=JSON.parse(t);A(Math.max(1,m.highestStage||1))}catch(m){console.error("Failed to load progress",m)}},[]);const Qt=S.useCallback((t,m,G)=>{const u=m/1200;t.fillStyle="#1a1a1a",t.fillRect(0,0,m,G),t.fillStyle="#fff";const nt=Math.max(16,32*u);t.font=`bold ${nt}px Arial`,t.textAlign="center",t.fillText(dt("stageSelect.title"),m/2,50*u);const w=8,ut=60,Mt=15,R=ut*u,pt=Mt*u,q=(m-(w*R+(w-1)*pt))/2,U=100*u,K=1e3,tt=50,at=Math.ceil(K/tt),et=(j-1)*tt+1,X=Math.min(et+tt-1,K);for(let v=0;v<tt&&et+v<=X;v++){const B=et+v,F=Math.floor(v/w),$=v%w,p=q+$*(R+pt),_=U+F*(R+pt),k=B<=Ct;if(k){const E=t.createLinearGradient(p,_,p+R,_+R);E.addColorStop(0,"#667eea"),E.addColorStop(1,"#764ba2"),t.fillStyle=E}else t.fillStyle="#1a1a1a";t.fillRect(p,_,R,R),t.strokeStyle=k?"#667eea":"#444",t.lineWidth=Math.max(1,2*u),t.strokeRect(p,_,R,R),t.fillStyle="#fff";const N=Math.max(12,20*u);if(t.font=`bold ${N}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText(B.toString(),p+R/2,_+R/2),!k){t.fillStyle="#ffa500";const E=Math.max(16,24*u);t.font=`${E}px Arial`,t.fillText("ðŸ”’",p+R/2,_+R/2-10*u)}}const it=G-60*u;t.fillStyle="#fff",t.font=`bold ${Math.max(12,18*u)}px Arial`,t.textAlign="center",t.fillText(`${dt("stageSelect.page")} ${j} / ${at}`,m/2,it);const J=30*u,ft=80*u,ht=it+20*u,kt=10*u;if(j>1){const v=m/2-ft-kt/2;t.fillStyle=j>1?"#667eea":"#444",t.fillRect(v,ht,ft,J),t.strokeStyle="#fff",t.lineWidth=Math.max(1,2*u),t.strokeRect(v,ht,ft,J),t.fillStyle="#fff",t.font=`bold ${Math.max(10,14*u)}px Arial`,t.fillText("Â«",v+ft/2,ht+J/2+4*u)}if(j<at){const v=m/2+kt/2;t.fillStyle=j<at?"#667eea":"#444",t.fillRect(v,ht,ft,J),t.strokeStyle="#fff",t.lineWidth=Math.max(1,2*u),t.strokeRect(v,ht,ft,J),t.fillStyle="#fff",t.font=`bold ${Math.max(10,14*u)}px Arial`,t.fillText("Â»",v+ft/2,ht+J/2+4*u)}},[Ct,dt,j]),te=S.useCallback((t,m,G)=>{const u=m/1200;t.fillStyle="#1a1a1a",t.fillRect(0,0,m,G);const w=(st.cellSize||50)*u,ut=st.gridCols||9,Mt=st.gridRows||9,R=w*ut,pt=w*Mt,q=(m-R)/2,U=(G-pt)/2;(!f.current||i.current!==w)&&(f.current=new lo(t,w),i.current=w),c.current||(c.current=new Bo(t)),t.save(),t.globalAlpha=.9,t.fillStyle="rgba(22, 22, 46, 0.8)",t.beginPath(),t.roundRect(q,U,R,pt,8*u),t.fill(),t.restore(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=Math.max(.5,1*u);for(let v=0;v<=Mt;v++){const B=U+v*w;t.beginPath(),t.moveTo(q,B),t.lineTo(q+R,B),t.stroke()}for(let v=0;v<=ut;v++){const B=q+v*w;t.beginPath(),t.moveTo(B,U),t.lineTo(B,U+pt),t.stroke()}const K=Math.max(10,20*u),tt=24*u,at=24*u,et=K+8*u,X=at,it=16*u,J=16*u,ft=280*u,ht=et*4+it*2;if(t.save(),t.globalAlpha=.9,t.fillStyle="rgba(15, 15, 30, 0.8)",t.beginPath(),t.roundRect(tt-it,at-it,ft,ht,J),t.fill(),t.strokeStyle="rgba(102, 126, 234, 0.3)",t.lineWidth=1*u,t.stroke(),t.restore(),t.textAlign="left",t.textBaseline="top",t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=4*u,t.shadowOffsetX=0,t.shadowOffsetY=2*u,t.font=`600 ${K}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillStyle="#ffffff",t.fillText(`Score: ${d.score.toLocaleString()}`,tt,X),t.fillStyle="rgba(255, 255, 255, 0.9)",t.fillText(`Moves: ${d.moves}`,tt,X+et),d.goals.length>0){const v=d.goals[0],B=v.current/v.target;t.fillStyle=B>=1?"#4ecdc4":"rgba(255, 255, 255, 0.9)",t.fillText(`Goal: ${v.current.toLocaleString()}/${v.target.toLocaleString()}`,tt,X+et*2)}if(d.comboCount>0&&(t.shadowColor="rgba(255, 217, 61, 0.6)",t.shadowBlur=12*u,t.font=`700 ${Math.max(14,24*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillStyle="#ffd93d",t.textAlign="left",t.fillText(`Combo x${d.comboCount}!`,tt,X+et*3),t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=4*u),t.shadowColor="transparent",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,!d.isGameOver&&!d.isAnimating){const F=20*u,$=10*u,p=Math.max(60,120*u),_=Math.max(24,40*u),k=Math.max(60,120*u),N=Math.max(24,40*u),E=m-p-F,H=F,C=12*u,x=t.createLinearGradient(E,H,E,H+_);x.addColorStop(0,mt?"#4ecdc4":"#667eea"),x.addColorStop(1,mt?"#44a08d":"#764ba2"),t.save(),t.beginPath(),t.roundRect(E,H,p,_,C),t.fillStyle=x,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=Math.max(1,1.5*u),t.stroke(),t.restore(),t.shadowColor=mt?"rgba(78, 205, 196, 0.4)":"rgba(102, 126, 234, 0.4)",t.shadowBlur=8*u,t.shadowOffsetX=0,t.shadowOffsetY=2*u,t.fillStyle="#ffffff";const ot=Math.max(10,16*u);t.font=`600 ${ot}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Hint",E+p/2,H+_/2),t.shadowColor="transparent",t.shadowBlur=0;const lt=E-k-$,St=F,Q=t.createLinearGradient(lt,St,lt,St+N);d.isPaused?(Q.addColorStop(0,"#ff6b6b"),Q.addColorStop(1,"#ee5a6f")):(Q.addColorStop(0,"#667eea"),Q.addColorStop(1,"#764ba2")),t.save(),t.beginPath(),t.roundRect(lt,St,k,N,C),t.fillStyle=Q,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=Math.max(1,1.5*u),t.stroke(),t.restore(),t.shadowColor=d.isPaused?"rgba(255, 107, 107, 0.4)":"rgba(102, 126, 234, 0.4)",t.shadowBlur=8*u,t.shadowOffsetX=0,t.shadowOffsetY=2*u,t.fillStyle="#ffffff";const bt=Math.max(10,16*u);t.font=`600 ${bt}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(d.isPaused?dt("game.resume"):dt("game.pause"),lt+k/2,St+N/2),t.shadowColor="transparent",t.shadowBlur=0}if(d.isPaused&&!d.isGameOver){t.fillStyle="rgba(15, 15, 30, 0.85)",t.fillRect(0,0,m,G);const v=400*u,B=200*u,F=(m-v)/2,$=(G-B)/2,p=24*u;t.save(),t.globalAlpha=.95,t.fillStyle="rgba(26, 26, 46, 0.9)",t.beginPath(),t.roundRect(F,$,v,B,p),t.fill(),t.strokeStyle="rgba(102, 126, 234, 0.3)",t.lineWidth=2*u,t.stroke(),t.restore(),t.shadowColor="rgba(102, 126, 234, 0.5)",t.shadowBlur=12*u,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillStyle="#ffffff",t.font=`700 ${Math.max(28,56*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(dt("game.pause"),m/2,$+B/2-30*u),t.shadowColor="transparent",t.shadowBlur=0,t.fillStyle="rgba(255, 255, 255, 0.7)",t.font=`500 ${Math.max(14,20*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillText(dt("game.resume"),m/2,$+B/2+20*u)}if(d.isGameOver){t.fillStyle="rgba(15, 15, 30, 0.9)",t.fillRect(0,0,m,G);const v=450*u,B=300*u,F=(m-v)/2,$=(G-B)/2,p=24*u;t.save(),t.globalAlpha=.95,t.fillStyle="rgba(26, 26, 46, 0.9)",t.beginPath(),t.roundRect(F,$,v,B,p),t.fill(),t.strokeStyle="rgba(255, 107, 107, 0.3)",t.lineWidth=2*u,t.stroke(),t.restore(),t.shadowColor="rgba(255, 107, 107, 0.5)",t.shadowBlur=12*u,t.fillStyle="#ff6b6b",t.font=`700 ${Math.max(28,56*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Game Over!",m/2,$+60*u),t.shadowColor="transparent",t.shadowBlur=0,t.fillStyle="rgba(255, 255, 255, 0.9)",t.font=`600 ${Math.max(16,24*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillText(`Final Score: ${d.score.toLocaleString()}`,m/2,$+120*u);const _=m/2-110*u,k=$+180*u,N=220*u,E=56*u,H=14*u,C=t.createLinearGradient(_,k,_,k+E);C.addColorStop(0,"#ff6b6b"),C.addColorStop(1,"#ee5a6f"),t.save(),t.beginPath(),t.roundRect(_,k,N,E,H),t.fillStyle=C,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2*u,t.stroke(),t.restore(),t.shadowColor="rgba(255, 107, 107, 0.4)",t.shadowBlur=8*u,t.shadowOffsetX=0,t.shadowOffsetY=2*u,t.fillStyle="#ffffff",t.font=`600 ${Math.max(16,22*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Retry",m/2,k+E/2),t.shadowColor="transparent",t.shadowBlur=0}const kt=d.goals.every(v=>v.current>=v.target);if(d.isAnimating){const v=Gt(d.board),B=new Set;for(const F of v)for(const $ of F.positions)B.add(`${$.row},${$.col}`);B.forEach(F=>{const[$,p]=F.split(","),_=Number($),k=Number(p);if(!Number.isNaN(_)&&!Number.isNaN(k)&&_>=0&&_<Mt&&k>=0&&k<ut){const N=q+k*w,E=U+_*w,H=Date.now()%1e3,C=.3+Math.sin(H/1e3*Math.PI*2)*.2;t.fillStyle=`rgba(255, 215, 61, ${C})`,t.strokeStyle="#ffd93d",t.lineWidth=Math.max(2,3*u),t.strokeRect(N,E,w,w),t.fillRect(N,E,w,w)}})}if(d.board&&d.board.length>0&&f.current){let v=!1;d.board.forEach((F,$)=>{F&&F.forEach((p,_)=>{if(p){const k=q+_*w,N=U+$*w;if(D.current&&W.current&&z.current&&V.current){const C=W.current,x=z.current,ot=V.current;if($===C.row&&_===C.col)if(O.current){const lt=O.current.x-ot.x,St=O.current.y-ot.y,Q=w,bt=Math.max(-Q,Math.min(Q,lt)),_t=Math.max(-Q,Math.min(Q,St));p.x=k+bt,p.y=N+_t}else p.x=k,p.y=N;else if($===x.row&&_===x.col)if(O.current){const lt=O.current.x-ot.x,St=O.current.y-ot.y,Q=w,bt=Math.max(-Q,Math.min(Q,-lt)),_t=Math.max(-Q,Math.min(Q,-St));p.x=k+bt,p.y=N+_t}else p.x=k,p.y=N;else p.x=k,p.y=N}else if(p.targetY!==void 0){v=!0;let C;p.targetY<100?C=U+p.targetY*w:C=p.targetY,(p.y===void 0||p.y===0)&&(p.y=N);const x=C-p.y,ot=.15;Math.abs(x)>1?(p.y+=x*ot,x>0&&(p.y+=1)):(p.y=C,p.targetY=void 0),p.x=k}else if(p.targetX!==void 0){const C=p.targetX-p.x,x=.2;Math.abs(C)>.1?p.x+=C*x:(p.x=p.targetX,p.targetX=void 0),p.y=N}else(p.x===0&&p.y===0&&p.targetX===void 0&&p.targetY===void 0||p.x!==k||p.y!==N)&&(p.x=k,p.y=N);d.selectedGem&&d.selectedGem.row===$&&d.selectedGem.col===_&&(t.fillStyle="rgba(255, 255, 255, 0.3)",t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=Math.max(2,3*u),t.strokeRect(k,N,w,w),t.fillRect(k,N,w,w)),mt&&y.current&&(y.current.from.row===$&&y.current.from.col===_||y.current.to.row===$&&y.current.to.col===_)&&(t.fillStyle="rgba(255, 215, 61, 0.4)",t.strokeStyle="#ffd93d",t.lineWidth=Math.max(3,4*u),t.strokeRect(k,N,w,w),t.fillRect(k,N,w,w));let E=1,H=p.scale||1;if(p.isRemoving){let C=b.current.get(p.id);C||(C={alpha:1,scale:1},b.current.set(p.id,C)),C.alpha=Math.max(0,C.alpha-.08),C.scale=Math.max(0,C.scale-.08),E=C.alpha,H=C.scale,p.alpha=E,p.scale=H,b.current.set(p.id,C)}else p.alpha=1,p.scale=1;if(E>0){const C=kt&&!d.isAnimating?E*.3:E;f.current.render(p,C)}if(p.isRemoving&&E>.8&&E<.9&&c.current){const C=p.x+w/2,x=p.y+w/2;c.current.emit(C,x,p.color,15)}}})});const B=g.current;g.current=v,B&&!v&&d.isAnimating&&e==="game"&&!d.isGameOver&&!I.current&&setTimeout(()=>{d.isAnimating&&e==="game"&&!d.isGameOver&&!I.current&&(I.current=!0,Bt(),setTimeout(()=>{I.current=!1,Y.current=""},200))},100)}if(c.current&&(c.current.update(16),c.current.render()),kt&&!d.isAnimating&&!d.isGameOver){const v=ue(d);t.fillStyle="rgba(15, 15, 30, 0.92)",t.fillRect(0,0,m,G);const B=500*u,F=400*u,$=(m-B)/2,p=(G-F)/2,_=28*u;t.save(),t.globalAlpha=.96,t.fillStyle="rgba(26, 26, 46, 0.9)",t.beginPath(),t.roundRect($,p,B,F,_),t.fill(),t.strokeStyle="rgba(78, 205, 196, 0.4)",t.lineWidth=2*u,t.stroke(),t.restore(),t.shadowColor="rgba(78, 205, 196, 0.5)",t.shadowBlur=12*u,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillStyle="#4ecdc4",t.font=`700 ${Math.max(32,64*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Stage Cleared!",m/2,p+80*u);const k=Math.max(24,48*u),N=k*1.8,E=m/2-N,H=p+160*u;for(let bt=0;bt<3;bt++){const _t=E+bt*N;t.shadowColor=bt<v?"rgba(255, 217, 61, 0.6)":"transparent",t.shadowBlur=bt<v?12*u:0,t.fillStyle=bt<v?"#ffd93d":"rgba(102, 102, 102, 0.5)",t.font=`${k}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText("â˜…",_t,H)}t.shadowColor="transparent",t.shadowBlur=0,t.fillStyle="rgba(255, 255, 255, 0.9)",t.font=`600 ${Math.max(18,28*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillText(`Score: ${d.score.toLocaleString()}`,m/2,p+220*u);const C=m/2-120*u,x=p+280*u,ot=240*u,lt=60*u,St=16*u,Q=t.createLinearGradient(C,x,C,x+lt);Q.addColorStop(0,"#667eea"),Q.addColorStop(1,"#764ba2"),t.save(),t.beginPath(),t.roundRect(C,x,ot,lt,St),t.fillStyle=Q,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2*u,t.stroke(),t.restore(),t.shadowColor="rgba(102, 126, 234, 0.4)",t.shadowBlur=8*u,t.shadowOffsetX=0,t.shadowOffsetY=2*u,t.fillStyle="#ffffff",t.font=`600 ${Math.max(16,22*u)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Next Stage",m/2,x+lt/2),t.shadowColor="transparent",t.shadowBlur=0}},[st,d,mt]),Pt=S.useCallback(()=>{const t=a.current,m=l.current;if(!t||!m)return;const G=window.devicePixelRatio||1,M=t.width/G,u=t.height/G;M===0||u===0||(e==="stageSelect"?Qt(m,M,u):e==="game"?te(m,M,u):(m.fillStyle="#1a1a1a",m.fillRect(0,0,M,u)))},[e,Qt,te]);S.useEffect(()=>{let t=0;const G=1e3/60,M=()=>{const u=nt=>{nt-t>=G&&(Pt(),t=nt),h.current=requestAnimationFrame(u)};h.current=requestAnimationFrame(u)};return a.current&&l.current&&M(),()=>{h.current!==null&&(cancelAnimationFrame(h.current),h.current=null)}},[Pt]);const Ce=S.useCallback((t,m)=>{s.current||(s.current=!0,a.current=t,l.current=m,Pt())},[Pt]),Re=S.useCallback((t,m)=>{a.current=t,l.current=m,Pt()},[Pt]);S.useEffect(()=>{if(a.current&&l.current){const t=setTimeout(()=>{Pt()},10);return()=>clearTimeout(t)}},[Pt,e,Ct,r,d]),S.useEffect(()=>{if(d.isAnimating&&e==="game"&&!d.isGameOver&&!I.current){const t=JSON.stringify(d.board);if(t!==Y.current)return I.current=!0,Y.current=t,T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{const G=()=>{g.current?setTimeout(G,50):(Bt(),setTimeout(()=>{I.current=!1,Y.current=""},200))};G()},300),()=>{T.current&&(clearTimeout(T.current),T.current=null)}}else d.isAnimating||(Y.current="",I.current=!1)},[d.isAnimating,d.board,Bt,e,d.isGameOver]),S.useEffect(()=>{if(e!=="game"){Ot.current=!1,Tt.current=!1;return}const t=d.goals.every(m=>m.current>=m.target);if(!Ot.current&&d.isGameOver&&(console.log("Game Over!",d.score),gt.playGameOver()),!Tt.current&&t&&!d.isGameOver){console.log("Stage Cleared!",d.score),gt.playStageClear();try{const m=ue(d),G=localStorage.getItem("chipPuzzleGame_progress");let M={highestStage:1,stageRecords:{}};if(G)try{M=JSON.parse(G)}catch(ut){console.error("Failed to parse progress",ut)}const u=d.currentStage;u>=M.highestStage&&(M.highestStage=u+1),M.stageRecords||(M.stageRecords={});const nt=u.toString(),w=M.stageRecords[nt];!w||d.score>w.bestScore?M.stageRecords[nt]={stageNumber:u,stars:Math.max((w==null?void 0:w.stars)||0,m),score:d.score,bestScore:d.score,completedAt:new Date().toISOString(),attempts:((w==null?void 0:w.attempts)||0)+1}:M.stageRecords[nt]={...w,stars:Math.max(w.stars,m),attempts:w.attempts+1},localStorage.setItem("chipPuzzleGame_progress",JSON.stringify(M))}catch(m){console.error("Failed to save progress",m)}}Ot.current=d.isGameOver,Tt.current=t},[d.isGameOver,d.goals,d.score,d.currentStage,e]);const Xt=S.useCallback(t=>{if(ct.current){ct.current=!1;return}const m=a.current;if(!m)return;const G=m.getBoundingClientRect(),M=t.clientX-G.left,u=t.clientY-G.top,nt=window.devicePixelRatio||1,w=m.width/nt,ut=m.height/nt;if(e==="stageSelect"){if(!o)return;const R=w/1200,pt=120,q=40,U=20*R,K=Math.max(60,pt*R),tt=Math.max(24,q*R),at=w-K-U,et=U;if(M>=at&&M<=at+K&&u>=et&&u<=et+tt){if(mt)vt(!1),y.current=null;else{const x=fe(d.board);x&&(y.current=x,vt(!0),setTimeout(()=>{vt(!1),y.current=null},3e3))}return}const X=50,it=1e3,J=Math.ceil(it/X),ft=30*R,ht=80*R,v=ut-60*R+20*R,B=10*R;if(j>1){const x=w/2-ht-B/2;if(M>=x&&M<=x+ht&&u>=v&&u<=v+ft){rt(j-1),gt.playClick();return}}if(j<J){const x=w/2+B/2;if(M>=x&&M<=x+ht&&u>=v&&u<=v+ft){rt(j+1),gt.playClick();return}}const F=8,$=60,p=15,_=$*R,k=p*R,N=(w-(F*_+(F-1)*k))/2,E=100*R,H=Math.floor((M-N)/(_+k)),C=Math.floor((u-E)/(_+k));if(H>=0&&H<F&&C>=0){const ot=(j-1)*X+1+C*F+H;ot<=Ct&&ot<=it&&o(ot)}}else if(e==="game"){const R=w/1200;if(d.goals.every(C=>C.current>=C.target)&&!d.isAnimating&&!d.isGameOver){const C=w/2-100*R,x=ut/2+80*R,ot=200*R,lt=50*R;if(M>=C&&M<=C+ot&&u>=x&&u<=x+lt){if(o){const St=r+1;o(St)}gt.playClick();return}return}if(d.isGameOver){const C=w/2-100*R,x=ut/2+100*R,ot=200*R,lt=50*R;if(M>=C&&M<=C+ot&&u>=x&&u<=x+lt){o&&o(r),gt.playClick();return}return}if(d.isPaused){xt(),gt.playClick();return}const q=120,U=40,K=20*R,tt=10*R,at=Math.max(60,q*R),et=Math.max(24,U*R),X=Math.max(60,q*R),it=Math.max(24,U*R),J=w-at-K,ft=K,ht=J-X-tt,kt=K;if(M>=ht&&M<=ht+X&&u>=kt&&u<=kt+it){xt(),gt.playClick();return}if(M>=J&&M<=J+at&&u>=ft&&u<=ft+et){if(mt)vt(!1),y.current=null;else{const C=fe(d.board);C&&(y.current=C,vt(!0),setTimeout(()=>{vt(!1),y.current=null},3e3))}gt.playClick();return}if(d.isPaused)return;const B=(st.cellSize||50)*R,F=st.gridCols||9,$=st.gridRows||9,p=B*F,_=B*$,k=(w-p)/2,N=(ut-_)/2,E=Math.floor((M-k)/B),H=Math.floor((u-N)/B);E>=0&&E<F&&H>=0&&H<$&&d.board[H]&&d.board[H][E]&&(d.selectedGem?Et(d.selectedGem,{row:H,col:E}):yt(H,E),gt.playClick())}},[e,o,Ct,st,d,yt,Et,mt,xt]),Ht=S.useCallback(t=>{const m=a.current;if(!m||e!=="game"||d.isPaused)return;const G=m.getBoundingClientRect(),M=t.clientX-G.left,u=t.clientY-G.top,nt=window.devicePixelRatio||1,w=m.width/nt,ut=m.height/nt,R=w/1200,q=(st.cellSize||50)*R,U=st.gridCols||9,K=st.gridRows||9,tt=q*U,at=q*K,et=(w-tt)/2,X=(ut-at)/2,it=Math.floor((M-et)/q),J=Math.floor((u-X)/q);it>=0&&it<U&&J>=0&&J<K&&d.board[J]&&d.board[J][it]&&(W.current={row:J,col:it},V.current={x:M,y:u},D.current=!0)},[e,st,d.board,d.isPaused]),Ut=S.useCallback(t=>{const m=a.current;if(!m||e!=="game"||d.isPaused||!D.current||!W.current||!V.current)return;const G=m.getBoundingClientRect(),M=t.clientX-G.left,u=t.clientY-G.top,nt=window.devicePixelRatio||1,Mt=m.width/nt/1200,R=st.gridCols||9,pt=st.gridRows||9,q=V.current,U=M-q.x,K=u-q.y,tt=Math.sqrt(U*U+K*K),at=10*Mt;if(tt<at){O.current={x:M,y:u},z.current=null;return}const et=W.current;let X={row:et.row,col:et.col};if(Math.abs(U)>Math.abs(K)?U>0?X.col+=1:X.col-=1:K>0?X.row+=1:X.row-=1,X.col<0||X.col>=R||X.row<0||X.row>=pt){D.current=!1,W.current=null,V.current=null,z.current=null,O.current=null;return}O.current={x:M,y:u},z.current=X},[e,st,d.isPaused]),At=S.useCallback(()=>{if(D.current&&W.current&&z.current){const t=W.current,m=z.current,G=Math.abs(t.row-m.row),M=Math.abs(t.col-m.col);(G===1&&M===0||G===0&&M===1)&&(Et(t,m),gt.playClick(),ct.current=!0)}D.current=!1,W.current=null,V.current=null,z.current=null,O.current=null},[Et]);return S.useEffect(()=>{const t=a.current;if(t)return t.addEventListener("click",Xt),()=>{t.removeEventListener("click",Xt)}},[Xt]),S.useEffect(()=>{const t=a.current;if(t)return t.addEventListener("pointerdown",Ht),t.addEventListener("pointermove",Ut),t.addEventListener("pointerup",At),t.addEventListener("pointerleave",At),t.addEventListener("pointercancel",At),()=>{t.removeEventListener("pointerdown",Ht),t.removeEventListener("pointermove",Ut),t.removeEventListener("pointerup",At),t.removeEventListener("pointerleave",At),t.removeEventListener("pointercancel",At)}},[Ht,Ut,At]),P.jsx("div",{className:"game-board",children:P.jsx(io,{config:st,onReady:Ce,onResize:Re})})};const Lo=()=>{const[r,e]=S.useState("stageSelect"),[n,o]=S.useState(null),s=l=>{e(l)},a=l=>{o(l),e("game")};return P.jsx(Ke,{children:P.jsxs("div",{className:"app-container",children:[P.jsx(no,{onNavigate:s,currentScreen:r}),P.jsx(ao,{children:P.jsx(xo,{stageNumber:n||1,currentScreen:r,onNavigate:s,onStartStage:a})}),P.jsx(so,{})]})})},_o="1.1.0";(function(){const e="chipPuzzleGame_version",n="chipPuzzleGame_timestamp",o=document.querySelector('meta[name="app-version"]'),s=(o==null?void 0:o.getAttribute("content"))||_o,a=localStorage.getItem(e),l=Date.now().toString();if(a&&a!==s){const i=new URL(window.location.href);i.searchParams.set("_v",l),i.searchParams.set("_t",Date.now().toString()),window.location.replace(i.toString());return}s&&(localStorage.setItem(e,s),localStorage.setItem(n,l));const f=new URL(window.location.href);f.searchParams.set("_check",l),fetch(f.toString(),{method:"GET",cache:"no-store",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}}).then(i=>i.text()).then(i=>{if(i){const c=i.match(/<meta\s+name=["']app-version["']\s+content=["']([^"']+)["']/i);if(c&&c[1]&&c[1]!==s){const h=new URL(window.location.href);h.searchParams.set("_reload",Date.now().toString()),window.location.replace(h.toString())}}}).catch(()=>{})})();Jt.createRoot(document.getElementById("root")).render(P.jsx($t.StrictMode,{children:P.jsx(It,{children:P.jsx(Lo,{})})}));
