var Re=Object.defineProperty;var Me=(s,e,n)=>e in s?Re(s,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[e]=n;var Rt=(s,e,n)=>(Me(s,typeof e!="symbol"?e+"":e,n),n);import{r as b,a as Te,g as ke,R as $t}from"./vendor-1.1.0-57209f9c.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();var he={exports:{}},Wt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Pe=b,Ge=Symbol.for("react.element"),Oe=Symbol.for("react.fragment"),Be=Object.prototype.hasOwnProperty,Ae=Pe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ee={key:!0,ref:!0,__self:!0,__source:!0};function de(s,e,n){var o,r={},a=null,l=null;n!==void 0&&(a=""+n),e.key!==void 0&&(a=""+e.key),e.ref!==void 0&&(l=e.ref);for(o in e)Be.call(e,o)&&!Ee.hasOwnProperty(o)&&(r[o]=e[o]);if(s&&s.defaultProps)for(o in e=s.defaultProps,e)r[o]===void 0&&(r[o]=e[o]);return{$$typeof:Ge,type:s,key:a,ref:l,props:r,_owner:Ae.current}}Wt.Fragment=Oe;Wt.jsx=de;Wt.jsxs=de;he.exports=Wt;var P=he.exports,Jt={},ee=Te;Jt.createRoot=ee.createRoot,Jt.hydrateRoot=ee.hydrateRoot;var pe={exports:{}},xe="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",Le=xe,Ne=Le;function ge(){}function me(){}me.resetWarningCache=ge;var _e=function(){function s(o,r,a,l,f,i){if(i!==Ne){var u=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw u.name="Invariant Violation",u}}s.isRequired=s;function e(){return s}var n={array:s,bigint:s,bool:s,func:s,number:s,object:s,string:s,symbol:s,any:s,arrayOf:e,element:s,elementType:s,instanceOf:e,node:s,objectOf:e,oneOf:e,oneOfType:e,shape:e,exact:e,checkPropTypes:me,resetWarningCache:ge};return n.PropTypes=n,n};pe.exports=_e();var je=pe.exports;const L=ke(je);function Ie(s,e){s.prototype=Object.create(e.prototype),s.prototype.constructor=s,Zt(s,e)}function Zt(s,e){return Zt=Object.setPrototypeOf||function(n,o){return n.__proto__=o,n},Zt(s,e)}var Z={BASE:"base",BODY:"body",HEAD:"head",HTML:"html",LINK:"link",META:"meta",NOSCRIPT:"noscript",SCRIPT:"script",STYLE:"style",TITLE:"title",FRAGMENT:"Symbol(react.fragment)"},$e={rel:["amphtml","canonical","alternate"]},Ye={type:["application/ld+json"]},ze={charset:"",name:["robots","description"],property:["og:type","og:title","og:url","og:image","og:image:alt","og:description","twitter:url","twitter:title","twitter:description","twitter:image","twitter:image:alt","twitter:card","twitter:site"]};Object.keys(Z).map(function(s){return Z[s]});var Ft={accesskey:"accessKey",charset:"charSet",class:"className",contenteditable:"contentEditable",contextmenu:"contextMenu","http-equiv":"httpEquiv",itemprop:"itemProp",tabindex:"tabIndex"};Object.keys(Ft).reduce(function(s,e){return s[Ft[e]]=e,s},{});var Fe=function(s){return Array.isArray(s)?s.join(""):s},qt=function(s,e){return Array.isArray(s)?s.reduce(function(n,o){return function(r,a){for(var l=Object.keys(r),f=0;f<l.length;f+=1)if(a[l[f]]&&a[l[f]].includes(r[l[f]]))return!0;return!1}(o,e)?n.priority.push(o):n.default.push(o),n},{priority:[],default:[]}):{default:s}},We=[Z.NOSCRIPT,Z.SCRIPT,Z.STYLE],Vt=function(s,e){return e===void 0&&(e=!0),e===!1?String(s):String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")},oe=function(s){return Object.keys(s).reduce(function(e,n){var o=s[n]!==void 0?n+'="'+s[n]+'"':""+n;return e?e+" "+o:o},"")},ne=function(s,e){return e===void 0&&(e={}),Object.keys(s).reduce(function(n,o){return n[Ft[o]||o]=s[o],n},e)},zt=function(s,e){return e.map(function(n,o){var r,a=((r={key:o})["data-rh"]=!0,r);return Object.keys(n).forEach(function(l){var f=Ft[l]||l;f==="innerHTML"||f==="cssText"?a.dangerouslySetInnerHTML={__html:n.innerHTML||n.cssText}:a[f]=n[l]}),$t.createElement(s,a)})},wt=function(s,e,n){switch(s){case Z.TITLE:return{toComponent:function(){return r=e.titleAttributes,(a={key:o=e.title})["data-rh"]=!0,l=ne(r,a),[$t.createElement(Z.TITLE,l,o)];var o,r,a,l},toString:function(){return function(o,r,a,l){var f=oe(a),i=Fe(r);return f?"<"+o+' data-rh="true" '+f+">"+Vt(i,l)+"</"+o+">":"<"+o+' data-rh="true">'+Vt(i,l)+"</"+o+">"}(s,e.title,e.titleAttributes,n)}};case"bodyAttributes":case"htmlAttributes":return{toComponent:function(){return ne(e)},toString:function(){return oe(e)}};default:return{toComponent:function(){return zt(s,e)},toString:function(){return function(o,r,a){return r.reduce(function(l,f){var i=Object.keys(f).filter(function(S){return!(S==="innerHTML"||S==="cssText")}).reduce(function(S,y){var g=f[y]===void 0?y:y+'="'+Vt(f[y],a)+'"';return S?S+" "+g:g},""),u=f.innerHTML||f.cssText||"",h=We.indexOf(o)===-1;return l+"<"+o+' data-rh="true" '+i+(h?"/>":">"+u+"</"+o+">")},"")}(s,e,n)}}}},De=function(s){var e=s.baseTag,n=s.bodyAttributes,o=s.encode,r=s.htmlAttributes,a=s.noscriptTags,l=s.styleTags,f=s.title,i=f===void 0?"":f,u=s.titleAttributes,h=s.linkTags,S=s.metaTags,y=s.scriptTags,g={toComponent:function(){},toString:function(){return""}};if(s.prioritizeSeoTags){var T=function(z){var j=z.linkTags,D=z.scriptTags,V=z.encode,Y=qt(z.metaTags,ze),O=qt(j,$e),F=qt(D,Ye);return{priorityMethods:{toComponent:function(){return[].concat(zt(Z.META,Y.priority),zt(Z.LINK,O.priority),zt(Z.SCRIPT,F.priority))},toString:function(){return wt(Z.META,Y.priority,V)+" "+wt(Z.LINK,O.priority,V)+" "+wt(Z.SCRIPT,F.priority,V)}},metaTags:Y.default,linkTags:O.default,scriptTags:F.default}}(s);g=T.priorityMethods,h=T.linkTags,S=T.metaTags,y=T.scriptTags}return{priority:g,base:wt(Z.BASE,e,o),bodyAttributes:wt("bodyAttributes",n,o),htmlAttributes:wt("htmlAttributes",r,o),link:wt(Z.LINK,h,o),meta:wt(Z.META,S,o),noscript:wt(Z.NOSCRIPT,a,o),script:wt(Z.SCRIPT,y,o),style:wt(Z.STYLE,l,o),title:wt(Z.TITLE,{title:i,titleAttributes:u},o)}},Yt=[],Xe=function(s,e){var n=this;e===void 0&&(e=typeof document<"u"),this.instances=[],this.value={setHelmet:function(o){n.context.helmet=o},helmetInstances:{get:function(){return n.canUseDOM?Yt:n.instances},add:function(o){(n.canUseDOM?Yt:n.instances).push(o)},remove:function(o){var r=(n.canUseDOM?Yt:n.instances).indexOf(o);(n.canUseDOM?Yt:n.instances).splice(r,1)}}},this.context=s,this.canUseDOM=e,e||(s.helmet=De({baseTag:[],bodyAttributes:{},encodeSpecialCharacters:!0,htmlAttributes:{},linkTags:[],metaTags:[],noscriptTags:[],scriptTags:[],styleTags:[],title:"",titleAttributes:{}}))},He=$t.createContext({}),Ue=L.shape({setHelmet:L.func,helmetInstances:L.shape({get:L.func,add:L.func,remove:L.func})}),qe=typeof document<"u",jt=function(s){function e(n){var o;return(o=s.call(this,n)||this).helmetData=new Xe(o.props.context,e.canUseDOM),o}return Ie(e,s),e.prototype.render=function(){return $t.createElement(He.Provider,{value:this.helmetData.value},this.props.children)},e}(b.Component);jt.canUseDOM=qe,jt.propTypes={context:L.shape({helmet:L.shape()}),children:L.node.isRequired},jt.defaultProps={context:{}},jt.displayName="HelmetProvider";Ue.isRequired;L.object,L.object,L.oneOfType([L.arrayOf(L.node),L.node]),L.string,L.bool,L.bool,L.object,L.arrayOf(L.object),L.arrayOf(L.object),L.arrayOf(L.object),L.func,L.arrayOf(L.object),L.arrayOf(L.object),L.string,L.object,L.string,L.bool,L.object;class Ve extends b.Component{constructor(){super(...arguments);Rt(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,o){console.error("Uncaught error:",n,o)}render(){return this.state.hasError?this.props.fallback||P.jsxs("div",{className:"error-boundary",children:[P.jsx("h2",{children:"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"}),P.jsx("p",{children:"ê²Œìž„ì„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”."}),P.jsx("button",{onClick:()=>window.location.reload(),children:"ìƒˆë¡œê³ ì¹¨"})]}):this.props.children}}const Ke="modulepreload",Je=function(s){return"/ChipPuzzleGame/"+s},se={},_t=function(e,n,o){if(!n||n.length===0)return e();const r=document.getElementsByTagName("link");return Promise.all(n.map(a=>{if(a=Je(a),a in se)return;se[a]=!0;const l=a.endsWith(".css"),f=l?'[rel="stylesheet"]':"";if(!!o)for(let h=r.length-1;h>=0;h--){const S=r[h];if(S.href===a&&(!l||S.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${f}`))return;const u=document.createElement("link");if(u.rel=l?"stylesheet":Ke,l||(u.as="script",u.crossOrigin=""),u.href=a,document.head.appendChild(u),l)return new Promise((h,S)=>{u.addEventListener("load",h),u.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${a}`)))})})).then(()=>e()).catch(a=>{const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a})},Ze=(s,e)=>{const n=s[e];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((o,r)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(r.bind(null,new Error("Unknown variable dynamic import: "+e)))})},ye=["en","ko","zh","ja"],Qe="en",to={en:"English",ko:"í•œêµ­ì–´",zh:"ä¸­æ–‡",ja:"æ—¥æœ¬èªž"};class re{constructor(){Rt(this,"supportedLanguages",ye);Rt(this,"defaultLanguage",Qe)}detectBrowserLanguage(){const e=navigator.language.split("-")[0];return this.supportedLanguages.includes(e)?e:this.defaultLanguage}getStoredLanguage(){try{return localStorage.getItem("language")}catch(e){return console.error("Failed to get stored language:",e),null}}setLanguage(e){if(this.supportedLanguages.includes(e))try{localStorage.setItem("language",e),window.dispatchEvent(new CustomEvent("languageChanged",{detail:e}))}catch(n){console.error("Failed to set language:",n)}}getCurrentLanguage(){const e=this.getStoredLanguage();return e&&this.supportedLanguages.includes(e)?e:this.detectBrowserLanguage()}}const Kt={},Dt=()=>{const[s,e]=b.useState(()=>new re().getCurrentLanguage()),[n,o]=b.useState(null),[r,a]=b.useState(!0);return b.useEffect(()=>{(async()=>{a(!0);try{if(Kt[s]){o(Kt[s]),a(!1);return}const h=await Ze(Object.assign({"../locales/en.json":()=>_t(()=>import("./en-1.1.0-b0bc0d43.js"),[]),"../locales/ja.json":()=>_t(()=>import("./ja-1.1.0-0635fea6.js"),[]),"../locales/ko.json":()=>_t(()=>import("./ko-1.1.0-f4262f42.js"),[]),"../locales/zh.json":()=>_t(()=>import("./zh-1.1.0-ea7490c2.js"),[])}),`../locales/${s}.json`);Kt[s]=h.default,o(h.default)}catch(h){console.error(`Failed to load translations for ${s}:`,h);try{const S=await _t(()=>import("./en-1.1.0-b0bc0d43.js"),[]);o(S.default)}catch(S){console.error("Failed to load fallback translations:",S)}}finally{a(!1)}})();const u=h=>{e(h.detail)};return window.addEventListener("languageChanged",u),()=>{window.removeEventListener("languageChanged",u)}},[s]),{language:s,setLanguage:i=>{new re().setLanguage(i)},t:i=>{if(r||!n)return i;const u=i.split(".");let h=n;for(const S of u)if(h=h==null?void 0:h[S],h===void 0)break;return h||i},isLoading:r}},be=()=>{const{language:s,setLanguage:e}=Dt();return P.jsx("select",{value:s,onChange:n=>e(n.target.value),className:"language-selector","aria-label":"Language selector",children:ye.map(n=>P.jsx("option",{value:n,children:to[n]},n))})};class eo{constructor(){Rt(this,"audioCtx",null);Rt(this,"enabled",!0)}getContext(){if(!this.enabled)return null;try{if(!this.audioCtx){const e=window.AudioContext||window.webkitAudioContext;if(!e)return console.warn("Web Audio API is not supported in this browser."),this.enabled=!1,null;try{this.audioCtx=new e,this.audioCtx.state==="suspended"&&this.audioCtx.resume().catch(n=>{console.warn("Failed to resume AudioContext",n)})}catch(n){return console.warn("Failed to create AudioContext",n),this.enabled=!1,null}}return this.audioCtx}catch(e){return console.warn("Failed to initialize AudioContext",e),this.enabled=!1,null}}setEnabled(e){this.enabled=e}playTone(e,n,o="sine",r=.2){const a=this.getContext();if(!a)return;const l=a.createOscillator(),f=a.createGain();l.type=o,l.frequency.value=e,f.gain.value=r,l.connect(f),f.connect(a.destination);const i=a.currentTime;l.start(i),l.stop(i+n),f.gain.setValueAtTime(r,i),f.gain.linearRampToValueAtTime(0,i+n)}playClick(){this.playTone(440,.08,"square",.15)}playMatch(){this.playTone(660,.12,"triangle",.2)}playSpecial(){this.playTone(880,.16,"sawtooth",.22)}playStageClear(){this.getContext()&&(this.playTone(880,.15,"triangle",.22),setTimeout(()=>{this.playTone(1046.5,.18,"triangle",.22)},120))}playGameOver(){const e=this.getContext();if(!e)return;const n=440,o=220,r=.4,a=e.createOscillator(),l=e.createGain();a.type="sawtooth",a.frequency.setValueAtTime(n,e.currentTime),a.frequency.exponentialRampToValueAtTime(o,e.currentTime+r),l.gain.value=.22,l.gain.setValueAtTime(.22,e.currentTime),l.gain.linearRampToValueAtTime(0,e.currentTime+r),a.connect(l),l.connect(e.destination),a.start(e.currentTime),a.stop(e.currentTime+r)}}const gt=new eo;const oo=({onNavigate:s,currentScreen:e})=>{const{t:n}=Dt(),[o,r]=b.useState(()=>{const i=localStorage.getItem("chipPuzzleGame_soundEnabled");return i!==null?JSON.parse(i):!0});b.useEffect(()=>{gt.setEnabled(o),localStorage.setItem("chipPuzzleGame_soundEnabled",JSON.stringify(o))},[o]);const a=i=>{s&&s(i)},l=()=>{r(!o),o||gt.playClick()},f=!1;return P.jsx("header",{className:"header",children:P.jsxs("div",{className:"header-content",children:[P.jsxs("div",{className:"header-left",children:[f,P.jsxs("div",{className:"header-logo",onClick:()=>a("stageSelect"),style:{cursor:"pointer",display:"flex",alignItems:"center",gap:"12px"},children:[P.jsx("img",{src:"/ChipGames_Logo.png",onError:i=>{const u=i.target;u.src&&!u.src.includes(".svg")&&(u.src="/ChipGames_Logo.svg")},alt:"CHIP GAMES",style:{height:"40px",width:"auto"}}),P.jsx("span",{className:"header-game-title",children:n("header.gameTitle")})]})]}),P.jsxs("nav",{className:"header-nav",children:[P.jsx("button",{className:"header-nav-button",onClick:()=>a("stageSelect"),children:n("header.playGame")}),P.jsx("button",{className:"header-nav-button",onClick:()=>a("guide"),children:n("header.guide")}),P.jsx("button",{className:"header-nav-button",onClick:()=>a("help"),children:n("header.help")})]}),P.jsxs("div",{className:"header-right",children:[P.jsx("button",{className:"header-sound-button",onClick:l,title:n(o?"header.soundOff":"header.soundOn"),children:o?"ðŸ”Š":"ðŸ”‡"}),P.jsx(be,{})]})]})})};const no="1.1.0",so=()=>{const{t:s}=Dt();return P.jsx("footer",{className:"footer",children:P.jsxs("div",{className:"footer-content",children:[P.jsxs("div",{className:"footer-links",children:[P.jsx("a",{href:"#privacy",children:s("footer.privacyPolicy")}),P.jsx("a",{href:"#contact",children:s("footer.contactUs")})]}),P.jsx(be,{}),P.jsxs("div",{className:"footer-copyright",children:[s("footer.copyright")," | v",no]})]})})};const ro=({children:s})=>P.jsx("div",{className:"game-container",children:s}),Se={aspectRatio:16/9,gridRows:9,gridCols:9,pixelRatio:window.devicePixelRatio||1};const ao=({config:s,onReady:e,onResize:n})=>{const o=b.useRef(null),r=b.useRef(null),a=b.useRef(e),l=b.useRef(n),f=b.useRef(!1);return b.useEffect(()=>{a.current=e},[e]),b.useEffect(()=>{l.current=n},[n]),b.useEffect(()=>{const i=o.current,u=r.current;if(!i||!u)return;const h=i.getContext("2d");if(!h){console.error("Failed to get 2D context");return}const S=()=>{const g=window.devicePixelRatio||1,T=u.clientWidth,z=u.clientHeight,j=s.aspectRatio||Se.aspectRatio||16/9,D=1200,V=675;let Y,O;const F=Math.min(T,D),ct=Math.min(z,V);F/ct>j?(O=ct,Y=O*j):(Y=F,O=Y/j),i.width=Y*g,i.height=O*g,h.scale(g,g),i.style.width=`${Y}px`,i.style.height=`${O}px`,i.style.display="block",i.style.maxWidth="100%",i.style.maxHeight="100%",!f.current&&a.current&&(f.current=!0,a.current(i,h)),f.current&&l.current&&setTimeout(()=>{l.current&&l.current(i,h)},0)};S();const y=new ResizeObserver(()=>{S()});return y.observe(u),()=>{y.disconnect(),f.current=!1}},[s]),P.jsx("div",{ref:r,className:"game-canvas-wrapper",children:P.jsx("canvas",{ref:o,className:"game-canvas"})})},Lt=["red","yellow","blue","green","purple","orange"],It={red:{light:"#e74c3c",dark:"#c0392b"},yellow:{light:"#f1c40f",dark:"#f39c12"},blue:{light:"#3498db",dark:"#2980b9"},green:{light:"#2ecc71",dark:"#27ae60"},purple:{light:"#9b59b6",dark:"#8e44ad"},orange:{light:"#e67e22",dark:"#d35400"}};class io{constructor(e,n){Rt(this,"ctx");Rt(this,"cellSize");this.ctx=e,this.cellSize=n}render(e,n=1){this.ctx.save();const o=e.x+this.cellSize/2,r=e.y+this.cellSize/2;switch(this.ctx.translate(o,r),this.ctx.scale(e.scale||1,e.scale||1),this.ctx.rotate(e.rotation||0),this.ctx.globalAlpha=n,e.type){case"normal":this.renderNormalGem(e);break;case"striped":this.renderStripedGem(e);break;case"wrapped":this.renderWrappedGem(e);break;case"colorBomb":this.renderColorBomb(e);break}this.ctx.restore()}renderNormalGem(e){const n=It[e.color],o=this.cellSize*.85,r=-o/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.roundRect(r+2,r+2,o,o,o*.2),this.ctx.fill();const a=this.ctx.createLinearGradient(r,r,r+o,r+o);a.addColorStop(0,n.light),a.addColorStop(1,n.dark),this.ctx.fillStyle=a,this.roundRect(r,r,o,o,o*.2),this.ctx.fill(),this.renderColorPattern(e.color,r,o),this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.roundRect(r,r,o,o*.4,o*.2),this.ctx.fill(),this.ctx.strokeStyle=this.getBorderColor(e.color),this.ctx.lineWidth=o*.06,this.roundRect(r,r,o,o,o*.2),this.ctx.stroke()}getBorderColor(e){return{red:"rgba(231, 76, 60, 0.9)",yellow:"rgba(241, 196, 15, 0.9)",blue:"rgba(52, 152, 219, 0.9)",green:"rgba(46, 204, 113, 0.9)",purple:"rgba(155, 89, 182, 0.9)",orange:"rgba(230, 126, 34, 0.9)"}[e]}renderColorPattern(e,n,o){switch(this.ctx.save(),this.ctx.globalAlpha=.5,e){case"red":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.18,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="rgba(192, 57, 43, 0.5)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.1,0,Math.PI*2),this.ctx.fill();break;case"yellow":this.ctx.fillStyle="rgba(255, 255, 255, 0.7)",this.drawStar(0,0,o*.1,o*.18,5),this.ctx.fill();break;case"blue":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.moveTo(0,-o*.18),this.ctx.lineTo(o*.18,0),this.ctx.lineTo(0,o*.18),this.ctx.lineTo(-o*.18,0),this.ctx.closePath(),this.ctx.fill();break;case"green":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.moveTo(0,-o*.18),this.ctx.lineTo(-o*.15,o*.12),this.ctx.lineTo(o*.15,o*.12),this.ctx.closePath(),this.ctx.fill();break;case"purple":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.fillRect(-o*.12,-o*.12,o*.24,o*.24);break;case"orange":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath();for(let r=0;r<6;r++){const a=Math.PI/3*r,l=Math.cos(a)*o*.15,f=Math.sin(a)*o*.15;r===0?this.ctx.moveTo(l,f):this.ctx.lineTo(l,f)}this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle="rgba(211, 84, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.08,0,Math.PI*2),this.ctx.fill();break}this.ctx.restore()}renderStripedGem(e){const n=It[e.color],o=this.cellSize*.85,r=-o/2,a=this.ctx.createLinearGradient(r,r,r+o,r+o);if(a.addColorStop(0,n.light),a.addColorStop(1,n.dark),this.ctx.fillStyle=a,this.roundRect(r,r,o,o,o*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.6)",this.ctx.lineWidth=o*.1,this.ctx.lineCap="round",e.stripedDirection==="horizontal")for(let l=0;l<3;l++){const f=r+o/4*(l+1);this.ctx.beginPath(),this.ctx.moveTo(r,f),this.ctx.lineTo(r+o,f),this.ctx.stroke()}else for(let l=0;l<3;l++){const f=r+o/4*(l+1);this.ctx.beginPath(),this.ctx.moveTo(f,r),this.ctx.lineTo(f,r+o),this.ctx.stroke()}}renderWrappedGem(e){const n=It[e.color],o=this.cellSize*.85,r=-o/2,a=this.ctx.createLinearGradient(r,r,r+o,r+o);a.addColorStop(0,n.light),a.addColorStop(1,n.dark),this.ctx.fillStyle=a,this.roundRect(r,r,o,o,o*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=o*.08,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(r,r),this.ctx.lineTo(r+o,r+o),this.ctx.moveTo(r+o,r),this.ctx.lineTo(r,r+o),this.ctx.stroke()}renderColorBomb(e){const n=this.cellSize*.85,o=-n/2,r=this.ctx.createLinearGradient(o,o,o+n,o+n);r.addColorStop(0,"#ff6b6b"),r.addColorStop(.2,"#ffd93d"),r.addColorStop(.4,"#4ecdc4"),r.addColorStop(.6,"#95e1d3"),r.addColorStop(.8,"#a29bfe"),r.addColorStop(1,"#fd79a8"),this.ctx.fillStyle=r,this.roundRect(o,o,n,n,n*.2),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 255, 255, 0.9)",this.drawStar(0,0,n*.3,n*.6,5),this.ctx.fill()}roundRect(e,n,o,r,a){this.ctx.beginPath(),this.ctx.moveTo(e+a,n),this.ctx.lineTo(e+o-a,n),this.ctx.quadraticCurveTo(e+o,n,e+o,n+a),this.ctx.lineTo(e+o,n+r-a),this.ctx.quadraticCurveTo(e+o,n+r,e+o-a,n+r),this.ctx.lineTo(e+a,n+r),this.ctx.quadraticCurveTo(e,n+r,e,n+r-a),this.ctx.lineTo(e,n+a),this.ctx.quadraticCurveTo(e,n,e+a,n),this.ctx.closePath()}drawStar(e,n,o,r,a){this.ctx.beginPath();for(let l=0;l<a*2;l++){const f=Math.PI*l/a,i=l%2===0?r:o,u=e+Math.cos(f)*i,h=n+Math.sin(f)*i;l===0?this.ctx.moveTo(u,h):this.ctx.lineTo(u,h)}this.ctx.closePath()}}const ae={rows:9,cols:9};function Gt(s){var o,r;const e=[],n=new Set;for(let a=0;a<s.length;a++){let l=1,f=(o=s[a][0])==null?void 0:o.color,i=0;for(let u=1;u<=s[a].length;u++){const h=s[a][u];if(h&&h.color===f&&f)l++;else{if(l>=3&&f){const S=[];for(let y=0;y<l;y++){const g={row:a,col:i+y},T=`${g.row},${g.col}`;n.has(T)||(S.push(g),n.add(T))}S.length>0&&e.push({type:"horizontal",positions:S})}h?(l=1,f=h.color,i=u):(l=0,f=void 0)}}}if(s.length>0)for(let a=0;a<s[0].length;a++){let l=1,f=(r=s[0][a])==null?void 0:r.color,i=0;for(let u=1;u<=s.length;u++){const h=u<s.length?s[u][a]:null;if(h&&h.color===f&&f)l++;else{if(l>=3&&f){const S=[];for(let y=0;y<l;y++){const g={row:i+y,col:a},T=`${g.row},${g.col}`;n.has(T)||(S.push(g),n.add(T))}S.length>0&&e.push({type:"vertical",positions:S})}h?(l=1,f=h.color,i=u):(l=0,f=void 0)}}}return e}class lo{constructor(e){Rt(this,"seed");this.seed=e}next(){return this.seed=(this.seed*9301+49297)%233280,this.seed/233280}}function ie(s){const e=new lo(s),n=co(s),o=uo(s),r=fo(s),a=ho(n.rows,n.cols,e);return{stageNumber:s,gridSize:n,targetScore:o,maxMoves:r,goals:[{type:"score",target:o,current:0}],initialBoard:a}}function co(s){return s<=100?{rows:9,cols:9}:s<=300?{rows:8,cols:8}:s<=600?{rows:7,cols:7}:{rows:6,cols:6}}function uo(s){const o=Math.floor(s/100)*500;return 1e3+s*50+o}function fo(s){const n=Math.floor(s/20),o=20;return s>500?Math.max(o,50-n-Math.floor((s-500)/10)):Math.max(o,50-n)}function ho(s,e,n){const o=[];for(let r=0;r<s;r++){o[r]=[];for(let a=0;a<e;a++){const l=Lt[Math.floor(n.next()*Lt.length)];o[r][a]={id:`${r}-${a}-${Date.now()}`,color:l,type:"normal",position:{row:r,col:a},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}}return po(o,n)}function po(s,e){var a,l,f,i,u;let o=0;const r=e?()=>e.next():()=>Math.random();try{for(;o<100;){const h=Gt(s);if(h.length===0)return s;for(const S of h)for(const y of S.positions){const g=(a=s[y.row])==null?void 0:a[y.col];if(g){const T=Lt.indexOf(g.color),z=Lt.filter((V,Y)=>Y!==T);if(z.length===0)continue;let j=g.color,D=0;for(;D<10&&j===g.color;){const V=Math.floor(r()*z.length),Y=z[V];[(l=s[y.row-1])==null?void 0:l[y.col],(f=s[y.row+1])==null?void 0:f[y.col],(i=s[y.row])==null?void 0:i[y.col-1],(u=s[y.row])==null?void 0:u[y.col+1]].filter(Boolean).some(ct=>(ct==null?void 0:ct.color)===Y)?D++:j=Y}j===g.color&&z.length>0&&(j=z[0]),g.color=j}}o++}}catch(h){console.error("Error in ensureNoInitialMatches:",h)}return s}function le(s,e=50){var a;const n=s.map(l=>[...l]),o=n.length,r=((a=n[0])==null?void 0:a.length)||0;for(let l=0;l<r;l++){let f=o-1;for(let i=o-1;i>=0;i--)if(n[i][l]!==null){if(f!==i){const u=n[i][l];n[f][l]=u,(u.y===void 0||u.y===0)&&(u.y=i*e),u.targetY=f,u.position.row=f,n[i][l]=null}f--}for(let i=f;i>=0;i--){const u=go(i,l);u.y=-e*(f-i+1),u.targetY=i,n[i][l]=u}}return n}function go(s,e){const n=Lt[Math.floor(Math.random()*Lt.length)];return{id:`${Date.now()}-${s}-${e}-${Math.random()}`,color:n,type:"normal",position:{row:s,col:e},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}function mo(s){const e=[];for(const n of s){const o=n.positions.length;if(o===4){const r=Math.floor(o/2),a=n.positions[r];e.push({position:a,type:"striped",stripedDirection:n.type==="horizontal"?"horizontal":"vertical"})}else if(o>=5){const r=Math.floor(o/2),a=n.positions[r];e.push({position:a,type:"colorBomb"})}}return e}function yo(s){const e=[],n=s.filter(r=>r.type==="horizontal"),o=s.filter(r=>r.type==="vertical");for(const r of n)for(const a of o){const l=r.positions.find(f=>a.positions.some(i=>f.row===i.row&&f.col===i.col));l&&e.push({position:l,type:"wrapped"})}return e}function bo(s){const e=yo(s),n=s.filter(a=>!e.some(l=>{var f,i;return l.position.row===((f=a.positions[0])==null?void 0:f.row)&&l.position.col===((i=a.positions[0])==null?void 0:i.col)})),o=[];o.push(...e);const r=mo(n);for(const a of r)e.some(f=>f.position.row===a.position.row&&f.position.col===a.position.col)||o.push(a);return o}function So(s,e,n){var l,f,i;const o=[],{row:r,col:a}=s.position;if(n==="horizontal")for(let u=0;u<((l=e[0])==null?void 0:l.length);u++)(f=e[r])!=null&&f[u]&&o.push({row:r,col:u});else for(let u=0;u<e.length;u++)(i=e[u])!=null&&i[a]&&o.push({row:u,col:a});return{positionsToRemove:o,score:o.length*20}}function wo(s,e){var a,l;const n=[],{row:o,col:r}=s.position;for(let f=o-1;f<=o+1;f++)for(let i=r-1;i<=r+1;i++)f>=0&&f<e.length&&i>=0&&i<(((a=e[0])==null?void 0:a.length)||0)&&((l=e[f])!=null&&l[i])&&n.push({row:f,col:i});return{positionsToRemove:n,score:n.length*30}}function vo(s,e){var r,a;const n=[],o=s.color;for(let l=0;l<e.length;l++)for(let f=0;f<(((r=e[l])==null?void 0:r.length)||0);f++){const i=(a=e[l])==null?void 0:a[f];i&&i.color===o&&n.push({row:l,col:f})}return{positionsToRemove:n,score:n.length*50}}function Co(s,e,n){var f,i,u;const o=[],{row:r,col:a}=s.position;for(let h=0;h<((f=n[0])==null?void 0:f.length);h++)(i=n[r])!=null&&i[h]&&o.push({row:r,col:h});for(let h=0;h<n.length;h++)(u=n[h])!=null&&u[a]&&o.push({row:h,col:a});const l=Array.from(new Set(o.map(h=>`${h.row},${h.col}`))).map(h=>{const[S,y]=h.split(",").map(Number);return{row:S,col:y}});return{positionsToRemove:l,score:l.length*30}}function Ro(s,e,n){var u,h,S,y;const o=[],r=s.type==="striped"?s:e,a=s.type==="wrapped"?s:e,l=r.stripedDirection||"horizontal",{row:f,col:i}=a.position;if(l==="horizontal"){for(let g=f-1;g<=f+1;g++)if(g>=0&&g<n.length)for(let T=0;T<((u=n[0])==null?void 0:u.length);T++)(h=n[g])!=null&&h[T]&&o.push({row:g,col:T})}else for(let g=i-1;g<=i+1;g++)if(g>=0&&g<(((S=n[0])==null?void 0:S.length)||0))for(let T=0;T<n.length;T++)(y=n[T])!=null&&y[g]&&o.push({row:T,col:g});return{positionsToRemove:o,score:o.length*40}}function Mo(s,e,n){var f,i,u,h;const o=[],r=s.type==="striped"?s:e,a=r.color;if((r.stripedDirection||"horizontal")==="horizontal")for(let S=0;S<n.length;S++)for(let y=0;y<(((f=n[S])==null?void 0:f.length)||0);y++){const g=(i=n[S])==null?void 0:i[y];g&&g.color===a&&o.push({row:S,col:y})}else for(let S=0;S<(((u=n[0])==null?void 0:u.length)||0);S++)for(let y=0;y<n.length;y++){const g=(h=n[y])==null?void 0:h[S];g&&g.color===a&&o.push({row:y,col:S})}return{positionsToRemove:o,score:o.length*60}}function To(s,e,n){var l,f;const o=[],{row:r,col:a}=s.position;for(let i=r-2;i<=r+2;i++)for(let u=a-2;u<=a+2;u++)i>=0&&i<n.length&&u>=0&&u<(((l=n[0])==null?void 0:l.length)||0)&&((f=n[i])!=null&&f[u])&&o.push({row:i,col:u});return{positionsToRemove:o,score:o.length*50}}function ko(s,e,n){var l,f;const o=[],a=(s.type==="wrapped"?s:e).color;for(let i=0;i<n.length;i++)for(let u=0;u<(((l=n[i])==null?void 0:l.length)||0);u++){const h=(f=n[i])==null?void 0:f[u];h&&h.color===a&&o.push({row:i,col:u})}return{positionsToRemove:o,score:o.length*70}}function Po(s,e,n){var r,a;const o=[];for(let l=0;l<n.length;l++)for(let f=0;f<(((r=n[l])==null?void 0:r.length)||0);f++)(a=n[l])!=null&&a[f]&&o.push({row:l,col:f});return{positionsToRemove:o,score:o.length*100}}function Go(s,e,n){switch([s.type,e.type].sort().join("+")){case"striped+striped":return Co(s,e,n);case"striped+wrapped":return Ro(s,e,n);case"colorBomb+striped":return Mo(s,e,n);case"wrapped+wrapped":return To(s,e,n);case"colorBomb+wrapped":return ko(s,e,n);case"colorBomb+colorBomb":return Po(s,e,n);default:return null}}function Oo(s,e){switch(s.type){case"striped":return So(s,e,s.stripedDirection||"horizontal");case"wrapped":return wo(s,e);case"colorBomb":return vo(s,e);default:return{positionsToRemove:[],score:0}}}const Bo=s=>{const[e,n]=b.useState(()=>{const i=ie(s);return{board:i.initialBoard||[],score:0,moves:i.maxMoves,goals:i.goals,isGameOver:!1,isPaused:!1,currentStage:s,isAnimating:!1,selectedGem:null,comboCount:0}});b.useEffect(()=>{const i=ie(s);n({board:i.initialBoard||[],score:0,moves:i.maxMoves,goals:i.goals,isGameOver:!1,isPaused:!1,currentStage:s,isAnimating:!1,selectedGem:null,comboCount:0})},[s]);const o=b.useRef(null),r=b.useCallback((i,u)=>{n(h=>{var y,g;if(h.isGameOver)return h;const S=((y=h.selectedGem)==null?void 0:y.row)===i&&((g=h.selectedGem)==null?void 0:g.col)===u?null:{row:i,col:u};return o.current=S,{...h,selectedGem:S}})},[]),a=b.useCallback((i,u)=>{n(h=>{var Y;if(h.isGameOver||h.moves<=0)return h;const S=Math.abs(i.row-u.row),y=Math.abs(i.col-u.col);if(!(S===1&&y===0||S===0&&y===1))return h;const g=h.board.map(O=>O.map(F=>F?{...F}:null)),T=g[i.row][i.col],z=g[u.row][u.col];if(T&&z&&T.type!=="normal"&&z.type!=="normal"){const O=Go(T,z,g);if(O){const F=new Set;for(const B of O.positionsToRemove)F.add(`${B.row},${B.col}`);for(const B of F){const[I,st]=B.split(","),d=Number(I),yt=Number(st);!Number.isNaN(d)&&!Number.isNaN(yt)&&g[d]&&(g[d][yt]=null)}const ct=le(g,50),Ot=h.score+O.score,Tt=h.goals.map(B=>B.type==="score"?{...B,current:Math.min(B.current+O.score,B.target)}:B),vt=Gt(ct).length>0,dt=Tt.every(B=>B.current>=B.target),Ct=h.moves<=0&&!dt;return{...h,board:ct,score:Ot,goals:Tt,moves:h.moves-1,isAnimating:vt&&!dt&&!Ct,selectedGem:null,comboCount:0,isGameOver:Ct||h.isGameOver}}}const j=g[i.row][i.col];g[i.row][i.col]=g[u.row][u.col],g[u.row][u.col]=j,g[i.row][i.col]&&(g[i.row][i.col].position={...i}),g[u.row][u.col]&&(g[u.row][u.col].position={...u});const D=Gt(g);if(D.length===0)return h;const V=bo(D);for(const O of V){const F=(Y=g[O.position.row])==null?void 0:Y[O.position.col];F&&(F.type=O.type,O.stripedDirection&&(F.stripedDirection=O.stripedDirection))}return{...h,board:g,moves:h.moves-1,isAnimating:!0,selectedGem:null,comboCount:0}})},[]),l=b.useCallback(()=>{n(i=>{var dt,Ct;if(!i.isAnimating)return i;const u=Gt(i.board);if(u.length===0)return{...i,isAnimating:!1};const h=i.board.map(B=>B.map(I=>I?{...I}:null)),S=new Set;let y=0;const g=new Set;for(const B of u)for(const I of B.positions){const st=(dt=h[I.row])==null?void 0:dt[I.col];st&&st.type!=="normal"&&g.add(`${I.row},${I.col}`)}for(const B of g){const[I,st]=B.split(","),d=Number(I),yt=Number(st);if(!Number.isNaN(d)&&!Number.isNaN(yt)&&((Ct=h[d])!=null&&Ct[yt])){const At=h[d][yt],Et=Oo(At,h);for(const xt of Et.positionsToRemove)S.add(`${xt.row},${xt.col}`);y+=Et.score}}for(const B of u)for(const I of B.positions)S.add(`${I.row},${I.col}`);for(const B of S){const[I,st]=B.split(","),d=Number(I),yt=Number(st);!Number.isNaN(d)&&!Number.isNaN(yt)&&h[d]&&(h[d][yt]=null)}const T=le(h,50),j=Gt(T).length>0,D=j?i.comboCount+1:0,V=1+Math.min(D,5)*.15,Y=u.reduce((B,I)=>{const st=I.positions.length;let d=10;return st>=6?d=80:st>=5?d=40:st>=4&&(d=20),B+st*d},0),O=Y+y,F=Math.floor(O*(V-1)),ct=i.score+O+F,Ot=Y+y+F,Tt=i.goals.map(B=>B.type==="score"?{...B,current:Math.min(B.current+Ot,B.target)}:B),mt=Tt.every(B=>B.current>=B.target),vt=i.moves<=0&&!mt;return{...i,board:T,score:ct,goals:Tt,isGameOver:vt||i.isGameOver,isAnimating:j&&!mt&&!vt,comboCount:D}})},[]),f=b.useCallback(()=>{n(i=>({...i,isPaused:!i.isPaused}))},[]);return{gameState:e,selectGem:r,swapGems:a,processMatches:l,togglePause:f}};function ce(s){const{score:e,goals:n,moves:o,currentStage:r}=s;if(n.length===0)return 0;const a=n[0];if(a.current<a.target)return 0;const l=a.current/a.target,f=Math.max(20,50-Math.floor(r/20)),i=o/f,u=Math.min(e/(a.target*1.5),1);let h=0;return l>=1&&(h=1,(l>=1.2||i>=.4)&&(h=2),l>=1.5&&i>=.5&&u>=.8&&(h=3)),Math.min(h,3)}class Ao{constructor(e){Rt(this,"particles",[]);Rt(this,"ctx");this.ctx=e}emit(e,n,o,r=20){const a=It[o];for(let l=0;l<r;l++){const f=Math.PI*2*l/r+Math.random()*.5,i=2+Math.random()*3;this.particles.push({x:e,y:n,vx:Math.cos(f)*i,vy:Math.sin(f)*i,life:1,maxLife:1,color:Math.random()>.5?a.light:a.dark,size:3+Math.random()*4,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}emitExplosion(e,n,o,r=50,a=30){const l=It[o];for(let f=0;f<a;f++){const i=Math.random()*Math.PI*2,u=Math.random()*r,h=1+Math.random()*2;this.particles.push({x:e+Math.cos(i)*u*.3,y:n+Math.sin(i)*u*.3,vx:Math.cos(i)*h,vy:Math.sin(i)*h,life:1,maxLife:1,color:Math.random()>.5?l.light:l.dark,size:4+Math.random()*6,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.3})}}update(e=16){for(let n=this.particles.length-1;n>=0;n--){const o=this.particles[n];o.x+=o.vx,o.y+=o.vy,o.vy+=.1,o.vx*=.98,o.vy*=.98,o.rotation+=o.rotationSpeed,o.life-=e/1e3,o.life<=0&&this.particles.splice(n,1)}}render(){this.ctx.save();for(const e of this.particles){const n=e.life/e.maxLife,o=e.size*n;this.ctx.globalAlpha=n,this.ctx.fillStyle=e.color,this.ctx.translate(e.x,e.y),this.ctx.rotate(e.rotation),this.ctx.fillRect(-o/2,-o/2,o,o),this.ctx.setTransform(1,0,0,1,0,0)}this.ctx.globalAlpha=1,this.ctx.restore()}clear(){this.particles=[]}get count(){return this.particles.length}}function ue(s){var a,l,f,i;const e=s.length,n=((a=s[0])==null?void 0:a.length)||0,o=[],r=[];for(let u=0;u<e;u++)for(let h=0;h<n;h++){const S=(l=s[u])==null?void 0:l[h];if(S){if(h<n-1){const y=(f=s[u])==null?void 0:f[h+1];if(y&&y.color!==S.color){const g=fe(s,u,h,u,h+1),T=Gt(g);if(T.length>0){const z=T.some(D=>D.positions.length>=4),j={from:{row:u,col:h},to:{row:u,col:h+1}};z?o.push(j):r.push(j)}}}if(u<e-1){const y=(i=s[u+1])==null?void 0:i[h];if(y&&y.color!==S.color){const g=fe(s,u,h,u+1,h),T=Gt(g);if(T.length>0){const z=T.some(D=>D.positions.length>=4),j={from:{row:u,col:h},to:{row:u+1,col:h}};z?o.push(j):r.push(j)}}}}}return o.length>0?o[0]:r.length>0?r[0]:null}function fe(s,e,n,o,r){const a=s.map(f=>f.map(i=>i?{...i}:null)),l=a[e][n];return a[e][n]=a[o][r],a[o][r]=l,a}const Eo=({stageNumber:s=1,currentScreen:e="stageSelect",onNavigate:n,onStartStage:o})=>{const r=b.useRef(!1),a=b.useRef(null),l=b.useRef(null),f=b.useRef(null),i=b.useRef(null),u=b.useRef(null),h=b.useRef(null),S=b.useRef(new Map),y=b.useRef(null),g=b.useRef(!1),T=b.useRef(null),z=b.useRef(""),j=b.useRef(!1),D=b.useRef(null),V=b.useRef(null),Y=b.useRef(null),O=b.useRef(null),F=b.useRef(!1),ct=b.useRef(!1),Ot=b.useRef(!1),Tt=b.useRef(!1),[mt,vt]=b.useState(!1),{t:dt}=Dt(),[Ct,B]=b.useState(1),[I,st]=b.useState(1),{gameState:d,selectGem:yt,swapGems:At,processMatches:Et,togglePause:xt}=Bo(s),[rt,we]=b.useState(()=>{const m=ae.cols,G=ae.rows;return{aspectRatio:Se.aspectRatio,cellSize:50,gridRows:G,gridCols:m,pixelRatio:window.devicePixelRatio||1,logicalWidth:0,logicalHeight:0}});b.useEffect(()=>{var t;if(e==="game"&&d.board.length>0){const m=d.board.length,G=((t=d.board[0])==null?void 0:t.length)||9;we(M=>({...M,gridRows:m,gridCols:G}))}},[e,d.board,s]),b.useEffect(()=>{const t=localStorage.getItem("chipPuzzleGame_progress");if(t)try{const m=JSON.parse(t);B(Math.max(1,m.highestStage||1))}catch(m){console.error("Failed to load progress",m)}},[]);const Qt=b.useCallback((t,m,G)=>{const c=m/1200;t.fillStyle="#1a1a1a",t.fillRect(0,0,m,G),t.fillStyle="#fff";const nt=Math.max(16,32*c);t.font=`bold ${nt}px Arial`,t.textAlign="center",t.fillText(dt("stageSelect.title"),m/2,50*c);const w=8,ut=60,Mt=15,R=ut*c,pt=Mt*c,q=(m-(w*R+(w-1)*pt))/2,U=100*c,K=1e3,tt=50,at=Math.ceil(K/tt),et=(I-1)*tt+1,X=Math.min(et+tt-1,K);for(let v=0;v<tt&&et+v<=X;v++){const E=et+v,W=Math.floor(v/w),$=v%w,p=q+$*(R+pt),N=U+W*(R+pt),k=E<=Ct;if(k){const A=t.createLinearGradient(p,N,p+R,N+R);A.addColorStop(0,"#667eea"),A.addColorStop(1,"#764ba2"),t.fillStyle=A}else t.fillStyle="#1a1a1a";t.fillRect(p,N,R,R),t.strokeStyle=k?"#667eea":"#444",t.lineWidth=Math.max(1,2*c),t.strokeRect(p,N,R,R),t.fillStyle="#fff";const _=Math.max(12,20*c);if(t.font=`bold ${_}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText(E.toString(),p+R/2,N+R/2),!k){t.fillStyle="#ffa500";const A=Math.max(16,24*c);t.font=`${A}px Arial`,t.fillText("ðŸ”’",p+R/2,N+R/2-10*c)}}const it=G-60*c;t.fillStyle="#fff",t.font=`bold ${Math.max(12,18*c)}px Arial`,t.textAlign="center",t.fillText(`${dt("stageSelect.page")} ${I} / ${at}`,m/2,it);const J=30*c,ft=80*c,ht=it+20*c,kt=10*c;if(I>1){const v=m/2-ft-kt/2;t.fillStyle=I>1?"#667eea":"#444",t.fillRect(v,ht,ft,J),t.strokeStyle="#fff",t.lineWidth=Math.max(1,2*c),t.strokeRect(v,ht,ft,J),t.fillStyle="#fff",t.font=`bold ${Math.max(10,14*c)}px Arial`,t.fillText("Â«",v+ft/2,ht+J/2+4*c)}if(I<at){const v=m/2+kt/2;t.fillStyle=I<at?"#667eea":"#444",t.fillRect(v,ht,ft,J),t.strokeStyle="#fff",t.lineWidth=Math.max(1,2*c),t.strokeRect(v,ht,ft,J),t.fillStyle="#fff",t.font=`bold ${Math.max(10,14*c)}px Arial`,t.fillText("Â»",v+ft/2,ht+J/2+4*c)}},[Ct,dt,I]),te=b.useCallback((t,m,G)=>{const c=m/1200;t.fillStyle="#1a1a1a",t.fillRect(0,0,m,G);const w=(rt.cellSize||50)*c,ut=rt.gridCols||9,Mt=rt.gridRows||9,R=w*ut,pt=w*Mt,q=(m-R)/2,U=(G-pt)/2;(!f.current||i.current!==w)&&(f.current=new io(t,w),i.current=w),u.current||(u.current=new Ao(t)),t.save(),t.globalAlpha=.9,t.fillStyle="rgba(22, 22, 46, 0.8)",t.beginPath(),t.roundRect(q,U,R,pt,8*c),t.fill(),t.restore(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=Math.max(.5,1*c);for(let v=0;v<=Mt;v++){const E=U+v*w;t.beginPath(),t.moveTo(q,E),t.lineTo(q+R,E),t.stroke()}for(let v=0;v<=ut;v++){const E=q+v*w;t.beginPath(),t.moveTo(E,U),t.lineTo(E,U+pt),t.stroke()}const K=Math.max(10,20*c),tt=24*c,at=24*c,et=K+8*c,X=at,it=16*c,J=16*c,ft=280*c,ht=et*4+it*2;if(t.save(),t.globalAlpha=.9,t.fillStyle="rgba(15, 15, 30, 0.8)",t.beginPath(),t.roundRect(tt-it,at-it,ft,ht,J),t.fill(),t.strokeStyle="rgba(102, 126, 234, 0.3)",t.lineWidth=1*c,t.stroke(),t.restore(),t.textAlign="left",t.textBaseline="top",t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=4*c,t.shadowOffsetX=0,t.shadowOffsetY=2*c,t.font=`600 ${K}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillStyle="#ffffff",t.fillText(`Score: ${d.score.toLocaleString()}`,tt,X),t.fillStyle="rgba(255, 255, 255, 0.9)",t.fillText(`Moves: ${d.moves}`,tt,X+et),d.goals.length>0){const v=d.goals[0],E=v.current/v.target;t.fillStyle=E>=1?"#4ecdc4":"rgba(255, 255, 255, 0.9)",t.fillText(`Goal: ${v.current.toLocaleString()}/${v.target.toLocaleString()}`,tt,X+et*2)}if(d.comboCount>0&&(t.shadowColor="rgba(255, 217, 61, 0.6)",t.shadowBlur=12*c,t.font=`700 ${Math.max(14,24*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillStyle="#ffd93d",t.textAlign="left",t.fillText(`Combo x${d.comboCount}!`,tt,X+et*3),t.shadowColor="rgba(0, 0, 0, 0.5)",t.shadowBlur=4*c),t.shadowColor="transparent",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,!d.isGameOver&&!d.isAnimating){const W=20*c,$=10*c,p=Math.max(60,120*c),N=Math.max(24,40*c),k=Math.max(60,120*c),_=Math.max(24,40*c),A=m-p-W,H=W,C=12*c,x=t.createLinearGradient(A,H,A,H+N);x.addColorStop(0,mt?"#4ecdc4":"#667eea"),x.addColorStop(1,mt?"#44a08d":"#764ba2"),t.save(),t.beginPath(),t.roundRect(A,H,p,N,C),t.fillStyle=x,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=Math.max(1,1.5*c),t.stroke(),t.restore(),t.shadowColor=mt?"rgba(78, 205, 196, 0.4)":"rgba(102, 126, 234, 0.4)",t.shadowBlur=8*c,t.shadowOffsetX=0,t.shadowOffsetY=2*c,t.fillStyle="#ffffff";const ot=Math.max(10,16*c);t.font=`600 ${ot}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Hint",A+p/2,H+N/2),t.shadowColor="transparent",t.shadowBlur=0;const lt=A-k-$,bt=W,Q=t.createLinearGradient(lt,bt,lt,bt+_);d.isPaused?(Q.addColorStop(0,"#ff6b6b"),Q.addColorStop(1,"#ee5a6f")):(Q.addColorStop(0,"#667eea"),Q.addColorStop(1,"#764ba2")),t.save(),t.beginPath(),t.roundRect(lt,bt,k,_,C),t.fillStyle=Q,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=Math.max(1,1.5*c),t.stroke(),t.restore(),t.shadowColor=d.isPaused?"rgba(255, 107, 107, 0.4)":"rgba(102, 126, 234, 0.4)",t.shadowBlur=8*c,t.shadowOffsetX=0,t.shadowOffsetY=2*c,t.fillStyle="#ffffff";const St=Math.max(10,16*c);t.font=`600 ${St}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(d.isPaused?dt("game.resume"):dt("game.pause"),lt+k/2,bt+_/2),t.shadowColor="transparent",t.shadowBlur=0}if(d.isPaused&&!d.isGameOver){t.fillStyle="rgba(15, 15, 30, 0.85)",t.fillRect(0,0,m,G);const v=400*c,E=200*c,W=(m-v)/2,$=(G-E)/2,p=24*c;t.save(),t.globalAlpha=.95,t.fillStyle="rgba(26, 26, 46, 0.9)",t.beginPath(),t.roundRect(W,$,v,E,p),t.fill(),t.strokeStyle="rgba(102, 126, 234, 0.3)",t.lineWidth=2*c,t.stroke(),t.restore(),t.shadowColor="rgba(102, 126, 234, 0.5)",t.shadowBlur=12*c,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillStyle="#ffffff",t.font=`700 ${Math.max(28,56*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(dt("game.pause"),m/2,$+E/2-30*c),t.shadowColor="transparent",t.shadowBlur=0,t.fillStyle="rgba(255, 255, 255, 0.7)",t.font=`500 ${Math.max(14,20*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillText(dt("game.resume"),m/2,$+E/2+20*c)}if(d.isGameOver){t.fillStyle="rgba(15, 15, 30, 0.9)",t.fillRect(0,0,m,G);const v=450*c,E=300*c,W=(m-v)/2,$=(G-E)/2,p=24*c;t.save(),t.globalAlpha=.95,t.fillStyle="rgba(26, 26, 46, 0.9)",t.beginPath(),t.roundRect(W,$,v,E,p),t.fill(),t.strokeStyle="rgba(255, 107, 107, 0.3)",t.lineWidth=2*c,t.stroke(),t.restore(),t.shadowColor="rgba(255, 107, 107, 0.5)",t.shadowBlur=12*c,t.fillStyle="#ff6b6b",t.font=`700 ${Math.max(28,56*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Game Over!",m/2,$+60*c),t.shadowColor="transparent",t.shadowBlur=0,t.fillStyle="rgba(255, 255, 255, 0.9)",t.font=`600 ${Math.max(16,24*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillText(`Final Score: ${d.score.toLocaleString()}`,m/2,$+120*c);const N=m/2-110*c,k=$+180*c,_=220*c,A=56*c,H=14*c,C=t.createLinearGradient(N,k,N,k+A);C.addColorStop(0,"#ff6b6b"),C.addColorStop(1,"#ee5a6f"),t.save(),t.beginPath(),t.roundRect(N,k,_,A,H),t.fillStyle=C,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2*c,t.stroke(),t.restore(),t.shadowColor="rgba(255, 107, 107, 0.4)",t.shadowBlur=8*c,t.shadowOffsetX=0,t.shadowOffsetY=2*c,t.fillStyle="#ffffff",t.font=`600 ${Math.max(16,22*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Retry",m/2,k+A/2),t.shadowColor="transparent",t.shadowBlur=0}const kt=d.goals.every(v=>v.current>=v.target);if(d.isAnimating){const v=Gt(d.board),E=new Set;for(const W of v)for(const $ of W.positions)E.add(`${$.row},${$.col}`);E.forEach(W=>{const[$,p]=W.split(","),N=Number($),k=Number(p);if(!Number.isNaN(N)&&!Number.isNaN(k)&&N>=0&&N<Mt&&k>=0&&k<ut){const _=q+k*w,A=U+N*w,H=Date.now()%1e3,C=.3+Math.sin(H/1e3*Math.PI*2)*.2;t.fillStyle=`rgba(255, 215, 61, ${C})`,t.strokeStyle="#ffd93d",t.lineWidth=Math.max(2,3*c),t.strokeRect(_,A,w,w),t.fillRect(_,A,w,w)}})}if(d.board&&d.board.length>0&&f.current){let v=!1;d.board.forEach((W,$)=>{W&&W.forEach((p,N)=>{if(p){const k=q+N*w,_=U+$*w;if(F.current&&D.current&&Y.current&&V.current){const C=D.current,x=Y.current,ot=V.current;if($===C.row&&N===C.col)if(O.current){const lt=O.current.x-ot.x,bt=O.current.y-ot.y,Q=w,St=Math.max(-Q,Math.min(Q,lt)),Nt=Math.max(-Q,Math.min(Q,bt));p.x=k+St,p.y=_+Nt}else p.x=k,p.y=_;else if($===x.row&&N===x.col)if(O.current){const lt=O.current.x-ot.x,bt=O.current.y-ot.y,Q=w,St=Math.max(-Q,Math.min(Q,-lt)),Nt=Math.max(-Q,Math.min(Q,-bt));p.x=k+St,p.y=_+Nt}else p.x=k,p.y=_;else p.x=k,p.y=_}else if(p.targetY!==void 0){v=!0;let C;p.targetY<100?C=U+p.targetY*w:C=p.targetY,(p.y===void 0||p.y===0)&&(p.y=_);const x=C-p.y,ot=.15;Math.abs(x)>1?(p.y+=x*ot,x>0&&(p.y+=1)):(p.y=C,p.targetY=void 0),p.x=k}else if(p.targetX!==void 0){const C=p.targetX-p.x,x=.2;Math.abs(C)>.1?p.x+=C*x:(p.x=p.targetX,p.targetX=void 0),p.y=_}else(p.x===0&&p.y===0&&p.targetX===void 0&&p.targetY===void 0||p.x!==k||p.y!==_)&&(p.x=k,p.y=_);d.selectedGem&&d.selectedGem.row===$&&d.selectedGem.col===N&&(t.fillStyle="rgba(255, 255, 255, 0.3)",t.strokeStyle="rgba(255, 255, 255, 0.8)",t.lineWidth=Math.max(2,3*c),t.strokeRect(k,_,w,w),t.fillRect(k,_,w,w)),mt&&y.current&&(y.current.from.row===$&&y.current.from.col===N||y.current.to.row===$&&y.current.to.col===N)&&(t.fillStyle="rgba(255, 215, 61, 0.4)",t.strokeStyle="#ffd93d",t.lineWidth=Math.max(3,4*c),t.strokeRect(k,_,w,w),t.fillRect(k,_,w,w));let A=1,H=p.scale||1;if(p.isRemoving){let C=S.current.get(p.id);C||(C={alpha:1,scale:1},S.current.set(p.id,C)),C.alpha=Math.max(0,C.alpha-.08),C.scale=Math.max(0,C.scale-.08),A=C.alpha,H=C.scale,p.alpha=A,p.scale=H,S.current.set(p.id,C)}else p.alpha=1,p.scale=1;if(A>0){const C=kt&&!d.isAnimating?A*.3:A;f.current.render(p,C)}if(p.isRemoving&&A>.8&&A<.9&&u.current){const C=p.x+w/2,x=p.y+w/2;u.current.emit(C,x,p.color,15)}}})});const E=g.current;g.current=v,E&&!v&&d.isAnimating&&e==="game"&&!d.isGameOver&&!j.current&&setTimeout(()=>{d.isAnimating&&e==="game"&&!d.isGameOver&&!j.current&&(j.current=!0,Et(),setTimeout(()=>{j.current=!1,z.current=""},200))},100)}if(u.current&&(u.current.update(16),u.current.render()),kt&&!d.isAnimating&&!d.isGameOver){const v=ce(d);t.fillStyle="rgba(15, 15, 30, 0.92)",t.fillRect(0,0,m,G);const E=500*c,W=400*c,$=(m-E)/2,p=(G-W)/2,N=28*c;t.save(),t.globalAlpha=.96,t.fillStyle="rgba(26, 26, 46, 0.9)",t.beginPath(),t.roundRect($,p,E,W,N),t.fill(),t.strokeStyle="rgba(78, 205, 196, 0.4)",t.lineWidth=2*c,t.stroke(),t.restore(),t.shadowColor="rgba(78, 205, 196, 0.5)",t.shadowBlur=12*c,t.shadowOffsetX=0,t.shadowOffsetY=0,t.fillStyle="#4ecdc4",t.font=`700 ${Math.max(32,64*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Stage Cleared!",m/2,p+80*c);const k=Math.max(24,48*c),_=k*1.8,A=m/2-_,H=p+160*c;for(let St=0;St<3;St++){const Nt=A+St*_;t.shadowColor=St<v?"rgba(255, 217, 61, 0.6)":"transparent",t.shadowBlur=St<v?12*c:0,t.fillStyle=St<v?"#ffd93d":"rgba(102, 102, 102, 0.5)",t.font=`${k}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText("â˜…",Nt,H)}t.shadowColor="transparent",t.shadowBlur=0,t.fillStyle="rgba(255, 255, 255, 0.9)",t.font=`600 ${Math.max(18,28*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.fillText(`Score: ${d.score.toLocaleString()}`,m/2,p+220*c);const C=m/2-120*c,x=p+280*c,ot=240*c,lt=60*c,bt=16*c,Q=t.createLinearGradient(C,x,C,x+lt);Q.addColorStop(0,"#667eea"),Q.addColorStop(1,"#764ba2"),t.save(),t.beginPath(),t.roundRect(C,x,ot,lt,bt),t.fillStyle=Q,t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=2*c,t.stroke(),t.restore(),t.shadowColor="rgba(102, 126, 234, 0.4)",t.shadowBlur=8*c,t.shadowOffsetX=0,t.shadowOffsetY=2*c,t.fillStyle="#ffffff",t.font=`600 ${Math.max(16,22*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("Next Stage",m/2,x+lt/2),t.shadowColor="transparent",t.shadowBlur=0}},[rt,d,mt]),Pt=b.useCallback(()=>{const t=a.current,m=l.current;if(!t||!m)return;const G=window.devicePixelRatio||1,M=t.width/G,c=t.height/G;M===0||c===0||(e==="stageSelect"?Qt(m,M,c):e==="game"?te(m,M,c):(m.fillStyle="#1a1a1a",m.fillRect(0,0,M,c)))},[e,Qt,te]);b.useEffect(()=>{let t=0;const G=1e3/60,M=()=>{const c=nt=>{nt-t>=G&&(Pt(),t=nt),h.current=requestAnimationFrame(c)};h.current=requestAnimationFrame(c)};return a.current&&l.current&&M(),()=>{h.current!==null&&(cancelAnimationFrame(h.current),h.current=null)}},[Pt]);const ve=b.useCallback((t,m)=>{r.current||(r.current=!0,a.current=t,l.current=m,Pt())},[Pt]),Ce=b.useCallback((t,m)=>{a.current=t,l.current=m,Pt()},[Pt]);b.useEffect(()=>{if(a.current&&l.current){const t=setTimeout(()=>{Pt()},10);return()=>clearTimeout(t)}},[Pt,e,Ct,s,d]),b.useEffect(()=>{if(d.isAnimating&&e==="game"&&!d.isGameOver&&!j.current){const t=JSON.stringify(d.board);if(t!==z.current)return j.current=!0,z.current=t,T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{const G=()=>{g.current?setTimeout(G,50):(Et(),setTimeout(()=>{j.current=!1,z.current=""},200))};G()},300),()=>{T.current&&(clearTimeout(T.current),T.current=null)}}else d.isAnimating||(z.current="",j.current=!1)},[d.isAnimating,d.board,Et,e,d.isGameOver]),b.useEffect(()=>{if(e!=="game"){Ot.current=!1,Tt.current=!1;return}const t=d.goals.every(m=>m.current>=m.target);if(!Ot.current&&d.isGameOver&&(console.log("Game Over!",d.score),gt.playGameOver()),!Tt.current&&t&&!d.isGameOver){console.log("Stage Cleared!",d.score),gt.playStageClear();try{const m=ce(d),G=localStorage.getItem("chipPuzzleGame_progress");let M={highestStage:1,stageRecords:{}};if(G)try{M=JSON.parse(G)}catch(ut){console.error("Failed to parse progress",ut)}const c=d.currentStage;c>=M.highestStage&&(M.highestStage=c+1),M.stageRecords||(M.stageRecords={});const nt=c.toString(),w=M.stageRecords[nt];!w||d.score>w.bestScore?M.stageRecords[nt]={stageNumber:c,stars:Math.max((w==null?void 0:w.stars)||0,m),score:d.score,bestScore:d.score,completedAt:new Date().toISOString(),attempts:((w==null?void 0:w.attempts)||0)+1}:M.stageRecords[nt]={...w,stars:Math.max(w.stars,m),attempts:w.attempts+1},localStorage.setItem("chipPuzzleGame_progress",JSON.stringify(M))}catch(m){console.error("Failed to save progress",m)}}Ot.current=d.isGameOver,Tt.current=t},[d.isGameOver,d.goals,d.score,d.currentStage,e]);const Xt=b.useCallback(t=>{if(ct.current){ct.current=!1;return}const m=a.current;if(!m)return;const G=m.getBoundingClientRect(),M=t.clientX-G.left,c=t.clientY-G.top,nt=window.devicePixelRatio||1,w=m.width/nt,ut=m.height/nt;if(e==="stageSelect"){if(!o)return;const R=w/1200,pt=120,q=40,U=20*R,K=Math.max(60,pt*R),tt=Math.max(24,q*R),at=w-K-U,et=U;if(M>=at&&M<=at+K&&c>=et&&c<=et+tt){if(mt)vt(!1),y.current=null;else{const x=ue(d.board);x&&(y.current=x,vt(!0),setTimeout(()=>{vt(!1),y.current=null},3e3))}return}const X=50,it=1e3,J=Math.ceil(it/X),ft=30*R,ht=80*R,v=ut-60*R+20*R,E=10*R;if(I>1){const x=w/2-ht-E/2;if(M>=x&&M<=x+ht&&c>=v&&c<=v+ft){st(I-1),gt.playClick();return}}if(I<J){const x=w/2+E/2;if(M>=x&&M<=x+ht&&c>=v&&c<=v+ft){st(I+1),gt.playClick();return}}const W=8,$=60,p=15,N=$*R,k=p*R,_=(w-(W*N+(W-1)*k))/2,A=100*R,H=Math.floor((M-_)/(N+k)),C=Math.floor((c-A)/(N+k));if(H>=0&&H<W&&C>=0){const ot=(I-1)*X+1+C*W+H;ot<=Ct&&ot<=it&&o(ot)}}else if(e==="game"){const R=w/1200;if(d.goals.every(C=>C.current>=C.target)&&!d.isAnimating&&!d.isGameOver){const C=w/2-100*R,x=ut/2+80*R,ot=200*R,lt=50*R;if(M>=C&&M<=C+ot&&c>=x&&c<=x+lt){if(o){const bt=s+1;o(bt)}gt.playClick();return}return}if(d.isGameOver){const C=w/2-100*R,x=ut/2+100*R,ot=200*R,lt=50*R;if(M>=C&&M<=C+ot&&c>=x&&c<=x+lt){o&&o(s),gt.playClick();return}return}if(d.isPaused){xt(),gt.playClick();return}const q=120,U=40,K=20*R,tt=10*R,at=Math.max(60,q*R),et=Math.max(24,U*R),X=Math.max(60,q*R),it=Math.max(24,U*R),J=w-at-K,ft=K,ht=J-X-tt,kt=K;if(M>=ht&&M<=ht+X&&c>=kt&&c<=kt+it){xt(),gt.playClick();return}if(M>=J&&M<=J+at&&c>=ft&&c<=ft+et){if(mt)vt(!1),y.current=null;else{const C=ue(d.board);C&&(y.current=C,vt(!0),setTimeout(()=>{vt(!1),y.current=null},3e3))}gt.playClick();return}if(d.isPaused)return;const E=(rt.cellSize||50)*R,W=rt.gridCols||9,$=rt.gridRows||9,p=E*W,N=E*$,k=(w-p)/2,_=(ut-N)/2,A=Math.floor((M-k)/E),H=Math.floor((c-_)/E);A>=0&&A<W&&H>=0&&H<$&&d.board[H]&&d.board[H][A]&&(d.selectedGem?At(d.selectedGem,{row:H,col:A}):yt(H,A),gt.playClick())}},[e,o,Ct,rt,d,yt,At,mt,xt]),Ht=b.useCallback(t=>{const m=a.current;if(!m||e!=="game"||d.isPaused)return;const G=m.getBoundingClientRect(),M=t.clientX-G.left,c=t.clientY-G.top,nt=window.devicePixelRatio||1,w=m.width/nt,ut=m.height/nt,R=w/1200,q=(rt.cellSize||50)*R,U=rt.gridCols||9,K=rt.gridRows||9,tt=q*U,at=q*K,et=(w-tt)/2,X=(ut-at)/2,it=Math.floor((M-et)/q),J=Math.floor((c-X)/q);it>=0&&it<U&&J>=0&&J<K&&d.board[J]&&d.board[J][it]&&(D.current={row:J,col:it},V.current={x:M,y:c},F.current=!0)},[e,rt,d.board,d.isPaused]),Ut=b.useCallback(t=>{const m=a.current;if(!m||e!=="game"||d.isPaused||!F.current||!D.current||!V.current)return;const G=m.getBoundingClientRect(),M=t.clientX-G.left,c=t.clientY-G.top,nt=window.devicePixelRatio||1,Mt=m.width/nt/1200,R=rt.gridCols||9,pt=rt.gridRows||9,q=V.current,U=M-q.x,K=c-q.y,tt=Math.sqrt(U*U+K*K),at=10*Mt;if(tt<at){O.current={x:M,y:c},Y.current=null;return}const et=D.current;let X={row:et.row,col:et.col};if(Math.abs(U)>Math.abs(K)?U>0?X.col+=1:X.col-=1:K>0?X.row+=1:X.row-=1,X.col<0||X.col>=R||X.row<0||X.row>=pt){F.current=!1,D.current=null,V.current=null,Y.current=null,O.current=null;return}O.current={x:M,y:c},Y.current=X},[e,rt,d.isPaused]),Bt=b.useCallback(()=>{if(F.current&&D.current&&Y.current){const t=D.current,m=Y.current,G=Math.abs(t.row-m.row),M=Math.abs(t.col-m.col);(G===1&&M===0||G===0&&M===1)&&(At(t,m),gt.playClick(),ct.current=!0)}F.current=!1,D.current=null,V.current=null,Y.current=null,O.current=null},[At]);return b.useEffect(()=>{const t=a.current;if(t)return t.addEventListener("click",Xt),()=>{t.removeEventListener("click",Xt)}},[Xt]),b.useEffect(()=>{const t=a.current;if(t)return t.addEventListener("pointerdown",Ht),t.addEventListener("pointermove",Ut),t.addEventListener("pointerup",Bt),t.addEventListener("pointerleave",Bt),t.addEventListener("pointercancel",Bt),()=>{t.removeEventListener("pointerdown",Ht),t.removeEventListener("pointermove",Ut),t.removeEventListener("pointerup",Bt),t.removeEventListener("pointerleave",Bt),t.removeEventListener("pointercancel",Bt)}},[Ht,Ut,Bt]),P.jsx("div",{className:"game-board",children:P.jsx(ao,{config:rt,onReady:ve,onResize:Ce})})};const xo=()=>{const[s,e]=b.useState("stageSelect"),[n,o]=b.useState(null),r=l=>{e(l)},a=l=>{o(l),e("game")};return P.jsx(Ve,{children:P.jsxs("div",{className:"app-container",children:[P.jsx(oo,{onNavigate:r,currentScreen:s}),P.jsx(ro,{children:P.jsx(Eo,{stageNumber:n||1,currentScreen:s,onNavigate:r,onStartStage:a})}),P.jsx(so,{})]})})};Jt.createRoot(document.getElementById("root")).render(P.jsx($t.StrictMode,{children:P.jsx(jt,{children:P.jsx(xo,{})})}));
