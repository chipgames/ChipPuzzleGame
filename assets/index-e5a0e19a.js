var me=Object.defineProperty;var ye=(r,t,o)=>t in r?me(r,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[t]=o;var gt=(r,t,o)=>(ye(r,typeof t!="symbol"?t+"":t,o),o);import{r as S,a as Se,g as be,R as Ot}from"./vendor-57209f9c.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&e(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();var ie={exports:{}},jt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ve=S,we=Symbol.for("react.element"),xe=Symbol.for("react.fragment"),Ce=Object.prototype.hasOwnProperty,Re=ve.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Te={key:!0,ref:!0,__self:!0,__source:!0};function ae(r,t,o){var e,n={},s=null,c=null;o!==void 0&&(s=""+o),t.key!==void 0&&(s=""+t.key),t.ref!==void 0&&(c=t.ref);for(e in t)Ce.call(t,e)&&!Te.hasOwnProperty(e)&&(n[e]=t[e]);if(r&&r.defaultProps)for(e in t=r.defaultProps,t)n[e]===void 0&&(n[e]=t[e]);return{$$typeof:we,type:r,key:s,ref:c,props:n,_owner:Re.current}}jt.Fragment=xe;jt.jsx=ae;jt.jsxs=ae;ie.exports=jt;var M=ie.exports,Ht={},Kt=Se;Ht.createRoot=Kt.createRoot,Ht.hydrateRoot=Kt.hydrateRoot;var ce={exports:{}},Me="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",ke=Me,Ge=ke;function le(){}function ue(){}ue.resetWarningCache=le;var Ae=function(){function r(e,n,s,c,l,a){if(a!==Ge){var u=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw u.name="Invariant Violation",u}}r.isRequired=r;function t(){return r}var o={array:r,bigint:r,bool:r,func:r,number:r,object:r,string:r,symbol:r,any:r,arrayOf:t,element:r,elementType:r,instanceOf:t,node:r,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:ue,resetWarningCache:le};return o.PropTypes=o,o};ce.exports=Ae();var Ee=ce.exports;const A=be(Ee);function Pe(r,t){r.prototype=Object.create(t.prototype),r.prototype.constructor=r,Ut(r,t)}function Ut(r,t){return Ut=Object.setPrototypeOf||function(o,e){return o.__proto__=e,o},Ut(r,t)}var H={BASE:"base",BODY:"body",HEAD:"head",HTML:"html",LINK:"link",META:"meta",NOSCRIPT:"noscript",SCRIPT:"script",STYLE:"style",TITLE:"title",FRAGMENT:"Symbol(react.fragment)"},Oe={rel:["amphtml","canonical","alternate"]},Le={type:["application/ld+json"]},Be={charset:"",name:["robots","description"],property:["og:type","og:title","og:url","og:image","og:image:alt","og:description","twitter:url","twitter:title","twitter:description","twitter:image","twitter:image:alt","twitter:card","twitter:site"]};Object.keys(H).map(function(r){return H[r]});var Nt={accesskey:"accessKey",charset:"charSet",class:"className",contenteditable:"contentEditable",contextmenu:"contextMenu","http-equiv":"httpEquiv",itemprop:"itemProp",tabindex:"tabIndex"};Object.keys(Nt).reduce(function(r,t){return r[Nt[t]]=t,r},{});var _e=function(r){return Array.isArray(r)?r.join(""):r},Yt=function(r,t){return Array.isArray(r)?r.reduce(function(o,e){return function(n,s){for(var c=Object.keys(n),l=0;l<c.length;l+=1)if(s[c[l]]&&s[c[l]].includes(n[c[l]]))return!0;return!1}(e,t)?o.priority.push(e):o.default.push(e),o},{priority:[],default:[]}):{default:r}},Ne=[H.NOSCRIPT,H.SCRIPT,H.STYLE],Ft=function(r,t){return t===void 0&&(t=!0),t===!1?String(r):String(r).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")},Jt=function(r){return Object.keys(r).reduce(function(t,o){var e=r[o]!==void 0?o+'="'+r[o]+'"':""+o;return t?t+" "+e:e},"")},Zt=function(r,t){return t===void 0&&(t={}),Object.keys(r).reduce(function(o,e){return o[Nt[e]||e]=r[e],o},t)},_t=function(r,t){return t.map(function(o,e){var n,s=((n={key:e})["data-rh"]=!0,n);return Object.keys(o).forEach(function(c){var l=Nt[c]||c;l==="innerHTML"||l==="cssText"?s.dangerouslySetInnerHTML={__html:o.innerHTML||o.cssText}:s[l]=o[c]}),Ot.createElement(r,s)})},ut=function(r,t,o){switch(r){case H.TITLE:return{toComponent:function(){return n=t.titleAttributes,(s={key:e=t.title})["data-rh"]=!0,c=Zt(n,s),[Ot.createElement(H.TITLE,c,e)];var e,n,s,c},toString:function(){return function(e,n,s,c){var l=Jt(s),a=_e(n);return l?"<"+e+' data-rh="true" '+l+">"+Ft(a,c)+"</"+e+">":"<"+e+' data-rh="true">'+Ft(a,c)+"</"+e+">"}(r,t.title,t.titleAttributes,o)}};case"bodyAttributes":case"htmlAttributes":return{toComponent:function(){return Zt(t)},toString:function(){return Jt(t)}};default:return{toComponent:function(){return _t(r,t)},toString:function(){return function(e,n,s){return n.reduce(function(c,l){var a=Object.keys(l).filter(function(g){return!(g==="innerHTML"||g==="cssText")}).reduce(function(g,b){var m=l[b]===void 0?b:b+'="'+Ft(l[b],s)+'"';return g?g+" "+m:m},""),u=l.innerHTML||l.cssText||"",f=Ne.indexOf(e)===-1;return c+"<"+e+' data-rh="true" '+a+(f?"/>":">"+u+"</"+e+">")},"")}(r,t,o)}}}},je=function(r){var t=r.baseTag,o=r.bodyAttributes,e=r.encode,n=r.htmlAttributes,s=r.noscriptTags,c=r.styleTags,l=r.title,a=l===void 0?"":l,u=r.titleAttributes,f=r.linkTags,g=r.metaTags,b=r.scriptTags,m={toComponent:function(){},toString:function(){return""}};if(r.prioritizeSeoTags){var x=function(W){var Y=W.linkTags,$=W.scriptTags,K=W.encode,L=Yt(W.metaTags,Be),k=Yt(Y,Oe),B=Yt($,Le);return{priorityMethods:{toComponent:function(){return[].concat(_t(H.META,L.priority),_t(H.LINK,k.priority),_t(H.SCRIPT,B.priority))},toString:function(){return ut(H.META,L.priority,K)+" "+ut(H.LINK,k.priority,K)+" "+ut(H.SCRIPT,B.priority,K)}},metaTags:L.default,linkTags:k.default,scriptTags:B.default}}(r);m=x.priorityMethods,f=x.linkTags,g=x.metaTags,b=x.scriptTags}return{priority:m,base:ut(H.BASE,t,e),bodyAttributes:ut("bodyAttributes",o,e),htmlAttributes:ut("htmlAttributes",n,e),link:ut(H.LINK,f,e),meta:ut(H.META,g,e),noscript:ut(H.NOSCRIPT,s,e),script:ut(H.SCRIPT,b,e),style:ut(H.STYLE,c,e),title:ut(H.TITLE,{title:a,titleAttributes:u},e)}},Bt=[],$e=function(r,t){var o=this;t===void 0&&(t=typeof document<"u"),this.instances=[],this.value={setHelmet:function(e){o.context.helmet=e},helmetInstances:{get:function(){return o.canUseDOM?Bt:o.instances},add:function(e){(o.canUseDOM?Bt:o.instances).push(e)},remove:function(e){var n=(o.canUseDOM?Bt:o.instances).indexOf(e);(o.canUseDOM?Bt:o.instances).splice(n,1)}}},this.context=r,this.canUseDOM=t,t||(r.helmet=je({baseTag:[],bodyAttributes:{},encodeSpecialCharacters:!0,htmlAttributes:{},linkTags:[],metaTags:[],noscriptTags:[],scriptTags:[],styleTags:[],title:"",titleAttributes:{}}))},ze=Ot.createContext({}),Ie=A.shape({setHelmet:A.func,helmetInstances:A.shape({get:A.func,add:A.func,remove:A.func})}),De=typeof document<"u",Et=function(r){function t(o){var e;return(e=r.call(this,o)||this).helmetData=new $e(e.props.context,t.canUseDOM),e}return Pe(t,r),t.prototype.render=function(){return Ot.createElement(ze.Provider,{value:this.helmetData.value},this.props.children)},t}(S.Component);Et.canUseDOM=De,Et.propTypes={context:A.shape({helmet:A.shape()}),children:A.node.isRequired},Et.defaultProps={context:{}},Et.displayName="HelmetProvider";Ie.isRequired;A.object,A.object,A.oneOfType([A.arrayOf(A.node),A.node]),A.string,A.bool,A.bool,A.object,A.arrayOf(A.object),A.arrayOf(A.object),A.arrayOf(A.object),A.func,A.arrayOf(A.object),A.arrayOf(A.object),A.string,A.object,A.string,A.bool,A.object;class We extends S.Component{constructor(){super(...arguments);gt(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(o){return{hasError:!0,error:o}}componentDidCatch(o,e){console.error("Uncaught error:",o,e)}render(){return this.state.hasError?this.props.fallback||M.jsxs("div",{className:"error-boundary",children:[M.jsx("h2",{children:"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"}),M.jsx("p",{children:"ê²Œìž„ì„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”."}),M.jsx("button",{onClick:()=>window.location.reload(),children:"ìƒˆë¡œê³ ì¹¨"})]}):this.props.children}}const Ye="modulepreload",Fe=function(r){return"/ChipPuzzleGame/"+r},Qt={},At=function(t,o,e){if(!o||o.length===0)return t();const n=document.getElementsByTagName("link");return Promise.all(o.map(s=>{if(s=Fe(s),s in Qt)return;Qt[s]=!0;const c=s.endsWith(".css"),l=c?'[rel="stylesheet"]':"";if(!!e)for(let f=n.length-1;f>=0;f--){const g=n[f];if(g.href===s&&(!c||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${s}"]${l}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":Ye,c||(u.as="script",u.crossOrigin=""),u.href=s,document.head.appendChild(u),c)return new Promise((f,g)=>{u.addEventListener("load",f),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${s}`)))})})).then(()=>t()).catch(s=>{const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s})},Xe=(r,t)=>{const o=r[t];return o?typeof o=="function"?o():Promise.resolve(o):new Promise((e,n)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(n.bind(null,new Error("Unknown variable dynamic import: "+t)))})},fe=["en","ko","zh","ja"],He="en",Ue={en:"English",ko:"í•œêµ­ì–´",zh:"ä¸­æ–‡",ja:"æ—¥æœ¬èªž"};class te{constructor(){gt(this,"supportedLanguages",fe);gt(this,"defaultLanguage",He)}detectBrowserLanguage(){const t=navigator.language.split("-")[0];return this.supportedLanguages.includes(t)?t:this.defaultLanguage}getStoredLanguage(){try{return localStorage.getItem("language")}catch(t){return console.error("Failed to get stored language:",t),null}}setLanguage(t){if(this.supportedLanguages.includes(t))try{localStorage.setItem("language",t),window.dispatchEvent(new CustomEvent("languageChanged",{detail:t}))}catch(o){console.error("Failed to set language:",o)}}getCurrentLanguage(){const t=this.getStoredLanguage();return t&&this.supportedLanguages.includes(t)?t:this.detectBrowserLanguage()}}const Xt={},$t=()=>{const[r,t]=S.useState(()=>new te().getCurrentLanguage()),[o,e]=S.useState(null),[n,s]=S.useState(!0);return S.useEffect(()=>{(async()=>{s(!0);try{if(Xt[r]){e(Xt[r]),s(!1);return}const f=await Xe(Object.assign({"../locales/en.json":()=>At(()=>import("./en-dc026abe.js"),[]),"../locales/ja.json":()=>At(()=>import("./ja-9edf1ecc.js"),[]),"../locales/ko.json":()=>At(()=>import("./ko-eb5241b8.js"),[]),"../locales/zh.json":()=>At(()=>import("./zh-6b456ba4.js"),[])}),`../locales/${r}.json`);Xt[r]=f.default,e(f.default)}catch(f){console.error(`Failed to load translations for ${r}:`,f);try{const g=await At(()=>import("./en-dc026abe.js"),[]);e(g.default)}catch(g){console.error("Failed to load fallback translations:",g)}}finally{s(!1)}})();const u=f=>{t(f.detail)};return window.addEventListener("languageChanged",u),()=>{window.removeEventListener("languageChanged",u)}},[r]),{language:r,setLanguage:a=>{new te().setLanguage(a)},t:a=>{if(n||!o)return a;const u=a.split(".");let f=o;for(const g of u)if(f=f==null?void 0:f[g],f===void 0)break;return f||a},isLoading:n}},he=()=>{const{language:r,setLanguage:t}=$t();return M.jsx("select",{value:r,onChange:o=>t(o.target.value),className:"language-selector","aria-label":"Language selector",children:fe.map(o=>M.jsx("option",{value:o,children:Ue[o]},o))})};class qe{constructor(){gt(this,"audioCtx",null);gt(this,"enabled",!0)}getContext(){if(!this.enabled)return null;try{if(!this.audioCtx){const t=window.AudioContext||window.webkitAudioContext;if(!t)return console.warn("Web Audio API is not supported in this browser."),this.enabled=!1,null;this.audioCtx=new t}return this.audioCtx}catch(t){return console.warn("Failed to initialize AudioContext",t),this.enabled=!1,null}}setEnabled(t){this.enabled=t}playTone(t,o,e="sine",n=.2){const s=this.getContext();if(!s)return;const c=s.createOscillator(),l=s.createGain();c.type=e,c.frequency.value=t,l.gain.value=n,c.connect(l),l.connect(s.destination);const a=s.currentTime;c.start(a),c.stop(a+o),l.gain.setValueAtTime(n,a),l.gain.linearRampToValueAtTime(0,a+o)}playClick(){this.playTone(440,.08,"square",.15)}playMatch(){this.playTone(660,.12,"triangle",.2)}playSpecial(){this.playTone(880,.16,"sawtooth",.22)}playStageClear(){this.getContext()&&(this.playTone(880,.15,"triangle",.22),setTimeout(()=>{this.playTone(1046.5,.18,"triangle",.22)},120))}playGameOver(){const t=this.getContext();if(!t)return;const o=440,e=220,n=.4,s=t.createOscillator(),c=t.createGain();s.type="sawtooth",s.frequency.setValueAtTime(o,t.currentTime),s.frequency.exponentialRampToValueAtTime(e,t.currentTime+n),c.gain.value=.22,c.gain.setValueAtTime(.22,t.currentTime),c.gain.linearRampToValueAtTime(0,t.currentTime+n),s.connect(c),c.connect(t.destination),s.start(t.currentTime),s.stop(t.currentTime+n)}}const yt=new qe;const Ve=({onNavigate:r,currentScreen:t})=>{const{t:o}=$t(),[e,n]=S.useState(()=>{const a=localStorage.getItem("chipPuzzleGame_soundEnabled");return a!==null?JSON.parse(a):!0});S.useEffect(()=>{yt.setEnabled(e),localStorage.setItem("chipPuzzleGame_soundEnabled",JSON.stringify(e))},[e]);const s=a=>{r&&r(a)},c=()=>{n(!e),e||yt.playClick()},l=!1;return M.jsx("header",{className:"header",children:M.jsxs("div",{className:"header-content",children:[M.jsxs("div",{className:"header-left",children:[l,M.jsx("div",{className:"header-logo",onClick:()=>s("stageSelect"),style:{cursor:"pointer"},children:o("header.logo")})]}),M.jsxs("nav",{className:"header-nav",children:[M.jsx("button",{className:"header-nav-button",onClick:()=>s("stageSelect"),children:o("header.playGame")}),M.jsx("button",{className:"header-nav-button",onClick:()=>s("guide"),children:o("header.guide")}),M.jsx("button",{className:"header-nav-button",onClick:()=>s("help"),children:o("header.help")})]}),M.jsxs("div",{className:"header-right",children:[M.jsx("button",{className:"header-sound-button",onClick:c,title:o(e?"header.soundOff":"header.soundOn"),children:e?"ðŸ”Š":"ðŸ”‡"}),M.jsx(he,{})]})]})})};const Ke=()=>{const{t:r}=$t();return M.jsx("footer",{className:"footer",children:M.jsxs("div",{className:"footer-content",children:[M.jsxs("div",{className:"footer-links",children:[M.jsx("a",{href:"#privacy",children:r("footer.privacyPolicy")}),M.jsx("a",{href:"#contact",children:r("footer.contactUs")})]}),M.jsx(he,{}),M.jsx("div",{className:"footer-copyright",children:r("footer.copyright")})]})})};const Je=({children:r})=>M.jsx("div",{className:"game-container",children:r}),de={aspectRatio:16/9,gridRows:9,gridCols:9,pixelRatio:window.devicePixelRatio||1};const Ze=({config:r,onReady:t,onResize:o})=>{const e=S.useRef(null),n=S.useRef(null),s=S.useRef(t),c=S.useRef(o),l=S.useRef(!1);return S.useEffect(()=>{s.current=t},[t]),S.useEffect(()=>{c.current=o},[o]),S.useEffect(()=>{const a=e.current,u=n.current;if(!a||!u)return;const f=a.getContext("2d");if(!f){console.error("Failed to get 2D context");return}const g=()=>{const m=window.devicePixelRatio||1,x=u.clientWidth,W=u.clientHeight,Y=r.aspectRatio||de.aspectRatio||16/9,$=1200,K=675;let L,k;const B=Math.min(x,$),mt=Math.min(W,K);B/mt>Y?(k=mt,L=k*Y):(L=B,k=L/Y),a.width=L*m,a.height=k*m,f.scale(m,m),a.style.width=`${L}px`,a.style.height=`${k}px`,a.style.display="block",a.style.maxWidth="100%",a.style.maxHeight="100%",!l.current&&s.current&&(l.current=!0,s.current(a,f)),l.current&&c.current&&setTimeout(()=>{c.current&&c.current(a,f)},0)};g();const b=new ResizeObserver(()=>{g()});return b.observe(u),()=>{b.disconnect(),l.current=!1}},[r]),M.jsx("div",{ref:n,className:"game-canvas-wrapper",children:M.jsx("canvas",{ref:e,className:"game-canvas"})})},Mt=["red","yellow","blue","green","purple","orange"],Pt={red:{light:"#ff4757",dark:"#c44569"},yellow:{light:"#ffd32a",dark:"#feca57"},blue:{light:"#3742fa",dark:"#2f3542"},green:{light:"#2ed573",dark:"#1e8449"},purple:{light:"#a55eea",dark:"#8854d0"},orange:{light:"#ff6348",dark:"#ff3838"}};class Qe{constructor(t,o){gt(this,"ctx");gt(this,"cellSize");this.ctx=t,this.cellSize=o}render(t,o=1){this.ctx.save();const e=t.x+this.cellSize/2,n=t.y+this.cellSize/2;switch(this.ctx.translate(e,n),this.ctx.scale(t.scale||1,t.scale||1),this.ctx.rotate(t.rotation||0),this.ctx.globalAlpha=o,t.type){case"normal":this.renderNormalGem(t);break;case"striped":this.renderStripedGem(t);break;case"wrapped":this.renderWrappedGem(t);break;case"colorBomb":this.renderColorBomb(t);break}this.ctx.restore()}renderNormalGem(t){const o=Pt[t.color],e=this.cellSize*.85,n=-e/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.roundRect(n+2,n+2,e,e,e*.2),this.ctx.fill();const s=this.ctx.createLinearGradient(n,n,n+e,n+e);s.addColorStop(0,o.light),s.addColorStop(1,o.dark),this.ctx.fillStyle=s,this.roundRect(n,n,e,e,e*.2),this.ctx.fill(),this.renderColorPattern(t.color,n,e),this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.roundRect(n,n,e,e*.4,e*.2),this.ctx.fill(),this.ctx.strokeStyle=this.getBorderColor(t.color),this.ctx.lineWidth=e*.06,this.roundRect(n,n,e,e,e*.2),this.ctx.stroke()}getBorderColor(t){return{red:"rgba(255, 71, 87, 0.8)",yellow:"rgba(255, 211, 42, 0.8)",blue:"rgba(55, 66, 250, 0.8)",green:"rgba(46, 213, 115, 0.8)",purple:"rgba(165, 94, 234, 0.8)",orange:"rgba(255, 99, 72, 0.8)"}[t]}renderColorPattern(t,o,e){switch(this.ctx.save(),this.ctx.globalAlpha=.3,t){case"red":this.ctx.fillStyle="rgba(255, 255, 255, 0.4)",this.ctx.beginPath(),this.ctx.arc(0,0,e*.15,0,Math.PI*2),this.ctx.fill();break;case"yellow":this.ctx.fillStyle="rgba(255, 255, 255, 0.4)",this.drawStar(0,0,e*.08,e*.15,5),this.ctx.fill();break;case"blue":this.ctx.fillStyle="rgba(255, 255, 255, 0.4)",this.ctx.beginPath(),this.ctx.moveTo(0,-e*.15),this.ctx.lineTo(e*.15,0),this.ctx.lineTo(0,e*.15),this.ctx.lineTo(-e*.15,0),this.ctx.closePath(),this.ctx.fill();break;case"green":this.ctx.fillStyle="rgba(255, 255, 255, 0.4)",this.ctx.beginPath(),this.ctx.moveTo(0,-e*.15),this.ctx.lineTo(-e*.13,e*.1),this.ctx.lineTo(e*.13,e*.1),this.ctx.closePath(),this.ctx.fill();break;case"purple":this.ctx.fillStyle="rgba(255, 255, 255, 0.4)",this.ctx.fillRect(-e*.1,-e*.1,e*.2,e*.2);break;case"orange":this.ctx.fillStyle="rgba(255, 255, 255, 0.4)",this.ctx.beginPath();for(let n=0;n<6;n++){const s=Math.PI/3*n,c=Math.cos(s)*e*.12,l=Math.sin(s)*e*.12;n===0?this.ctx.moveTo(c,l):this.ctx.lineTo(c,l)}this.ctx.closePath(),this.ctx.fill();break}this.ctx.restore()}renderStripedGem(t){const o=Pt[t.color],e=this.cellSize*.85,n=-e/2,s=this.ctx.createLinearGradient(n,n,n+e,n+e);if(s.addColorStop(0,o.light),s.addColorStop(1,o.dark),this.ctx.fillStyle=s,this.roundRect(n,n,e,e,e*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.6)",this.ctx.lineWidth=e*.1,this.ctx.lineCap="round",t.stripedDirection==="horizontal")for(let c=0;c<3;c++){const l=n+e/4*(c+1);this.ctx.beginPath(),this.ctx.moveTo(n,l),this.ctx.lineTo(n+e,l),this.ctx.stroke()}else for(let c=0;c<3;c++){const l=n+e/4*(c+1);this.ctx.beginPath(),this.ctx.moveTo(l,n),this.ctx.lineTo(l,n+e),this.ctx.stroke()}}renderWrappedGem(t){const o=Pt[t.color],e=this.cellSize*.85,n=-e/2,s=this.ctx.createLinearGradient(n,n,n+e,n+e);s.addColorStop(0,o.light),s.addColorStop(1,o.dark),this.ctx.fillStyle=s,this.roundRect(n,n,e,e,e*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=e*.08,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(n,n),this.ctx.lineTo(n+e,n+e),this.ctx.moveTo(n+e,n),this.ctx.lineTo(n,n+e),this.ctx.stroke()}renderColorBomb(t){const o=this.cellSize*.85,e=-o/2,n=this.ctx.createLinearGradient(e,e,e+o,e+o);n.addColorStop(0,"#ff6b6b"),n.addColorStop(.2,"#ffd93d"),n.addColorStop(.4,"#4ecdc4"),n.addColorStop(.6,"#95e1d3"),n.addColorStop(.8,"#a29bfe"),n.addColorStop(1,"#fd79a8"),this.ctx.fillStyle=n,this.roundRect(e,e,o,o,o*.2),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 255, 255, 0.9)",this.drawStar(0,0,o*.3,o*.6,5),this.ctx.fill()}roundRect(t,o,e,n,s){this.ctx.beginPath(),this.ctx.moveTo(t+s,o),this.ctx.lineTo(t+e-s,o),this.ctx.quadraticCurveTo(t+e,o,t+e,o+s),this.ctx.lineTo(t+e,o+n-s),this.ctx.quadraticCurveTo(t+e,o+n,t+e-s,o+n),this.ctx.lineTo(t+s,o+n),this.ctx.quadraticCurveTo(t,o+n,t,o+n-s),this.ctx.lineTo(t,o+s),this.ctx.quadraticCurveTo(t,o,t+s,o),this.ctx.closePath()}drawStar(t,o,e,n,s){this.ctx.beginPath();for(let c=0;c<s*2;c++){const l=Math.PI*c/s,a=c%2===0?n:e,u=t+Math.cos(l)*a,f=o+Math.sin(l)*a;c===0?this.ctx.moveTo(u,f):this.ctx.lineTo(u,f)}this.ctx.closePath()}}const ee={rows:9,cols:9};function Tt(r){var e,n;const t=[],o=new Set;for(let s=0;s<r.length;s++){let c=1,l=(e=r[s][0])==null?void 0:e.color,a=0;for(let u=1;u<=r[s].length;u++){const f=r[s][u];if(f&&f.color===l&&l)c++;else{if(c>=3&&l){const g=[];for(let b=0;b<c;b++){const m={row:s,col:a+b},x=`${m.row},${m.col}`;o.has(x)||(g.push(m),o.add(x))}g.length>0&&t.push({type:"horizontal",positions:g})}f?(c=1,l=f.color,a=u):(c=0,l=void 0)}}}if(r.length>0)for(let s=0;s<r[0].length;s++){let c=1,l=(n=r[0][s])==null?void 0:n.color,a=0;for(let u=1;u<=r.length;u++){const f=u<r.length?r[u][s]:null;if(f&&f.color===l&&l)c++;else{if(c>=3&&l){const g=[];for(let b=0;b<c;b++){const m={row:a+b,col:s},x=`${m.row},${m.col}`;o.has(x)||(g.push(m),o.add(x))}g.length>0&&t.push({type:"vertical",positions:g})}f?(c=1,l=f.color,a=u):(c=0,l=void 0)}}}return t}class to{constructor(t){gt(this,"seed");this.seed=t}next(){return this.seed=(this.seed*9301+49297)%233280,this.seed/233280}}function oe(r){const t=new to(r),o=eo(r),e=oo(r),n=ro(r),s=no(o.rows,o.cols,t);return{stageNumber:r,gridSize:o,targetScore:e,maxMoves:n,goals:[{type:"score",target:e,current:0}],initialBoard:s}}function eo(r){return r<=100?{rows:9,cols:9}:r<=300?{rows:8,cols:8}:r<=600?{rows:7,cols:7}:{rows:6,cols:6}}function oo(r){return 1e3+r*50}function ro(r){return Math.max(20,50-Math.floor(r/20))}function no(r,t,o){const e=[];for(let n=0;n<r;n++){e[n]=[];for(let s=0;s<t;s++){const c=Mt[Math.floor(o.next()*Mt.length)];e[n][s]={id:`${n}-${s}-${Date.now()}`,color:c,type:"normal",position:{row:n,col:s},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}}return so(e)}function so(r){var e,n,s,c,l;let o=0;for(;o<100;){const a=Tt(r);if(a.length===0)return r;for(const u of a)for(const f of u.positions){const g=(e=r[f.row])==null?void 0:e[f.col];if(g){const b=Mt.indexOf(g.color),m=Mt.filter((Y,$)=>$!==b);let x=g.color,W=0;for(;W<10&&x===g.color;){const Y=m[Math.floor(Math.random()*m.length)];[(n=r[f.row-1])==null?void 0:n[f.col],(s=r[f.row+1])==null?void 0:s[f.col],(c=r[f.row])==null?void 0:c[f.col-1],(l=r[f.row])==null?void 0:l[f.col+1]].filter(Boolean).some(L=>(L==null?void 0:L.color)===Y)?W++:x=Y}x===g.color&&m.length>0&&(x=m[0]),g.color=x}}o++}return r}function io(r,t=50){var s;const o=r.map(c=>[...c]),e=o.length,n=((s=o[0])==null?void 0:s.length)||0;for(let c=0;c<n;c++){let l=e-1;for(let a=e-1;a>=0;a--)if(o[a][c]!==null){if(l!==a){const u=o[a][c];o[l][c]=u,(u.y===void 0||u.y===0)&&(u.y=a*t),u.targetY=l,u.position.row=l,o[a][c]=null}l--}for(let a=l;a>=0;a--){const u=ao(a,c);u.y=-t*(l-a+1),u.targetY=a,o[a][c]=u}}return o}function ao(r,t){const o=Mt[Math.floor(Math.random()*Mt.length)];return{id:`${Date.now()}-${r}-${t}-${Math.random()}`,color:o,type:"normal",position:{row:r,col:t},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}function co(r){const t=[];for(const o of r){const e=o.positions.length;if(e===4){const n=Math.floor(e/2),s=o.positions[n];t.push({position:s,type:"striped",stripedDirection:o.type==="horizontal"?"horizontal":"vertical"})}else if(e>=5){const n=Math.floor(e/2),s=o.positions[n];t.push({position:s,type:"colorBomb"})}}return t}function lo(r){const t=[],o=r.filter(n=>n.type==="horizontal"),e=r.filter(n=>n.type==="vertical");for(const n of o)for(const s of e){const c=n.positions.find(l=>s.positions.some(a=>l.row===a.row&&l.col===a.col));c&&t.push({position:c,type:"wrapped"})}return t}function uo(r){const t=lo(r),o=r.filter(s=>!t.some(c=>{var l,a;return c.position.row===((l=s.positions[0])==null?void 0:l.row)&&c.position.col===((a=s.positions[0])==null?void 0:a.col)})),e=[];e.push(...t);const n=co(o);for(const s of n)t.some(l=>l.position.row===s.position.row&&l.position.col===s.position.col)||e.push(s);return e}function fo(r,t,o){var c,l,a;const e=[],{row:n,col:s}=r.position;if(o==="horizontal")for(let u=0;u<((c=t[0])==null?void 0:c.length);u++)(l=t[n])!=null&&l[u]&&e.push({row:n,col:u});else for(let u=0;u<t.length;u++)(a=t[u])!=null&&a[s]&&e.push({row:u,col:s});return{positionsToRemove:e,score:e.length*20}}function ho(r,t){var s,c;const o=[],{row:e,col:n}=r.position;for(let l=e-1;l<=e+1;l++)for(let a=n-1;a<=n+1;a++)l>=0&&l<t.length&&a>=0&&a<(((s=t[0])==null?void 0:s.length)||0)&&((c=t[l])!=null&&c[a])&&o.push({row:l,col:a});return{positionsToRemove:o,score:o.length*30}}function po(r,t){var n,s;const o=[],e=r.color;for(let c=0;c<t.length;c++)for(let l=0;l<(((n=t[c])==null?void 0:n.length)||0);l++){const a=(s=t[c])==null?void 0:s[l];a&&a.color===e&&o.push({row:c,col:l})}return{positionsToRemove:o,score:o.length*50}}function go(r,t,o){var l,a,u;const e=[],{row:n,col:s}=r.position;for(let f=0;f<((l=o[0])==null?void 0:l.length);f++)(a=o[n])!=null&&a[f]&&e.push({row:n,col:f});for(let f=0;f<o.length;f++)(u=o[f])!=null&&u[s]&&e.push({row:f,col:s});const c=Array.from(new Set(e.map(f=>`${f.row},${f.col}`))).map(f=>{const[g,b]=f.split(",").map(Number);return{row:g,col:b}});return{positionsToRemove:c,score:c.length*30}}function mo(r,t,o){var u,f,g,b;const e=[],n=r.type==="striped"?r:t,s=r.type==="wrapped"?r:t,c=n.stripedDirection||"horizontal",{row:l,col:a}=s.position;if(c==="horizontal"){for(let m=l-1;m<=l+1;m++)if(m>=0&&m<o.length)for(let x=0;x<((u=o[0])==null?void 0:u.length);x++)(f=o[m])!=null&&f[x]&&e.push({row:m,col:x})}else for(let m=a-1;m<=a+1;m++)if(m>=0&&m<(((g=o[0])==null?void 0:g.length)||0))for(let x=0;x<o.length;x++)(b=o[x])!=null&&b[m]&&e.push({row:x,col:m});return{positionsToRemove:e,score:e.length*40}}function yo(r,t,o){var l,a,u,f;const e=[],n=r.type==="striped"?r:t,s=n.color;if((n.stripedDirection||"horizontal")==="horizontal")for(let g=0;g<o.length;g++)for(let b=0;b<(((l=o[g])==null?void 0:l.length)||0);b++){const m=(a=o[g])==null?void 0:a[b];m&&m.color===s&&e.push({row:g,col:b})}else for(let g=0;g<(((u=o[0])==null?void 0:u.length)||0);g++)for(let b=0;b<o.length;b++){const m=(f=o[b])==null?void 0:f[g];m&&m.color===s&&e.push({row:b,col:g})}return{positionsToRemove:e,score:e.length*60}}function So(r,t,o){var c,l;const e=[],{row:n,col:s}=r.position;for(let a=n-2;a<=n+2;a++)for(let u=s-2;u<=s+2;u++)a>=0&&a<o.length&&u>=0&&u<(((c=o[0])==null?void 0:c.length)||0)&&((l=o[a])!=null&&l[u])&&e.push({row:a,col:u});return{positionsToRemove:e,score:e.length*50}}function bo(r,t,o){var c,l;const e=[],s=(r.type==="wrapped"?r:t).color;for(let a=0;a<o.length;a++)for(let u=0;u<(((c=o[a])==null?void 0:c.length)||0);u++){const f=(l=o[a])==null?void 0:l[u];f&&f.color===s&&e.push({row:a,col:u})}return{positionsToRemove:e,score:e.length*70}}function vo(r,t,o){var n,s;const e=[];for(let c=0;c<o.length;c++)for(let l=0;l<(((n=o[c])==null?void 0:n.length)||0);l++)(s=o[c])!=null&&s[l]&&e.push({row:c,col:l});return{positionsToRemove:e,score:e.length*100}}function wo(r,t,o){switch([r.type,t.type].sort().join("+")){case"striped+striped":return go(r,t,o);case"striped+wrapped":return mo(r,t,o);case"colorBomb+striped":return yo(r,t,o);case"wrapped+wrapped":return So(r,t,o);case"colorBomb+wrapped":return bo(r,t,o);case"colorBomb+colorBomb":return vo(r,t,o);default:return null}}function xo(r,t){switch(r.type){case"striped":return fo(r,t,r.stripedDirection||"horizontal");case"wrapped":return ho(r,t);case"colorBomb":return po(r,t);default:return{positionsToRemove:[],score:0}}}const Co=r=>{const[t,o]=S.useState(()=>{const a=oe(r);return{board:a.initialBoard||[],score:0,moves:a.maxMoves,goals:a.goals,isGameOver:!1,isPaused:!1,currentStage:r,isAnimating:!1,selectedGem:null,comboCount:0}});S.useEffect(()=>{const a=oe(r);o({board:a.initialBoard||[],score:0,moves:a.maxMoves,goals:a.goals,isGameOver:!1,isPaused:!1,currentStage:r,isAnimating:!1,selectedGem:null,comboCount:0})},[r]);const e=S.useRef(null),n=S.useCallback((a,u)=>{o(f=>{var b,m;if(f.isGameOver)return f;const g=((b=f.selectedGem)==null?void 0:b.row)===a&&((m=f.selectedGem)==null?void 0:m.col)===u?null:{row:a,col:u};return e.current=g,{...f,selectedGem:g}})},[]),s=S.useCallback((a,u)=>{o(f=>{var L;if(f.isGameOver||f.moves<=0)return f;const g=Math.abs(a.row-u.row),b=Math.abs(a.col-u.col);if(!(g===1&&b===0||g===0&&b===1))return f;const m=f.board.map(k=>k.map(B=>B?{...B}:null)),x=m[a.row][a.col],W=m[u.row][u.col];if(x&&W&&x.type!=="normal"&&W.type!=="normal"){const k=wo(x,W,m);if(k){const B=new Set;for(const J of k.positionsToRemove)B.add(`${J.row},${J.col}`);for(const J of B){const[ft,ht]=J.split(","),st=Number(ft),dt=Number(ht);!Number.isNaN(st)&&!Number.isNaN(dt)&&m[st]&&(m[st][dt]=null)}const mt=f.score+k.score,xt=f.goals.map(J=>J.type==="score"?{...J,current:Math.min(J.current+k.score,J.target)}:J);return{...f,board:m,score:mt,goals:xt,moves:f.moves-1,isAnimating:!0,selectedGem:null,comboCount:0}}}const Y=m[a.row][a.col];m[a.row][a.col]=m[u.row][u.col],m[u.row][u.col]=Y,m[a.row][a.col]&&(m[a.row][a.col].position={...a}),m[u.row][u.col]&&(m[u.row][u.col].position={...u});const $=Tt(m);if($.length===0)return f;const K=uo($);for(const k of K){const B=(L=m[k.position.row])==null?void 0:L[k.position.col];B&&(B.type=k.type,k.stripedDirection&&(B.stripedDirection=k.stripedDirection))}return{...f,board:m,moves:f.moves-1,isAnimating:!0,selectedGem:null,comboCount:0}})},[]),c=S.useCallback(()=>{o(a=>{var st,dt;if(!a.isAnimating)return a;const u=Tt(a.board);if(u.length===0)return{...a,isAnimating:!1};const f=a.board.map(z=>z.map(h=>h?{...h}:null)),g=new Set;let b=0;const m=new Set;for(const z of u)for(const h of z.positions){const St=(st=f[h.row])==null?void 0:st[h.col];St&&St.type!=="normal"&&m.add(`${h.row},${h.col}`)}for(const z of m){const[h,St]=z.split(","),it=Number(h),bt=Number(St);if(!Number.isNaN(it)&&!Number.isNaN(bt)&&((dt=f[it])!=null&&dt[bt])){const kt=f[it][bt],U=xo(kt,f);for(const Lt of U.positionsToRemove)g.add(`${Lt.row},${Lt.col}`);b+=U.score}}for(const z of u)for(const h of z.positions)g.add(`${h.row},${h.col}`);for(const z of g){const[h,St]=z.split(","),it=Number(h),bt=Number(St);!Number.isNaN(it)&&!Number.isNaN(bt)&&f[it]&&(f[it][bt]=null)}const x=io(f,50),Y=Tt(x).length>0,$=Y?a.comboCount+1:0,K=1+$*.1,L=u.reduce((z,h)=>z+h.positions.length*10,0),k=L+b,B=Math.floor(k*(K-1)),mt=a.score+k+B,xt=L+b,J=a.goals.map(z=>z.type==="score"?{...z,current:Math.min(z.current+xt,z.target)}:z),ft=J.every(z=>z.current>=z.target),ht=a.moves<=0&&!ft;return{...a,board:x,score:mt,goals:J,isGameOver:ht||a.isGameOver,isAnimating:Y&&!ft&&!ht,comboCount:$}})},[]),l=S.useCallback(()=>{o(a=>({...a,isPaused:!a.isPaused}))},[]);return{gameState:t,selectGem:n,swapGems:s,processMatches:c,togglePause:l}};function re(r){const{score:t,goals:o,moves:e}=r;if(o.length===0)return 0;const n=o[0];if(n.current<n.target)return 0;const s=n.current/n.target,c=e/50,l=Math.min(t/(n.target*2),1);let a=0;return s>=1&&(a=1,(s>=1.2||c>=.5)&&(a=2),s>=1.5&&c>=.6&&l>=.8&&(a=3)),Math.min(a,3)}class Ro{constructor(t){gt(this,"particles",[]);gt(this,"ctx");this.ctx=t}emit(t,o,e,n=20){const s=Pt[e];for(let c=0;c<n;c++){const l=Math.PI*2*c/n+Math.random()*.5,a=2+Math.random()*3;this.particles.push({x:t,y:o,vx:Math.cos(l)*a,vy:Math.sin(l)*a,life:1,maxLife:1,color:Math.random()>.5?s.light:s.dark,size:3+Math.random()*4,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}emitExplosion(t,o,e,n=50,s=30){const c=Pt[e];for(let l=0;l<s;l++){const a=Math.random()*Math.PI*2,u=Math.random()*n,f=1+Math.random()*2;this.particles.push({x:t+Math.cos(a)*u*.3,y:o+Math.sin(a)*u*.3,vx:Math.cos(a)*f,vy:Math.sin(a)*f,life:1,maxLife:1,color:Math.random()>.5?c.light:c.dark,size:4+Math.random()*6,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.3})}}update(t=16){for(let o=this.particles.length-1;o>=0;o--){const e=this.particles[o];e.x+=e.vx,e.y+=e.vy,e.vy+=.1,e.vx*=.98,e.vy*=.98,e.rotation+=e.rotationSpeed,e.life-=t/1e3,e.life<=0&&this.particles.splice(o,1)}}render(){this.ctx.save();for(const t of this.particles){const o=t.life/t.maxLife,e=t.size*o;this.ctx.globalAlpha=o,this.ctx.fillStyle=t.color,this.ctx.translate(t.x,t.y),this.ctx.rotate(t.rotation),this.ctx.fillRect(-e/2,-e/2,e,e),this.ctx.setTransform(1,0,0,1,0,0)}this.ctx.globalAlpha=1,this.ctx.restore()}clear(){this.particles=[]}get count(){return this.particles.length}}function ne(r){var e,n,s,c;const t=r.length,o=((e=r[0])==null?void 0:e.length)||0;for(let l=0;l<t;l++)for(let a=0;a<o;a++)if((n=r[l])!=null&&n[a]){if(a<o-1&&((s=r[l])==null?void 0:s[a+1])){const g=se(r,l,a,l,a+1);if(Tt(g).length>0)return{from:{row:l,col:a},to:{row:l,col:a+1}}}if(l<t-1&&((c=r[l+1])==null?void 0:c[a])){const g=se(r,l,a,l+1,a);if(Tt(g).length>0)return{from:{row:l,col:a},to:{row:l+1,col:a}}}}return null}function se(r,t,o,e,n){const s=r.map(l=>l.map(a=>a?{...a}:null)),c=s[t][o];return s[t][o]=s[e][n],s[e][n]=c,s}const To=({stageNumber:r=1,currentScreen:t="stageSelect",onNavigate:o,onStartStage:e})=>{const n=S.useRef(!1),s=S.useRef(null),c=S.useRef(null),l=S.useRef(null),a=S.useRef(null),u=S.useRef(null),f=S.useRef(null),g=S.useRef(new Map),b=S.useRef(null),m=S.useRef(!1),x=S.useRef(null),W=S.useRef(""),Y=S.useRef(!1),$=S.useRef(null),K=S.useRef(null),L=S.useRef(null),k=S.useRef(null),B=S.useRef(!1),mt=S.useRef(!1),xt=S.useRef(!1),J=S.useRef(!1),[ft,ht]=S.useState(!1),{t:st}=$t(),[dt,z]=S.useState(1),{gameState:h,selectGem:St,swapGems:it,processMatches:bt,togglePause:kt}=Co(r),[U,Lt]=S.useState(()=>{const y=ee.cols,R=ee.rows;return{aspectRatio:de.aspectRatio,cellSize:50,gridRows:R,gridCols:y,pixelRatio:window.devicePixelRatio||1,logicalWidth:0,logicalHeight:0}});S.useEffect(()=>{var i;if(t==="game"&&h.board.length>0){const y=h.board.length,R=((i=h.board[0])==null?void 0:i.length)||9;Lt(C=>({...C,gridRows:y,gridCols:R}))}},[t,h.board,r]),S.useEffect(()=>{const i=localStorage.getItem("chipPuzzleGame_progress");if(i)try{const y=JSON.parse(i);z(Math.max(1,y.highestStage||1))}catch(y){console.error("Failed to load progress",y)}},[]);const qt=S.useCallback((i,y,R)=>{const d=y/1200;i.fillStyle="#1a1a1a",i.fillRect(0,0,y,R),i.fillStyle="#fff";const nt=Math.max(16,32*d);i.font=`bold ${nt}px Arial`,i.textAlign="center",i.fillText(st("stageSelect.title"),y/2,50*d);const v=8,at=60,vt=15,T=at*d,et=vt*d,F=(y-(v*T+(v-1)*et))/2,j=100*d,q=50,ot=1;for(let tt=0;tt<q;tt++){const Z=(ot-1)*q+tt+1,_=Math.floor(tt/v),rt=tt%v,w=F+rt*(T+et),E=j+_*(T+et),N=Z<=dt;if(N){const p=i.createLinearGradient(w,E,w+T,E+T);p.addColorStop(0,"#667eea"),p.addColorStop(1,"#764ba2"),i.fillStyle=p}else i.fillStyle="#1a1a1a";i.fillRect(w,E,T,T),i.strokeStyle=N?"#667eea":"#444",i.lineWidth=Math.max(1,2*d),i.strokeRect(w,E,T,T),i.fillStyle="#fff";const X=Math.max(12,20*d);if(i.font=`bold ${X}px Arial`,i.textAlign="center",i.textBaseline="middle",i.fillText(Z.toString(),w+T/2,E+T/2),!N){i.fillStyle="#ffa500";const p=Math.max(16,24*d);i.font=`${p}px Arial`,i.fillText("ðŸ”’",w+T/2,E+T/2-10*d)}}},[dt,st]),Vt=S.useCallback((i,y,R)=>{const d=y/1200;i.fillStyle="#1a1a1a",i.fillRect(0,0,y,R);const v=(U.cellSize||50)*d,at=U.gridCols||9,vt=U.gridRows||9,T=v*at,et=v*vt,F=(y-T)/2,j=(R-et)/2;(!l.current||a.current!==v)&&(l.current=new Qe(i,v),a.current=v),u.current||(u.current=new Ro(i)),i.fillStyle="#222",i.fillRect(F,j,T,et),i.strokeStyle="#444",i.lineWidth=Math.max(.5,1*d);for(let w=0;w<=vt;w++){const E=j+w*v;i.beginPath(),i.moveTo(F,E),i.lineTo(F+T,E),i.stroke()}for(let w=0;w<=at;w++){const E=F+w*v;i.beginPath(),i.moveTo(E,j),i.lineTo(E,j+et),i.stroke()}i.fillStyle="#fff";const q=Math.max(8,18*d);i.font=`bold ${q}px Arial`,i.textAlign="left",i.textBaseline="top";const ot=20*d,tt=20*d,Z=q+6*d,_=tt;if(i.fillText(`Score: ${h.score}`,ot,_),i.fillText(`Moves: ${h.moves}`,ot,_+Z),h.goals.length>0){const w=h.goals[0];i.fillText(`Goal: ${w.current}/${w.target}`,ot,_+Z*2)}if(h.comboCount>0&&(i.fillStyle="#ffd93d",i.font=`bold ${Math.max(10,q+2*d)}px Arial`,i.fillText(`Combo x${h.comboCount}!`,ot,_+Z*3),i.fillStyle="#fff"),!h.isGameOver&&!h.isAnimating){const N=20*d,X=10*d,p=Math.max(60,120*d),I=Math.max(24,40*d),O=Math.max(60,120*d),P=Math.max(24,40*d),V=y-p-N,ct=N;i.fillStyle=ft?"#4ecdc4":"#667eea",i.fillRect(V,ct,p,I),i.strokeStyle="#fff",i.lineWidth=Math.max(1,2*d),i.strokeRect(V,ct,p,I),i.fillStyle="#fff";const G=Math.max(8,16*d);i.font=`bold ${G}px Arial`,i.textAlign="center",i.fillText("Hint",V+p/2,ct+I/2+G*.35);const D=V-O-X,Q=N;i.fillStyle=h.isPaused?"#ff6b6b":"#667eea",i.fillRect(D,Q,O,P),i.strokeStyle="#fff",i.lineWidth=Math.max(1,2*d),i.strokeRect(D,Q,O,P),i.fillStyle="#fff";const lt=Math.max(8,16*d);i.font=`bold ${lt}px Arial`,i.textAlign="center",i.fillText(h.isPaused?st("game.resume"):st("game.pause"),D+O/2,Q+P/2+lt*.35)}if(h.isPaused&&!h.isGameOver&&(i.fillStyle="rgba(0, 0, 0, 0.7)",i.fillRect(0,0,y,R),i.fillStyle="#fff",i.font=`bold ${Math.max(24,48*d)}px Arial`,i.textAlign="center",i.textBaseline="middle",i.fillText(st("game.pause"),y/2,R/2),i.fillStyle="#ccc",i.font=`bold ${Math.max(16,24*d)}px Arial`,i.fillText(st("game.resume"),y/2,R/2+50*d)),h.isGameOver){i.fillStyle="rgba(0, 0, 0, 0.7)",i.fillRect(0,0,y,R),i.fillStyle="#ff6b6b",i.font=`bold ${Math.max(24,48*d)}px Arial`,i.textAlign="center",i.textBaseline="middle",i.fillText("Game Over!",y/2,R/2),i.fillStyle="#fff",i.font=`bold ${Math.max(16,24*d)}px Arial`,i.fillText(`Final Score: ${h.score}`,y/2,R/2+50*d);const w=y/2-100*d,E=R/2+100*d,N=200*d,X=50*d,p=i.createLinearGradient(w,E,w+N,E+X);p.addColorStop(0,"#ff6b6b"),p.addColorStop(1,"#ee5a6f"),i.fillStyle=p,i.fillRect(w,E,N,X),i.strokeStyle="#fff",i.lineWidth=Math.max(2,3*d),i.strokeRect(w,E,N,X),i.fillStyle="#fff",i.font=`bold ${Math.max(14,20*d)}px Arial`,i.fillText("Retry",y/2,E+X/2+8*d)}const rt=h.goals.every(w=>w.current>=w.target);if(h.board&&h.board.length>0&&l.current){let w=!1;h.board.forEach((N,X)=>{N&&N.forEach((p,I)=>{if(p){const O=F+I*v,P=j+X*v;if(B.current&&$.current&&L.current&&K.current){const G=$.current,D=L.current,Q=K.current;if(X===G.row&&I===G.col)if(k.current){const lt=k.current.x-Q.x,Rt=k.current.y-Q.y,pt=v,Gt=Math.max(-pt,Math.min(pt,lt)),Wt=Math.max(-pt,Math.min(pt,Rt));p.x=O+Gt,p.y=P+Wt}else p.x=O,p.y=P;else if(X===D.row&&I===D.col)if(k.current){const lt=k.current.x-Q.x,Rt=k.current.y-Q.y,pt=v,Gt=Math.max(-pt,Math.min(pt,-lt)),Wt=Math.max(-pt,Math.min(pt,-Rt));p.x=O+Gt,p.y=P+Wt}else p.x=O,p.y=P;else p.x=O,p.y=P}else if(p.targetY!==void 0){w=!0;let G;p.targetY<100?G=j+p.targetY*v:G=p.targetY,(p.y===void 0||p.y===0)&&(p.y=P);const D=G-p.y,Q=.15;Math.abs(D)>1?(p.y+=D*Q,D>0&&(p.y+=1)):(p.y=G,p.targetY=void 0),p.x=O}else if(p.targetX!==void 0){const G=p.targetX-p.x,D=.2;Math.abs(G)>.1?p.x+=G*D:(p.x=p.targetX,p.targetX=void 0),p.y=P}else(p.x===0&&p.y===0&&p.targetX===void 0&&p.targetY===void 0||p.x!==O||p.y!==P)&&(p.x=O,p.y=P);h.selectedGem&&h.selectedGem.row===X&&h.selectedGem.col===I&&(i.fillStyle="rgba(255, 255, 255, 0.3)",i.strokeStyle="rgba(255, 255, 255, 0.8)",i.lineWidth=Math.max(2,3*d),i.strokeRect(O,P,v,v),i.fillRect(O,P,v,v)),ft&&b.current&&(b.current.from.row===X&&b.current.from.col===I||b.current.to.row===X&&b.current.to.col===I)&&(i.fillStyle="rgba(255, 215, 61, 0.4)",i.strokeStyle="#ffd93d",i.lineWidth=Math.max(3,4*d),i.strokeRect(O,P,v,v),i.fillRect(O,P,v,v));let V=1,ct=p.scale||1;if(p.isRemoving){let G=g.current.get(p.id);G||(G={alpha:1,scale:1},g.current.set(p.id,G)),G.alpha=Math.max(0,G.alpha-.08),G.scale=Math.max(0,G.scale-.08),V=G.alpha,ct=G.scale,p.alpha=V,p.scale=ct,g.current.set(p.id,G)}else p.alpha=1,p.scale=1;if(V>0){const G=rt&&!h.isAnimating?V*.3:V;l.current.render(p,G)}if(p.isRemoving&&V>.8&&V<.9&&u.current){const G=p.x+v/2,D=p.y+v/2;u.current.emit(G,D,p.color,15)}}})});const E=m.current;m.current=w,E&&!w&&h.isAnimating&&t==="game"&&!h.isGameOver&&!Y.current&&setTimeout(()=>{W.current=""},100)}if(u.current&&(u.current.update(16),u.current.render()),rt&&!h.isAnimating&&!h.isGameOver){const w=re(h);i.fillStyle="rgba(0, 0, 0, 0.95)",i.fillRect(0,0,y,R),i.fillStyle="#4ecdc4",i.font=`bold ${Math.max(24,48*d)}px Arial`,i.textAlign="center",i.textBaseline="middle",i.fillText("Stage Cleared!",y/2,R/2-100*d);const E=Math.max(20,40*d),N=E*1.5,X=y/2-N*1.5,p=R/2-30*d;for(let G=0;G<3;G++){const D=X+G*N;i.fillStyle=G<w?"#ffd93d":"#666",i.font=`${E}px Arial`,i.fillText("â˜…",D,p)}i.fillStyle="#fff",i.font=`bold ${Math.max(16,24*d)}px Arial`,i.fillText(`Score: ${h.score}`,y/2,R/2+30*d);const I=y/2-100*d,O=R/2+80*d,P=200*d,V=50*d,ct=i.createLinearGradient(I,O,I+P,O+V);ct.addColorStop(0,"#667eea"),ct.addColorStop(1,"#764ba2"),i.fillStyle=ct,i.fillRect(I,O,P,V),i.strokeStyle="#fff",i.lineWidth=Math.max(2,3*d),i.strokeRect(I,O,P,V),i.fillStyle="#fff",i.font=`bold ${Math.max(14,20*d)}px Arial`,i.fillText("Next Stage",y/2,O+V/2+8*d)}},[U,h,ft]),wt=S.useCallback(()=>{const i=s.current,y=c.current;if(!i||!y)return;const R=window.devicePixelRatio||1,C=i.width/R,d=i.height/R;C===0||d===0||(t==="stageSelect"?qt(y,C,d):t==="game"?Vt(y,C,d):(y.fillStyle="#1a1a1a",y.fillRect(0,0,C,d)))},[t,qt,Vt]);S.useEffect(()=>{const i=()=>{const y=()=>{wt(),f.current=requestAnimationFrame(y)};f.current=requestAnimationFrame(y)};return s.current&&c.current&&i(),()=>{f.current!==null&&(cancelAnimationFrame(f.current),f.current=null)}},[wt]);const pe=S.useCallback((i,y)=>{n.current||(n.current=!0,s.current=i,c.current=y,wt())},[wt]),ge=S.useCallback((i,y)=>{s.current=i,c.current=y,wt()},[wt]);S.useEffect(()=>{if(s.current&&c.current){const i=setTimeout(()=>{wt()},10);return()=>clearTimeout(i)}},[wt,t,dt,r,h]),S.useEffect(()=>{if(h.isAnimating&&t==="game"&&!h.isGameOver&&!Y.current){const i=JSON.stringify(h.board);if(i!==W.current){Y.current=!0;const R=i;return W.current=i,x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{const C=()=>{m.current?setTimeout(C,50):(bt(),setTimeout(()=>{Y.current=!1,W.current=R},200))};C()},300),()=>{x.current&&(clearTimeout(x.current),x.current=null)}}}else h.isAnimating||(W.current="",Y.current=!1)},[h.isAnimating,h.board,bt,t,h.isGameOver]),S.useEffect(()=>{if(t!=="game"){xt.current=!1,J.current=!1;return}const i=h.goals.every(y=>y.current>=y.target);if(!xt.current&&h.isGameOver&&(console.log("Game Over!",h.score),yt.playGameOver()),!J.current&&i&&!h.isGameOver){console.log("Stage Cleared!",h.score),yt.playStageClear();try{const y=re(h),R=localStorage.getItem("chipPuzzleGame_progress");let C={highestStage:1,stageRecords:{}};if(R)try{C=JSON.parse(R)}catch(at){console.error("Failed to parse progress",at)}const d=h.currentStage;d>=C.highestStage&&(C.highestStage=d+1),C.stageRecords||(C.stageRecords={});const nt=d.toString(),v=C.stageRecords[nt];!v||h.score>v.bestScore?C.stageRecords[nt]={stageNumber:d,stars:Math.max((v==null?void 0:v.stars)||0,y),score:h.score,bestScore:h.score,completedAt:new Date().toISOString(),attempts:((v==null?void 0:v.attempts)||0)+1}:C.stageRecords[nt]={...v,stars:Math.max(v.stars,y),attempts:v.attempts+1},localStorage.setItem("chipPuzzleGame_progress",JSON.stringify(C))}catch(y){console.error("Failed to save progress",y)}}xt.current=h.isGameOver,J.current=i},[h.isGameOver,h.goals,h.score,h.currentStage,t]);const zt=S.useCallback(i=>{if(mt.current){mt.current=!1;return}const y=s.current;if(!y)return;const R=y.getBoundingClientRect(),C=i.clientX-R.left,d=i.clientY-R.top,nt=window.devicePixelRatio||1,v=y.width/nt,at=y.height/nt;if(t==="stageSelect"){if(!e)return;const T=v/1200,et=120,F=40,j=20*T,q=Math.max(60,et*T),ot=Math.max(24,F*T),tt=v-q-j,Z=j;if(C>=tt&&C<=tt+q&&d>=Z&&d<=Z+ot){if(ft)ht(!1),b.current=null;else{const P=ne(h.board);P&&(b.current=P,ht(!0),setTimeout(()=>{ht(!1),b.current=null},3e3))}return}const _=8,rt=60,w=15,E=rt*T,N=w*T,X=(v-(_*E+(_-1)*N))/2,p=100*T,I=Math.floor((C-X)/(E+N)),O=Math.floor((d-p)/(E+N));if(I>=0&&I<_&&O>=0){const P=O*_+I+1;P<=dt&&P<=50&&e(P)}}else if(t==="game"){const T=v/1200;if(h.isGameOver){const lt=v/2-100*T,Rt=at/2+100*T,pt=200*T,Gt=50*T;if(C>=lt&&C<=lt+pt&&d>=Rt&&d<=Rt+Gt){e&&e(r),yt.playClick();return}return}if(h.isPaused){kt(),yt.playClick();return}const et=120,F=40,j=20*T,q=10*T,ot=Math.max(60,et*T),tt=Math.max(24,F*T),Z=Math.max(60,et*T),_=Math.max(24,F*T),rt=v-ot-j,w=j,E=rt-Z-q,N=j;if(C>=E&&C<=E+Z&&d>=N&&d<=N+_){kt(),yt.playClick();return}if(C>=rt&&C<=rt+ot&&d>=w&&d<=w+tt){if(ft)ht(!1),b.current=null;else{const lt=ne(h.board);lt&&(b.current=lt,ht(!0),setTimeout(()=>{ht(!1),b.current=null},3e3))}yt.playClick();return}if(h.isPaused)return;const p=(U.cellSize||50)*T,I=U.gridCols||9,O=U.gridRows||9,P=p*I,V=p*O,ct=(v-P)/2,G=(at-V)/2,D=Math.floor((C-ct)/p),Q=Math.floor((d-G)/p);D>=0&&D<I&&Q>=0&&Q<O&&h.board[Q]&&h.board[Q][D]&&(h.selectedGem?it(h.selectedGem,{row:Q,col:D}):St(Q,D),yt.playClick())}},[t,e,dt,U,h,St,it,ft,kt]),It=S.useCallback(i=>{const y=s.current;if(!y||t!=="game"||h.isPaused)return;const R=y.getBoundingClientRect(),C=i.clientX-R.left,d=i.clientY-R.top,nt=window.devicePixelRatio||1,v=y.width/nt,at=y.height/nt,T=v/1200,F=(U.cellSize||50)*T,j=U.gridCols||9,q=U.gridRows||9,ot=F*j,tt=F*q,Z=(v-ot)/2,_=(at-tt)/2,rt=Math.floor((C-Z)/F),w=Math.floor((d-_)/F);rt>=0&&rt<j&&w>=0&&w<q&&h.board[w]&&h.board[w][rt]&&($.current={row:w,col:rt},K.current={x:C,y:d},B.current=!0)},[t,U,h.board,h.isPaused]),Dt=S.useCallback(i=>{const y=s.current;if(!y||t!=="game"||h.isPaused||!B.current||!$.current||!K.current)return;const R=y.getBoundingClientRect(),C=i.clientX-R.left,d=i.clientY-R.top,nt=window.devicePixelRatio||1,vt=y.width/nt/1200,T=U.gridCols||9,et=U.gridRows||9,F=K.current,j=C-F.x,q=d-F.y,ot=Math.sqrt(j*j+q*q),tt=10*vt;if(ot<tt){k.current={x:C,y:d},L.current=null;return}const Z=$.current;let _={row:Z.row,col:Z.col};if(Math.abs(j)>Math.abs(q)?j>0?_.col+=1:_.col-=1:q>0?_.row+=1:_.row-=1,_.col<0||_.col>=T||_.row<0||_.row>=et){B.current=!1,$.current=null,K.current=null,L.current=null,k.current=null;return}k.current={x:C,y:d},L.current=_},[t,U,h.isPaused]),Ct=S.useCallback(()=>{if(B.current&&$.current&&L.current){const i=$.current,y=L.current,R=Math.abs(i.row-y.row),C=Math.abs(i.col-y.col);(R===1&&C===0||R===0&&C===1)&&(it(i,y),yt.playClick(),mt.current=!0)}B.current=!1,$.current=null,K.current=null,L.current=null,k.current=null},[it]);return S.useEffect(()=>{const i=s.current;if(i)return i.addEventListener("click",zt),()=>{i.removeEventListener("click",zt)}},[zt]),S.useEffect(()=>{const i=s.current;if(i)return i.addEventListener("pointerdown",It),i.addEventListener("pointermove",Dt),i.addEventListener("pointerup",Ct),i.addEventListener("pointerleave",Ct),i.addEventListener("pointercancel",Ct),()=>{i.removeEventListener("pointerdown",It),i.removeEventListener("pointermove",Dt),i.removeEventListener("pointerup",Ct),i.removeEventListener("pointerleave",Ct),i.removeEventListener("pointercancel",Ct)}},[It,Dt,Ct]),M.jsx("div",{className:"game-board",children:M.jsx(Ze,{config:U,onReady:pe,onResize:ge})})};const Mo=()=>{const[r,t]=S.useState("stageSelect"),[o,e]=S.useState(null),n=c=>{t(c)},s=c=>{e(c),t("game")};return M.jsx(We,{children:M.jsxs("div",{className:"app-container",children:[M.jsx(Ve,{onNavigate:n,currentScreen:r}),M.jsx(Je,{children:M.jsx(To,{stageNumber:o||1,currentScreen:r,onNavigate:n,onStartStage:s})}),M.jsx(Ke,{})]})})};Ht.createRoot(document.getElementById("root")).render(M.jsx(Ot.StrictMode,{children:M.jsx(Et,{children:M.jsx(Mo,{})})}));
