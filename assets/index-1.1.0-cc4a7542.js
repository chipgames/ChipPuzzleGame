var Rt=Object.defineProperty;var Tt=(s,t,n)=>t in s?Rt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[t]=n;var Me=(s,t,n)=>(Tt(s,typeof t!="symbol"?t+"":t,n),n);import{r as S,a as kt,g as Pt,R as Ie}from"./vendor-1.1.0-57209f9c.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(a){if(a.ep)return;a.ep=!0;const r=n(a);fetch(a.href,r)}})();var dt={exports:{}},Fe={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Gt=S,Ot=Symbol.for("react.element"),Bt=Symbol.for("react.fragment"),Et=Object.prototype.hasOwnProperty,At=Gt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,xt={key:!0,ref:!0,__self:!0,__source:!0};function pt(s,t,n){var o,a={},r=null,i=null;n!==void 0&&(r=""+n),t.key!==void 0&&(r=""+t.key),t.ref!==void 0&&(i=t.ref);for(o in t)Et.call(t,o)&&!xt.hasOwnProperty(o)&&(a[o]=t[o]);if(s&&s.defaultProps)for(o in t=s.defaultProps,t)a[o]===void 0&&(a[o]=t[o]);return{$$typeof:Ot,type:s,key:r,ref:i,props:a,_owner:At.current}}Fe.Fragment=Bt;Fe.jsx=pt;Fe.jsxs=pt;dt.exports=Fe;var k=dt.exports,Je={},tt=kt;Je.createRoot=tt.createRoot,Je.hydrateRoot=tt.hydrateRoot;var gt={exports:{}},Lt="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",Nt=Lt,_t=Nt;function mt(){}function yt(){}yt.resetWarningCache=mt;var jt=function(){function s(o,a,r,i,u,l){if(l!==_t){var f=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw f.name="Invariant Violation",f}}s.isRequired=s;function t(){return s}var n={array:s,bigint:s,bool:s,func:s,number:s,object:s,string:s,symbol:s,any:s,arrayOf:t,element:s,elementType:s,instanceOf:t,node:s,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:yt,resetWarningCache:mt};return n.PropTypes=n,n};gt.exports=jt();var $t=gt.exports;const L=Pt($t);function It(s,t){s.prototype=Object.create(t.prototype),s.prototype.constructor=s,Ze(s,t)}function Ze(s,t){return Ze=Object.setPrototypeOf||function(n,o){return n.__proto__=o,n},Ze(s,t)}var Z={BASE:"base",BODY:"body",HEAD:"head",HTML:"html",LINK:"link",META:"meta",NOSCRIPT:"noscript",SCRIPT:"script",STYLE:"style",TITLE:"title",FRAGMENT:"Symbol(react.fragment)"},zt={rel:["amphtml","canonical","alternate"]},Yt={type:["application/ld+json"]},Dt={charset:"",name:["robots","description"],property:["og:type","og:title","og:url","og:image","og:image:alt","og:description","twitter:url","twitter:title","twitter:description","twitter:image","twitter:image:alt","twitter:card","twitter:site"]};Object.keys(Z).map(function(s){return Z[s]});var De={accesskey:"accessKey",charset:"charSet",class:"className",contenteditable:"contentEditable",contextmenu:"contextMenu","http-equiv":"httpEquiv",itemprop:"itemProp",tabindex:"tabIndex"};Object.keys(De).reduce(function(s,t){return s[De[t]]=t,s},{});var Ft=function(s){return Array.isArray(s)?s.join(""):s},qe=function(s,t){return Array.isArray(s)?s.reduce(function(n,o){return function(a,r){for(var i=Object.keys(a),u=0;u<i.length;u+=1)if(r[i[u]]&&r[i[u]].includes(a[i[u]]))return!0;return!1}(o,t)?n.priority.push(o):n.default.push(o),n},{priority:[],default:[]}):{default:s}},Wt=[Z.NOSCRIPT,Z.SCRIPT,Z.STYLE],Ve=function(s,t){return t===void 0&&(t=!0),t===!1?String(s):String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")},ot=function(s){return Object.keys(s).reduce(function(t,n){var o=s[n]!==void 0?n+'="'+s[n]+'"':""+n;return t?t+" "+o:o},"")},nt=function(s,t){return t===void 0&&(t={}),Object.keys(s).reduce(function(n,o){return n[De[o]||o]=s[o],n},t)},Ye=function(s,t){return t.map(function(n,o){var a,r=((a={key:o})["data-rh"]=!0,a);return Object.keys(n).forEach(function(i){var u=De[i]||i;u==="innerHTML"||u==="cssText"?r.dangerouslySetInnerHTML={__html:n.innerHTML||n.cssText}:r[u]=n[i]}),Ie.createElement(s,r)})},we=function(s,t,n){switch(s){case Z.TITLE:return{toComponent:function(){return a=t.titleAttributes,(r={key:o=t.title})["data-rh"]=!0,i=nt(a,r),[Ie.createElement(Z.TITLE,i,o)];var o,a,r,i},toString:function(){return function(o,a,r,i){var u=ot(r),l=Ft(a);return u?"<"+o+' data-rh="true" '+u+">"+Ve(l,i)+"</"+o+">":"<"+o+' data-rh="true">'+Ve(l,i)+"</"+o+">"}(s,t.title,t.titleAttributes,n)}};case"bodyAttributes":case"htmlAttributes":return{toComponent:function(){return nt(t)},toString:function(){return ot(t)}};default:return{toComponent:function(){return Ye(s,t)},toString:function(){return function(o,a,r){return a.reduce(function(i,u){var l=Object.keys(u).filter(function(y){return!(y==="innerHTML"||y==="cssText")}).reduce(function(y,m){var g=u[m]===void 0?m:m+'="'+Ve(u[m],r)+'"';return y?y+" "+g:g},""),f=u.innerHTML||u.cssText||"",h=Wt.indexOf(o)===-1;return i+"<"+o+' data-rh="true" '+l+(h?"/>":">"+f+"</"+o+">")},"")}(s,t,n)}}}},Xt=function(s){var t=s.baseTag,n=s.bodyAttributes,o=s.encode,a=s.htmlAttributes,r=s.noscriptTags,i=s.styleTags,u=s.title,l=u===void 0?"":u,f=s.titleAttributes,h=s.linkTags,y=s.metaTags,m=s.scriptTags,g={toComponent:function(){},toString:function(){return""}};if(s.prioritizeSeoTags){var T=function(Y){var j=Y.linkTags,W=Y.scriptTags,V=Y.encode,z=qe(Y.metaTags,Dt),O=qe(j,zt),D=qe(W,Yt);return{priorityMethods:{toComponent:function(){return[].concat(Ye(Z.META,z.priority),Ye(Z.LINK,O.priority),Ye(Z.SCRIPT,D.priority))},toString:function(){return we(Z.META,z.priority,V)+" "+we(Z.LINK,O.priority,V)+" "+we(Z.SCRIPT,D.priority,V)}},metaTags:z.default,linkTags:O.default,scriptTags:D.default}}(s);g=T.priorityMethods,h=T.linkTags,y=T.metaTags,m=T.scriptTags}return{priority:g,base:we(Z.BASE,t,o),bodyAttributes:we("bodyAttributes",n,o),htmlAttributes:we("htmlAttributes",a,o),link:we(Z.LINK,h,o),meta:we(Z.META,y,o),noscript:we(Z.NOSCRIPT,r,o),script:we(Z.SCRIPT,m,o),style:we(Z.STYLE,i,o),title:we(Z.TITLE,{title:l,titleAttributes:f},o)}},ze=[],Ht=function(s,t){var n=this;t===void 0&&(t=typeof document<"u"),this.instances=[],this.value={setHelmet:function(o){n.context.helmet=o},helmetInstances:{get:function(){return n.canUseDOM?ze:n.instances},add:function(o){(n.canUseDOM?ze:n.instances).push(o)},remove:function(o){var a=(n.canUseDOM?ze:n.instances).indexOf(o);(n.canUseDOM?ze:n.instances).splice(a,1)}}},this.context=s,this.canUseDOM=t,t||(s.helmet=Xt({baseTag:[],bodyAttributes:{},encodeSpecialCharacters:!0,htmlAttributes:{},linkTags:[],metaTags:[],noscriptTags:[],scriptTags:[],styleTags:[],title:"",titleAttributes:{}}))},Ut=Ie.createContext({}),qt=L.shape({setHelmet:L.func,helmetInstances:L.shape({get:L.func,add:L.func,remove:L.func})}),Vt=typeof document<"u",je=function(s){function t(n){var o;return(o=s.call(this,n)||this).helmetData=new Ht(o.props.context,t.canUseDOM),o}return It(t,s),t.prototype.render=function(){return Ie.createElement(Ut.Provider,{value:this.helmetData.value},this.props.children)},t}(S.Component);je.canUseDOM=Vt,je.propTypes={context:L.shape({helmet:L.shape()}),children:L.node.isRequired},je.defaultProps={context:{}},je.displayName="HelmetProvider";qt.isRequired;L.object,L.object,L.oneOfType([L.arrayOf(L.node),L.node]),L.string,L.bool,L.bool,L.object,L.arrayOf(L.object),L.arrayOf(L.object),L.arrayOf(L.object),L.func,L.arrayOf(L.object),L.arrayOf(L.object),L.string,L.object,L.string,L.bool,L.object;class Kt extends S.Component{constructor(){super(...arguments);Me(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,o){console.error("Uncaught error:",n,o)}render(){return this.state.hasError?this.props.fallback||k.jsxs("div",{className:"error-boundary",children:[k.jsx("h2",{children:"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"}),k.jsx("p",{children:"ê²Œìž„ì„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”."}),k.jsx("button",{onClick:()=>window.location.reload(),children:"ìƒˆë¡œê³ ì¹¨"})]}):this.props.children}}const Jt="modulepreload",Zt=function(s){return"/ChipPuzzleGame/"+s},st={},_e=function(t,n,o){if(!n||n.length===0)return t();const a=document.getElementsByTagName("link");return Promise.all(n.map(r=>{if(r=Zt(r),r in st)return;st[r]=!0;const i=r.endsWith(".css"),u=i?'[rel="stylesheet"]':"";if(!!o)for(let h=a.length-1;h>=0;h--){const y=a[h];if(y.href===r&&(!i||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${r}"]${u}`))return;const f=document.createElement("link");if(f.rel=i?"stylesheet":Jt,i||(f.as="script",f.crossOrigin=""),f.href=r,document.head.appendChild(f),i)return new Promise((h,y)=>{f.addEventListener("load",h),f.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${r}`)))})})).then(()=>t()).catch(r=>{const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=r,window.dispatchEvent(i),!i.defaultPrevented)throw r})},Qt=(s,t)=>{const n=s[t];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((o,a)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(a.bind(null,new Error("Unknown variable dynamic import: "+t)))})},bt=["en","ko","zh","ja"],eo="en",to={en:"English",ko:"í•œêµ­ì–´",zh:"ä¸­æ–‡",ja:"æ—¥æœ¬èªž"};class rt{constructor(){Me(this,"supportedLanguages",bt);Me(this,"defaultLanguage",eo)}detectBrowserLanguage(){const t=navigator.language.split("-")[0];return this.supportedLanguages.includes(t)?t:this.defaultLanguage}getStoredLanguage(){try{return localStorage.getItem("language")}catch(t){return console.error("Failed to get stored language:",t),null}}setLanguage(t){if(this.supportedLanguages.includes(t))try{localStorage.setItem("language",t),window.dispatchEvent(new CustomEvent("languageChanged",{detail:t}))}catch(n){console.error("Failed to set language:",n)}}getCurrentLanguage(){const t=this.getStoredLanguage();return t&&this.supportedLanguages.includes(t)?t:this.detectBrowserLanguage()}}const Ke={},We=()=>{const[s,t]=S.useState(()=>new rt().getCurrentLanguage()),[n,o]=S.useState(null),[a,r]=S.useState(!0);return S.useEffect(()=>{(async()=>{r(!0);try{if(Ke[s]){o(Ke[s]),r(!1);return}const h=await Qt(Object.assign({"../locales/en.json":()=>_e(()=>import("./en-1.1.0-b0bc0d43.js"),[]),"../locales/ja.json":()=>_e(()=>import("./ja-1.1.0-0635fea6.js"),[]),"../locales/ko.json":()=>_e(()=>import("./ko-1.1.0-f4262f42.js"),[]),"../locales/zh.json":()=>_e(()=>import("./zh-1.1.0-ea7490c2.js"),[])}),`../locales/${s}.json`);Ke[s]=h.default,o(h.default)}catch(h){console.error(`Failed to load translations for ${s}:`,h);try{const y=await _e(()=>import("./en-1.1.0-b0bc0d43.js"),[]);o(y.default)}catch(y){console.error("Failed to load fallback translations:",y)}}finally{r(!1)}})();const f=h=>{t(h.detail)};return window.addEventListener("languageChanged",f),()=>{window.removeEventListener("languageChanged",f)}},[s]),{language:s,setLanguage:l=>{new rt().setLanguage(l)},t:l=>{if(a||!n)return l;const f=l.split(".");let h=n;for(const y of f)if(h=h==null?void 0:h[y],h===void 0)break;return h||l},isLoading:a}},St=()=>{const{language:s,setLanguage:t}=We();return k.jsx("select",{value:s,onChange:n=>t(n.target.value),className:"language-selector","aria-label":"Language selector",children:bt.map(n=>k.jsx("option",{value:n,children:to[n]},n))})};class oo{constructor(){Me(this,"audioCtx",null);Me(this,"enabled",!0)}getContext(){if(!this.enabled)return null;try{if(!this.audioCtx){const t=window.AudioContext||window.webkitAudioContext;if(!t)return console.warn("Web Audio API is not supported in this browser."),this.enabled=!1,null;try{this.audioCtx=new t,this.audioCtx.state==="suspended"&&this.audioCtx.resume().catch(n=>{console.warn("Failed to resume AudioContext",n)})}catch(n){return console.warn("Failed to create AudioContext",n),this.enabled=!1,null}}return this.audioCtx}catch(t){return console.warn("Failed to initialize AudioContext",t),this.enabled=!1,null}}setEnabled(t){this.enabled=t}playTone(t,n,o="sine",a=.2){const r=this.getContext();if(!r)return;const i=r.createOscillator(),u=r.createGain();i.type=o,i.frequency.value=t,u.gain.value=a,i.connect(u),u.connect(r.destination);const l=r.currentTime;i.start(l),i.stop(l+n),u.gain.setValueAtTime(a,l),u.gain.linearRampToValueAtTime(0,l+n)}playClick(){this.playTone(440,.08,"square",.15)}playMatch(){this.playTone(660,.12,"triangle",.2)}playSpecial(){this.playTone(880,.16,"sawtooth",.22)}playStageClear(){this.getContext()&&(this.playTone(880,.15,"triangle",.22),setTimeout(()=>{this.playTone(1046.5,.18,"triangle",.22)},120))}playGameOver(){const t=this.getContext();if(!t)return;const n=440,o=220,a=.4,r=t.createOscillator(),i=t.createGain();r.type="sawtooth",r.frequency.setValueAtTime(n,t.currentTime),r.frequency.exponentialRampToValueAtTime(o,t.currentTime+a),i.gain.value=.22,i.gain.setValueAtTime(.22,t.currentTime),i.gain.linearRampToValueAtTime(0,t.currentTime+a),r.connect(i),i.connect(t.destination),r.start(t.currentTime),r.stop(t.currentTime+a)}}const de=new oo;const at=s=>`/ChipPuzzleGame/${s}`,no=({onNavigate:s,currentScreen:t})=>{const{t:n}=We(),[o,a]=S.useState(()=>{const y=localStorage.getItem("chipPuzzleGame_soundEnabled");return y!==null?JSON.parse(y):!0}),[r,i]=S.useState(!1);S.useEffect(()=>{de.setEnabled(o),localStorage.setItem("chipPuzzleGame_soundEnabled",JSON.stringify(o))},[o]),S.useEffect(()=>(r?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[r]),S.useEffect(()=>{const y=m=>{const g=m.target;r&&!g.closest(".header-nav")&&!g.closest(".header-hamburger")&&i(!1)};if(r)return document.addEventListener("click",y),()=>{document.removeEventListener("click",y)}},[r]);const u=y=>{s&&s(y),i(!1)},l=()=>{a(!o),o||de.playClick()},f=()=>{i(!r),o&&de.playClick()},h=!1;return k.jsx("header",{className:"header",children:k.jsxs("div",{className:"header-content",children:[k.jsxs("div",{className:"header-left",children:[h,k.jsxs("div",{className:"header-logo",onClick:()=>u("stageSelect"),style:{cursor:"pointer",display:"flex",alignItems:"center",gap:"12px"},children:[k.jsx("img",{src:at("ChipGames_Logo.png"),onError:y=>{const m=y.target;m.src&&!m.src.includes(".svg")&&(m.src=at("ChipGames_Logo.svg"))},alt:"CHIP GAMES",style:{height:"40px",width:"auto"}}),k.jsx("span",{className:"header-game-title",children:n("header.gameTitle")})]})]}),k.jsxs("nav",{className:`header-nav ${r?"mobile-open":""}`,children:[k.jsx("button",{className:"header-nav-button",onClick:()=>u("stageSelect"),children:n("header.playGame")}),k.jsx("button",{className:"header-nav-button",onClick:()=>u("guide"),children:n("header.guide")}),k.jsx("button",{className:"header-nav-button",onClick:()=>u("help"),children:n("header.help")})]}),k.jsxs("div",{className:"header-right",children:[k.jsx("button",{className:"header-sound-button",onClick:l,title:n(o?"header.soundOff":"header.soundOn"),children:o?"ðŸ”Š":"ðŸ”‡"}),k.jsx(St,{}),k.jsxs("button",{className:"header-hamburger",onClick:f,"aria-label":"ë©”ë‰´","aria-expanded":r,children:[k.jsx("span",{className:`hamburger-line ${r?"active":""}`}),k.jsx("span",{className:`hamburger-line ${r?"active":""}`}),k.jsx("span",{className:`hamburger-line ${r?"active":""}`})]})]})]})})};const so="1.1.0",ro=()=>{const{t:s}=We();return k.jsx("footer",{className:"footer",children:k.jsxs("div",{className:"footer-content",children:[k.jsxs("div",{className:"footer-links",children:[k.jsx("a",{href:"#privacy",children:s("footer.privacyPolicy")}),k.jsx("a",{href:"#contact",children:s("footer.contactUs")})]}),k.jsx(St,{}),k.jsxs("div",{className:"footer-copyright",children:[s("footer.copyright")," | v",so]})]})})};const ao=({children:s})=>k.jsx("div",{className:"game-container",children:s}),wt={aspectRatio:16/9,gridRows:9,gridCols:9,pixelRatio:window.devicePixelRatio||1};const io=({config:s,onReady:t,onResize:n})=>{const o=S.useRef(null),a=S.useRef(null),r=S.useRef(t),i=S.useRef(n),u=S.useRef(!1);return S.useEffect(()=>{r.current=t},[t]),S.useEffect(()=>{i.current=n},[n]),S.useEffect(()=>{const l=o.current,f=a.current;if(!l||!f)return;const h=l.getContext("2d");if(!h){console.error("Failed to get 2D context");return}const y=()=>{const g=window.devicePixelRatio||1,T=f.clientWidth,Y=f.clientHeight,j=s.aspectRatio||wt.aspectRatio||16/9,W=1200,V=675;let z,O;const D=Math.min(T,W),ce=Math.min(Y,V);D/ce>j?(O=ce,z=O*j):(z=D,O=z/j),l.width=z*g,l.height=O*g,h.scale(g,g),l.style.width=`${z}px`,l.style.height=`${O}px`,l.style.display="block",l.style.maxWidth="100%",l.style.maxHeight="100%",!u.current&&r.current&&(u.current=!0,r.current(l,h)),u.current&&i.current&&setTimeout(()=>{i.current&&i.current(l,h)},0)};y();const m=new ResizeObserver(()=>{y()});return m.observe(f),()=>{m.disconnect(),u.current=!1}},[s]),k.jsx("div",{ref:a,className:"game-canvas-wrapper",children:k.jsx("canvas",{ref:o,className:"game-canvas"})})},Le=["red","yellow","blue","green","purple","orange"],$e={red:{light:"#e74c3c",dark:"#c0392b"},yellow:{light:"#f1c40f",dark:"#f39c12"},blue:{light:"#3498db",dark:"#2980b9"},green:{light:"#2ecc71",dark:"#27ae60"},purple:{light:"#9b59b6",dark:"#8e44ad"},orange:{light:"#e67e22",dark:"#d35400"}};class lo{constructor(t,n){Me(this,"ctx");Me(this,"cellSize");this.ctx=t,this.cellSize=n}render(t,n=1){this.ctx.save();const o=t.x+this.cellSize/2,a=t.y+this.cellSize/2;switch(this.ctx.translate(o,a),this.ctx.scale(t.scale||1,t.scale||1),this.ctx.rotate(t.rotation||0),this.ctx.globalAlpha=n,t.type){case"normal":this.renderNormalGem(t);break;case"striped":this.renderStripedGem(t);break;case"wrapped":this.renderWrappedGem(t);break;case"colorBomb":this.renderColorBomb(t);break}this.ctx.restore()}renderNormalGem(t){const n=$e[t.color],o=this.cellSize*.85,a=-o/2;this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.roundRect(a+2,a+2,o,o,o*.2),this.ctx.fill();const r=this.ctx.createLinearGradient(a,a,a+o,a+o);r.addColorStop(0,n.light),r.addColorStop(1,n.dark),this.ctx.fillStyle=r,this.roundRect(a,a,o,o,o*.2),this.ctx.fill(),this.renderColorPattern(t.color,a,o),this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.roundRect(a,a,o,o*.4,o*.2),this.ctx.fill(),this.ctx.strokeStyle=this.getBorderColor(t.color),this.ctx.lineWidth=o*.06,this.roundRect(a,a,o,o,o*.2),this.ctx.stroke()}getBorderColor(t){return{red:"rgba(231, 76, 60, 0.9)",yellow:"rgba(241, 196, 15, 0.9)",blue:"rgba(52, 152, 219, 0.9)",green:"rgba(46, 204, 113, 0.9)",purple:"rgba(155, 89, 182, 0.9)",orange:"rgba(230, 126, 34, 0.9)"}[t]}renderColorPattern(t,n,o){switch(this.ctx.save(),this.ctx.globalAlpha=.5,t){case"red":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.18,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle="rgba(192, 57, 43, 0.5)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.1,0,Math.PI*2),this.ctx.fill();break;case"yellow":this.ctx.fillStyle="rgba(255, 255, 255, 0.7)",this.drawStar(0,0,o*.1,o*.18,5),this.ctx.fill();break;case"blue":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.moveTo(0,-o*.18),this.ctx.lineTo(o*.18,0),this.ctx.lineTo(0,o*.18),this.ctx.lineTo(-o*.18,0),this.ctx.closePath(),this.ctx.fill();break;case"green":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath(),this.ctx.moveTo(0,-o*.18),this.ctx.lineTo(-o*.15,o*.12),this.ctx.lineTo(o*.15,o*.12),this.ctx.closePath(),this.ctx.fill();break;case"purple":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.fillRect(-o*.12,-o*.12,o*.24,o*.24);break;case"orange":this.ctx.fillStyle="rgba(255, 255, 255, 0.6)",this.ctx.beginPath();for(let a=0;a<6;a++){const r=Math.PI/3*a,i=Math.cos(r)*o*.15,u=Math.sin(r)*o*.15;a===0?this.ctx.moveTo(i,u):this.ctx.lineTo(i,u)}this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle="rgba(211, 84, 0, 0.5)",this.ctx.beginPath(),this.ctx.arc(0,0,o*.08,0,Math.PI*2),this.ctx.fill();break}this.ctx.restore()}renderStripedGem(t){const n=$e[t.color],o=this.cellSize*.85,a=-o/2,r=this.ctx.createLinearGradient(a,a,a+o,a+o);if(r.addColorStop(0,n.light),r.addColorStop(1,n.dark),this.ctx.fillStyle=r,this.roundRect(a,a,o,o,o*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.6)",this.ctx.lineWidth=o*.1,this.ctx.lineCap="round",t.stripedDirection==="horizontal")for(let i=0;i<3;i++){const u=a+o/4*(i+1);this.ctx.beginPath(),this.ctx.moveTo(a,u),this.ctx.lineTo(a+o,u),this.ctx.stroke()}else for(let i=0;i<3;i++){const u=a+o/4*(i+1);this.ctx.beginPath(),this.ctx.moveTo(u,a),this.ctx.lineTo(u,a+o),this.ctx.stroke()}}renderWrappedGem(t){const n=$e[t.color],o=this.cellSize*.85,a=-o/2,r=this.ctx.createLinearGradient(a,a,a+o,a+o);r.addColorStop(0,n.light),r.addColorStop(1,n.dark),this.ctx.fillStyle=r,this.roundRect(a,a,o,o,o*.2),this.ctx.fill(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=o*.08,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(a,a),this.ctx.lineTo(a+o,a+o),this.ctx.moveTo(a+o,a),this.ctx.lineTo(a,a+o),this.ctx.stroke()}renderColorBomb(t){const n=this.cellSize*.85,o=-n/2,a=this.ctx.createLinearGradient(o,o,o+n,o+n);a.addColorStop(0,"#ff6b6b"),a.addColorStop(.2,"#ffd93d"),a.addColorStop(.4,"#4ecdc4"),a.addColorStop(.6,"#95e1d3"),a.addColorStop(.8,"#a29bfe"),a.addColorStop(1,"#fd79a8"),this.ctx.fillStyle=a,this.roundRect(o,o,n,n,n*.2),this.ctx.fill(),this.ctx.fillStyle="rgba(255, 255, 255, 0.9)",this.drawStar(0,0,n*.3,n*.6,5),this.ctx.fill()}roundRect(t,n,o,a,r){this.ctx.beginPath(),this.ctx.moveTo(t+r,n),this.ctx.lineTo(t+o-r,n),this.ctx.quadraticCurveTo(t+o,n,t+o,n+r),this.ctx.lineTo(t+o,n+a-r),this.ctx.quadraticCurveTo(t+o,n+a,t+o-r,n+a),this.ctx.lineTo(t+r,n+a),this.ctx.quadraticCurveTo(t,n+a,t,n+a-r),this.ctx.lineTo(t,n+r),this.ctx.quadraticCurveTo(t,n,t+r,n),this.ctx.closePath()}drawStar(t,n,o,a,r){this.ctx.beginPath();for(let i=0;i<r*2;i++){const u=Math.PI*i/r,l=i%2===0?a:o,f=t+Math.cos(u)*l,h=n+Math.sin(u)*l;i===0?this.ctx.moveTo(f,h):this.ctx.lineTo(f,h)}this.ctx.closePath()}}const it={rows:9,cols:9};function Ge(s){var o,a;const t=[],n=new Set;for(let r=0;r<s.length;r++){let i=1,u=(o=s[r][0])==null?void 0:o.color,l=0;for(let f=1;f<=s[r].length;f++){const h=s[r][f];if(h&&h.color===u&&u)i++;else{if(i>=3&&u){const y=[];for(let m=0;m<i;m++){const g={row:r,col:l+m},T=`${g.row},${g.col}`;n.has(T)||(y.push(g),n.add(T))}y.length>0&&t.push({type:"horizontal",positions:y})}h?(i=1,u=h.color,l=f):(i=0,u=void 0)}}}if(s.length>0)for(let r=0;r<s[0].length;r++){let i=1,u=(a=s[0][r])==null?void 0:a.color,l=0;for(let f=1;f<=s.length;f++){const h=f<s.length?s[f][r]:null;if(h&&h.color===u&&u)i++;else{if(i>=3&&u){const y=[];for(let m=0;m<i;m++){const g={row:l+m,col:r},T=`${g.row},${g.col}`;n.has(T)||(y.push(g),n.add(T))}y.length>0&&t.push({type:"vertical",positions:y})}h?(i=1,u=h.color,l=f):(i=0,u=void 0)}}}return t}class co{constructor(t){Me(this,"seed");this.seed=t}next(){return this.seed=(this.seed*9301+49297)%233280,this.seed/233280}}function lt(s){const t=new co(s),n=uo(s),o=fo(s),a=ho(s),r=po(n.rows,n.cols,t);return{stageNumber:s,gridSize:n,targetScore:o,maxMoves:a,goals:[{type:"score",target:o,current:0}],initialBoard:r}}function uo(s){return s<=100?{rows:9,cols:9}:s<=300?{rows:8,cols:8}:s<=600?{rows:7,cols:7}:{rows:6,cols:6}}function fo(s){const o=Math.floor(s/100)*500;return 1e3+s*50+o}function ho(s){const n=Math.floor(s/20),o=20;return s>500?Math.max(o,50-n-Math.floor((s-500)/10)):Math.max(o,50-n)}function po(s,t,n){const o=[];for(let a=0;a<s;a++){o[a]=[];for(let r=0;r<t;r++){const i=Le[Math.floor(n.next()*Le.length)];o[a][r]={id:`${a}-${r}-${Date.now()}`,color:i,type:"normal",position:{row:a,col:r},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}}return go(o,n)}function go(s,t){var r,i,u,l,f;let o=0;const a=t?()=>t.next():()=>Math.random();try{for(;o<100;){const h=Ge(s);if(h.length===0)return s;for(const y of h)for(const m of y.positions){const g=(r=s[m.row])==null?void 0:r[m.col];if(g){const T=Le.indexOf(g.color),Y=Le.filter((V,z)=>z!==T);if(Y.length===0)continue;let j=g.color,W=0;for(;W<10&&j===g.color;){const V=Math.floor(a()*Y.length),z=Y[V];[(i=s[m.row-1])==null?void 0:i[m.col],(u=s[m.row+1])==null?void 0:u[m.col],(l=s[m.row])==null?void 0:l[m.col-1],(f=s[m.row])==null?void 0:f[m.col+1]].filter(Boolean).some(ce=>(ce==null?void 0:ce.color)===z)?W++:j=z}j===g.color&&Y.length>0&&(j=Y[0]),g.color=j}}o++}}catch(h){console.error("Error in ensureNoInitialMatches:",h)}return s}function ct(s,t=50){var r;const n=s.map(i=>[...i]),o=n.length,a=((r=n[0])==null?void 0:r.length)||0;for(let i=0;i<a;i++){let u=o-1;for(let l=o-1;l>=0;l--)if(n[l][i]!==null){if(u!==l){const f=n[l][i];n[u][i]=f,(f.y===void 0||f.y===0)&&(f.y=l*t),f.targetY=u,f.position.row=u,n[l][i]=null}u--}for(let l=u;l>=0;l--){const f=mo(l,i);f.y=-t*(u-l+1),f.targetY=l,n[l][i]=f}}return n}function mo(s,t){const n=Le[Math.floor(Math.random()*Le.length)];return{id:`${Date.now()}-${s}-${t}-${Math.random()}`,color:n,type:"normal",position:{row:s,col:t},x:0,y:0,targetX:void 0,targetY:void 0,scale:1,rotation:0}}function yo(s){const t=[];for(const n of s){const o=n.positions.length;if(o===4){const a=Math.floor(o/2),r=n.positions[a];t.push({position:r,type:"striped",stripedDirection:n.type==="horizontal"?"horizontal":"vertical"})}else if(o>=5){const a=Math.floor(o/2),r=n.positions[a];t.push({position:r,type:"colorBomb"})}}return t}function bo(s){const t=[],n=s.filter(a=>a.type==="horizontal"),o=s.filter(a=>a.type==="vertical");for(const a of n)for(const r of o){const i=a.positions.find(u=>r.positions.some(l=>u.row===l.row&&u.col===l.col));i&&t.push({position:i,type:"wrapped"})}return t}function So(s){const t=bo(s),n=s.filter(r=>!t.some(i=>{var u,l;return i.position.row===((u=r.positions[0])==null?void 0:u.row)&&i.position.col===((l=r.positions[0])==null?void 0:l.col)})),o=[];o.push(...t);const a=yo(n);for(const r of a)t.some(u=>u.position.row===r.position.row&&u.position.col===r.position.col)||o.push(r);return o}function wo(s,t,n){var i,u,l;const o=[],{row:a,col:r}=s.position;if(n==="horizontal")for(let f=0;f<((i=t[0])==null?void 0:i.length);f++)(u=t[a])!=null&&u[f]&&o.push({row:a,col:f});else for(let f=0;f<t.length;f++)(l=t[f])!=null&&l[r]&&o.push({row:f,col:r});return{positionsToRemove:o,score:o.length*20}}function vo(s,t){var r,i;const n=[],{row:o,col:a}=s.position;for(let u=o-1;u<=o+1;u++)for(let l=a-1;l<=a+1;l++)u>=0&&u<t.length&&l>=0&&l<(((r=t[0])==null?void 0:r.length)||0)&&((i=t[u])!=null&&i[l])&&n.push({row:u,col:l});return{positionsToRemove:n,score:n.length*30}}function Co(s,t){var a,r;const n=[],o=s.color;for(let i=0;i<t.length;i++)for(let u=0;u<(((a=t[i])==null?void 0:a.length)||0);u++){const l=(r=t[i])==null?void 0:r[u];l&&l.color===o&&n.push({row:i,col:u})}return{positionsToRemove:n,score:n.length*50}}function Mo(s,t,n){var u,l,f;const o=[],{row:a,col:r}=s.position;for(let h=0;h<((u=n[0])==null?void 0:u.length);h++)(l=n[a])!=null&&l[h]&&o.push({row:a,col:h});for(let h=0;h<n.length;h++)(f=n[h])!=null&&f[r]&&o.push({row:h,col:r});const i=Array.from(new Set(o.map(h=>`${h.row},${h.col}`))).map(h=>{const[y,m]=h.split(",").map(Number);return{row:y,col:m}});return{positionsToRemove:i,score:i.length*30}}function Ro(s,t,n){var f,h,y,m;const o=[],a=s.type==="striped"?s:t,r=s.type==="wrapped"?s:t,i=a.stripedDirection||"horizontal",{row:u,col:l}=r.position;if(i==="horizontal"){for(let g=u-1;g<=u+1;g++)if(g>=0&&g<n.length)for(let T=0;T<((f=n[0])==null?void 0:f.length);T++)(h=n[g])!=null&&h[T]&&o.push({row:g,col:T})}else for(let g=l-1;g<=l+1;g++)if(g>=0&&g<(((y=n[0])==null?void 0:y.length)||0))for(let T=0;T<n.length;T++)(m=n[T])!=null&&m[g]&&o.push({row:T,col:g});return{positionsToRemove:o,score:o.length*40}}function To(s,t,n){var u,l,f,h;const o=[],a=s.type==="striped"?s:t,r=a.color;if((a.stripedDirection||"horizontal")==="horizontal")for(let y=0;y<n.length;y++)for(let m=0;m<(((u=n[y])==null?void 0:u.length)||0);m++){const g=(l=n[y])==null?void 0:l[m];g&&g.color===r&&o.push({row:y,col:m})}else for(let y=0;y<(((f=n[0])==null?void 0:f.length)||0);y++)for(let m=0;m<n.length;m++){const g=(h=n[m])==null?void 0:h[y];g&&g.color===r&&o.push({row:m,col:y})}return{positionsToRemove:o,score:o.length*60}}function ko(s,t,n){var i,u;const o=[],{row:a,col:r}=s.position;for(let l=a-2;l<=a+2;l++)for(let f=r-2;f<=r+2;f++)l>=0&&l<n.length&&f>=0&&f<(((i=n[0])==null?void 0:i.length)||0)&&((u=n[l])!=null&&u[f])&&o.push({row:l,col:f});return{positionsToRemove:o,score:o.length*50}}function Po(s,t,n){var i,u;const o=[],r=(s.type==="wrapped"?s:t).color;for(let l=0;l<n.length;l++)for(let f=0;f<(((i=n[l])==null?void 0:i.length)||0);f++){const h=(u=n[l])==null?void 0:u[f];h&&h.color===r&&o.push({row:l,col:f})}return{positionsToRemove:o,score:o.length*70}}function Go(s,t,n){var a,r;const o=[];for(let i=0;i<n.length;i++)for(let u=0;u<(((a=n[i])==null?void 0:a.length)||0);u++)(r=n[i])!=null&&r[u]&&o.push({row:i,col:u});return{positionsToRemove:o,score:o.length*100}}function Oo(s,t,n){switch([s.type,t.type].sort().join("+")){case"striped+striped":return Mo(s,t,n);case"striped+wrapped":return Ro(s,t,n);case"colorBomb+striped":return To(s,t,n);case"wrapped+wrapped":return ko(s,t,n);case"colorBomb+wrapped":return Po(s,t,n);case"colorBomb+colorBomb":return Go(s,t,n);default:return null}}function Bo(s,t){switch(s.type){case"striped":return wo(s,t,s.stripedDirection||"horizontal");case"wrapped":return vo(s,t);case"colorBomb":return Co(s,t);default:return{positionsToRemove:[],score:0}}}const Eo=s=>{const[t,n]=S.useState(()=>{const l=lt(s);return{board:l.initialBoard||[],score:0,moves:l.maxMoves,goals:l.goals,isGameOver:!1,isPaused:!1,currentStage:s,isAnimating:!1,selectedGem:null,comboCount:0}});S.useEffect(()=>{const l=lt(s);n({board:l.initialBoard||[],score:0,moves:l.maxMoves,goals:l.goals,isGameOver:!1,isPaused:!1,currentStage:s,isAnimating:!1,selectedGem:null,comboCount:0})},[s]);const o=S.useRef(null),a=S.useCallback((l,f)=>{n(h=>{var m,g;if(h.isGameOver)return h;const y=((m=h.selectedGem)==null?void 0:m.row)===l&&((g=h.selectedGem)==null?void 0:g.col)===f?null:{row:l,col:f};return o.current=y,{...h,selectedGem:y}})},[]),r=S.useCallback((l,f)=>{n(h=>{var z;if(h.isGameOver||h.moves<=0)return h;const y=Math.abs(l.row-f.row),m=Math.abs(l.col-f.col);if(!(y===1&&m===0||y===0&&m===1))return h;const g=h.board.map(O=>O.map(D=>D?{...D}:null)),T=g[l.row][l.col],Y=g[f.row][f.col];if(T&&Y&&T.type!=="normal"&&Y.type!=="normal"){const O=Oo(T,Y,g);if(O){const D=new Set;for(const B of O.positionsToRemove)D.add(`${B.row},${B.col}`);for(const B of D){const[$,se]=B.split(","),d=Number($),ye=Number(se);!Number.isNaN(d)&&!Number.isNaN(ye)&&g[d]&&(g[d][ye]=null)}const ce=ct(g,50),Oe=h.score+O.score,Te=h.goals.map(B=>B.type==="score"?{...B,current:Math.min(B.current+O.score,B.target)}:B),ve=Ge(ce).length>0,pe=Te.every(B=>B.current>=B.target),Ce=h.moves<=0&&!pe;return{...h,board:ce,score:Oe,goals:Te,moves:h.moves-1,isAnimating:ve&&!pe&&!Ce,selectedGem:null,comboCount:0,isGameOver:Ce||h.isGameOver}}}const j=g[l.row][l.col];g[l.row][l.col]=g[f.row][f.col],g[f.row][f.col]=j,g[l.row][l.col]&&(g[l.row][l.col].position={...l}),g[f.row][f.col]&&(g[f.row][f.col].position={...f});const W=Ge(g);if(W.length===0)return h;const V=So(W);for(const O of V){const D=(z=g[O.position.row])==null?void 0:z[O.position.col];D&&(D.type=O.type,O.stripedDirection&&(D.stripedDirection=O.stripedDirection))}return{...h,board:g,moves:h.moves-1,isAnimating:!0,selectedGem:null,comboCount:0}})},[]),i=S.useCallback(()=>{n(l=>{var pe,Ce;if(!l.isAnimating)return l;const f=Ge(l.board);if(f.length===0)return{...l,isAnimating:!1};const h=l.board.map(B=>B.map($=>$?{...$}:null)),y=new Set;let m=0;const g=new Set;for(const B of f)for(const $ of B.positions){const se=(pe=h[$.row])==null?void 0:pe[$.col];se&&se.type!=="normal"&&g.add(`${$.row},${$.col}`)}for(const B of g){const[$,se]=B.split(","),d=Number($),ye=Number(se);if(!Number.isNaN(d)&&!Number.isNaN(ye)&&((Ce=h[d])!=null&&Ce[ye])){const Ee=h[d][ye],Ae=Bo(Ee,h);for(const xe of Ae.positionsToRemove)y.add(`${xe.row},${xe.col}`);m+=Ae.score}}for(const B of f)for(const $ of B.positions)y.add(`${$.row},${$.col}`);for(const B of y){const[$,se]=B.split(","),d=Number($),ye=Number(se);!Number.isNaN(d)&&!Number.isNaN(ye)&&h[d]&&(h[d][ye]=null)}const T=ct(h,50),j=Ge(T).length>0,W=j?l.comboCount+1:0,V=1+Math.min(W,5)*.15,z=f.reduce((B,$)=>{const se=$.positions.length;let d=10;return se>=6?d=80:se>=5?d=40:se>=4&&(d=20),B+se*d},0),O=z+m,D=Math.floor(O*(V-1)),ce=l.score+O+D,Oe=z+m+D,Te=l.goals.map(B=>B.type==="score"?{...B,current:Math.min(B.current+Oe,B.target)}:B),me=Te.every(B=>B.current>=B.target),ve=l.moves<=0&&!me;return{...l,board:T,score:ce,goals:Te,isGameOver:ve||l.isGameOver,isAnimating:j&&!me&&!ve,comboCount:W}})},[]),u=S.useCallback(()=>{n(l=>({...l,isPaused:!l.isPaused}))},[]);return{gameState:t,selectGem:a,swapGems:r,processMatches:i,togglePause:u}};function ut(s){const{score:t,goals:n,moves:o,currentStage:a}=s;if(n.length===0)return 0;const r=n[0];if(r.current<r.target)return 0;const i=r.current/r.target,u=Math.max(20,50-Math.floor(a/20)),l=o/u,f=Math.min(t/(r.target*1.5),1);let h=0;return i>=1&&(h=1,(i>=1.2||l>=.4)&&(h=2),i>=1.5&&l>=.5&&f>=.8&&(h=3)),Math.min(h,3)}class Ao{constructor(t){Me(this,"particles",[]);Me(this,"ctx");this.ctx=t}emit(t,n,o,a=20){const r=$e[o];for(let i=0;i<a;i++){const u=Math.PI*2*i/a+Math.random()*.5,l=2+Math.random()*3;this.particles.push({x:t,y:n,vx:Math.cos(u)*l,vy:Math.sin(u)*l,life:1,maxLife:1,color:Math.random()>.5?r.light:r.dark,size:3+Math.random()*4,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}emitExplosion(t,n,o,a=50,r=30){const i=$e[o];for(let u=0;u<r;u++){const l=Math.random()*Math.PI*2,f=Math.random()*a,h=1+Math.random()*2;this.particles.push({x:t+Math.cos(l)*f*.3,y:n+Math.sin(l)*f*.3,vx:Math.cos(l)*h,vy:Math.sin(l)*h,life:1,maxLife:1,color:Math.random()>.5?i.light:i.dark,size:4+Math.random()*6,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.3})}}update(t=16){for(let n=this.particles.length-1;n>=0;n--){const o=this.particles[n];o.x+=o.vx,o.y+=o.vy,o.vy+=.1,o.vx*=.98,o.vy*=.98,o.rotation+=o.rotationSpeed,o.life-=t/1e3,o.life<=0&&this.particles.splice(n,1)}}render(){this.ctx.save();for(const t of this.particles){const n=t.life/t.maxLife,o=t.size*n;this.ctx.globalAlpha=n,this.ctx.fillStyle=t.color,this.ctx.translate(t.x,t.y),this.ctx.rotate(t.rotation),this.ctx.fillRect(-o/2,-o/2,o,o),this.ctx.setTransform(1,0,0,1,0,0)}this.ctx.globalAlpha=1,this.ctx.restore()}clear(){this.particles=[]}get count(){return this.particles.length}}function ft(s){var r,i,u,l;const t=s.length,n=((r=s[0])==null?void 0:r.length)||0,o=[],a=[];for(let f=0;f<t;f++)for(let h=0;h<n;h++){const y=(i=s[f])==null?void 0:i[h];if(y){if(h<n-1){const m=(u=s[f])==null?void 0:u[h+1];if(m&&m.color!==y.color){const g=ht(s,f,h,f,h+1),T=Ge(g);if(T.length>0){const Y=T.some(W=>W.positions.length>=4),j={from:{row:f,col:h},to:{row:f,col:h+1}};Y?o.push(j):a.push(j)}}}if(f<t-1){const m=(l=s[f+1])==null?void 0:l[h];if(m&&m.color!==y.color){const g=ht(s,f,h,f+1,h),T=Ge(g);if(T.length>0){const Y=T.some(W=>W.positions.length>=4),j={from:{row:f,col:h},to:{row:f+1,col:h}};Y?o.push(j):a.push(j)}}}}}return o.length>0?o[0]:a.length>0?a[0]:null}function ht(s,t,n,o,a){const r=s.map(u=>u.map(l=>l?{...l}:null)),i=r[t][n];return r[t][n]=r[o][a],r[o][a]=i,r}const xo=({stageNumber:s=1,currentScreen:t="stageSelect",onNavigate:n,onStartStage:o})=>{const a=S.useRef(!1),r=S.useRef(null),i=S.useRef(null),u=S.useRef(null),l=S.useRef(null),f=S.useRef(null),h=S.useRef(null),y=S.useRef(new Map),m=S.useRef(null),g=S.useRef(!1),T=S.useRef(null),Y=S.useRef(""),j=S.useRef(!1),W=S.useRef(null),V=S.useRef(null),z=S.useRef(null),O=S.useRef(null),D=S.useRef(!1),ce=S.useRef(!1),Oe=S.useRef(!1),Te=S.useRef(!1),[me,ve]=S.useState(!1),{t:pe}=We(),[Ce,B]=S.useState(1),[$,se]=S.useState(1),{gameState:d,selectGem:ye,swapGems:Ee,processMatches:Ae,togglePause:xe}=Eo(s),[re,vt]=S.useState(()=>{const b=it.cols,G=it.rows;return{aspectRatio:wt.aspectRatio,cellSize:50,gridRows:G,gridCols:b,pixelRatio:window.devicePixelRatio||1,logicalWidth:0,logicalHeight:0}});S.useEffect(()=>{var e;if(t==="game"&&d.board.length>0){const b=d.board.length,G=((e=d.board[0])==null?void 0:e.length)||9;vt(R=>({...R,gridRows:b,gridCols:G}))}},[t,d.board,s]),S.useEffect(()=>{const e=localStorage.getItem("chipPuzzleGame_progress");if(e)try{const b=JSON.parse(e);B(Math.max(1,b.highestStage||1))}catch(b){console.error("Failed to load progress",b)}},[]);const Qe=S.useCallback((e,b,G)=>{const c=b/1200;e.fillStyle="#1a1a1a",e.fillRect(0,0,b,G),e.fillStyle="#fff";const ne=Math.max(16,32*c);e.font=`bold ${ne}px Arial`,e.textAlign="center",e.fillText(pe("stageSelect.title"),b/2,50*c);const w=8,ue=60,Re=15,M=ue*c,ge=Re*c,q=(b-(w*M+(w-1)*ge))/2,U=100*c,K=1e3,ee=50,ae=Math.ceil(K/ee),te=($-1)*ee+1,X=Math.min(te+ee-1,K);for(let v=0;v<ee&&te+v<=X;v++){const A=te+v,F=Math.floor(v/w),I=v%w,p=q+I*(M+ge),N=U+F*(M+ge),P=A<=Ce;if(P){const E=e.createLinearGradient(p,N,p+M,N+M);E.addColorStop(0,"#667eea"),E.addColorStop(1,"#764ba2"),e.fillStyle=E}else e.fillStyle="#1a1a1a";e.fillRect(p,N,M,M),e.strokeStyle=P?"#667eea":"#444",e.lineWidth=Math.max(1,2*c),e.strokeRect(p,N,M,M),e.fillStyle="#fff";const _=Math.max(12,20*c);if(e.font=`bold ${_}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText(A.toString(),p+M/2,N+M/2),!P){e.fillStyle="#ffa500";const E=Math.max(16,24*c);e.font=`${E}px Arial`,e.fillText("ðŸ”’",p+M/2,N+M/2-10*c)}}const ie=G-60*c;e.fillStyle="#fff",e.font=`bold ${Math.max(12,18*c)}px Arial`,e.textAlign="center",e.fillText(`${pe("stageSelect.page")} ${$} / ${ae}`,b/2,ie);const J=30*c,fe=80*c,he=ie+20*c,ke=10*c;if($>1){const v=b/2-fe-ke/2;e.fillStyle=$>1?"#667eea":"#444",e.fillRect(v,he,fe,J),e.strokeStyle="#fff",e.lineWidth=Math.max(1,2*c),e.strokeRect(v,he,fe,J),e.fillStyle="#fff",e.font=`bold ${Math.max(10,14*c)}px Arial`,e.fillText("Â«",v+fe/2,he+J/2+4*c)}if($<ae){const v=b/2+ke/2;e.fillStyle=$<ae?"#667eea":"#444",e.fillRect(v,he,fe,J),e.strokeStyle="#fff",e.lineWidth=Math.max(1,2*c),e.strokeRect(v,he,fe,J),e.fillStyle="#fff",e.font=`bold ${Math.max(10,14*c)}px Arial`,e.fillText("Â»",v+fe/2,he+J/2+4*c)}},[Ce,pe,$]),et=S.useCallback((e,b,G)=>{const c=b/1200;e.fillStyle="#1a1a1a",e.fillRect(0,0,b,G);const w=(re.cellSize||50)*c,ue=re.gridCols||9,Re=re.gridRows||9,M=w*ue,ge=w*Re,q=(b-M)/2,U=(G-ge)/2;(!u.current||l.current!==w)&&(u.current=new lo(e,w),l.current=w),f.current||(f.current=new Ao(e)),e.save(),e.globalAlpha=.9,e.fillStyle="rgba(22, 22, 46, 0.8)",e.beginPath(),e.roundRect(q,U,M,ge,8*c),e.fill(),e.restore(),e.strokeStyle="rgba(255, 255, 255, 0.08)",e.lineWidth=Math.max(.5,1*c);for(let v=0;v<=Re;v++){const A=U+v*w;e.beginPath(),e.moveTo(q,A),e.lineTo(q+M,A),e.stroke()}for(let v=0;v<=ue;v++){const A=q+v*w;e.beginPath(),e.moveTo(A,U),e.lineTo(A,U+ge),e.stroke()}const K=Math.max(10,20*c),ee=24*c,ae=24*c,te=K+8*c,X=ae,ie=16*c,J=16*c,fe=280*c,he=te*4+ie*2;if(e.save(),e.globalAlpha=.9,e.fillStyle="rgba(15, 15, 30, 0.8)",e.beginPath(),e.roundRect(ee-ie,ae-ie,fe,he,J),e.fill(),e.strokeStyle="rgba(102, 126, 234, 0.3)",e.lineWidth=1*c,e.stroke(),e.restore(),e.textAlign="left",e.textBaseline="top",e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=4*c,e.shadowOffsetX=0,e.shadowOffsetY=2*c,e.font=`600 ${K}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.fillStyle="#ffffff",e.fillText(`Score: ${d.score.toLocaleString()}`,ee,X),e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillText(`Moves: ${d.moves}`,ee,X+te),d.goals.length>0){const v=d.goals[0],A=v.current/v.target;e.fillStyle=A>=1?"#4ecdc4":"rgba(255, 255, 255, 0.9)",e.fillText(`Goal: ${v.current.toLocaleString()}/${v.target.toLocaleString()}`,ee,X+te*2)}if(d.comboCount>0&&(e.shadowColor="rgba(255, 217, 61, 0.6)",e.shadowBlur=12*c,e.font=`700 ${Math.max(14,24*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.fillStyle="#ffd93d",e.textAlign="left",e.fillText(`Combo x${d.comboCount}!`,ee,X+te*3),e.shadowColor="rgba(0, 0, 0, 0.5)",e.shadowBlur=4*c),e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,!d.isGameOver&&!d.isAnimating){const F=20*c,I=10*c,p=Math.max(60,120*c),N=Math.max(24,40*c),P=Math.max(60,120*c),_=Math.max(24,40*c),E=b-p-F,H=F,C=12*c,x=e.createLinearGradient(E,H,E,H+N);x.addColorStop(0,me?"#4ecdc4":"#667eea"),x.addColorStop(1,me?"#44a08d":"#764ba2"),e.save(),e.beginPath(),e.roundRect(E,H,p,N,C),e.fillStyle=x,e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=Math.max(1,1.5*c),e.stroke(),e.restore(),e.shadowColor=me?"rgba(78, 205, 196, 0.4)":"rgba(102, 126, 234, 0.4)",e.shadowBlur=8*c,e.shadowOffsetX=0,e.shadowOffsetY=2*c,e.fillStyle="#ffffff";const oe=Math.max(10,16*c);e.font=`600 ${oe}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText("Hint",E+p/2,H+N/2),e.shadowColor="transparent",e.shadowBlur=0;const le=E-P-I,be=F,Q=e.createLinearGradient(le,be,le,be+_);d.isPaused?(Q.addColorStop(0,"#ff6b6b"),Q.addColorStop(1,"#ee5a6f")):(Q.addColorStop(0,"#667eea"),Q.addColorStop(1,"#764ba2")),e.save(),e.beginPath(),e.roundRect(le,be,P,_,C),e.fillStyle=Q,e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=Math.max(1,1.5*c),e.stroke(),e.restore(),e.shadowColor=d.isPaused?"rgba(255, 107, 107, 0.4)":"rgba(102, 126, 234, 0.4)",e.shadowBlur=8*c,e.shadowOffsetX=0,e.shadowOffsetY=2*c,e.fillStyle="#ffffff";const Se=Math.max(10,16*c);e.font=`600 ${Se}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(d.isPaused?pe("game.resume"):pe("game.pause"),le+P/2,be+_/2),e.shadowColor="transparent",e.shadowBlur=0}if(d.isPaused&&!d.isGameOver){e.fillStyle="rgba(15, 15, 30, 0.85)",e.fillRect(0,0,b,G);const v=400*c,A=200*c,F=(b-v)/2,I=(G-A)/2,p=24*c;e.save(),e.globalAlpha=.95,e.fillStyle="rgba(26, 26, 46, 0.9)",e.beginPath(),e.roundRect(F,I,v,A,p),e.fill(),e.strokeStyle="rgba(102, 126, 234, 0.3)",e.lineWidth=2*c,e.stroke(),e.restore(),e.shadowColor="rgba(102, 126, 234, 0.5)",e.shadowBlur=12*c,e.shadowOffsetX=0,e.shadowOffsetY=0,e.fillStyle="#ffffff",e.font=`700 ${Math.max(28,56*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(pe("game.pause"),b/2,I+A/2-30*c),e.shadowColor="transparent",e.shadowBlur=0,e.fillStyle="rgba(255, 255, 255, 0.7)",e.font=`500 ${Math.max(14,20*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.fillText(pe("game.resume"),b/2,I+A/2+20*c)}if(d.isGameOver){e.fillStyle="rgba(15, 15, 30, 0.9)",e.fillRect(0,0,b,G);const v=450*c,A=300*c,F=(b-v)/2,I=(G-A)/2,p=24*c;e.save(),e.globalAlpha=.95,e.fillStyle="rgba(26, 26, 46, 0.9)",e.beginPath(),e.roundRect(F,I,v,A,p),e.fill(),e.strokeStyle="rgba(255, 107, 107, 0.3)",e.lineWidth=2*c,e.stroke(),e.restore(),e.shadowColor="rgba(255, 107, 107, 0.5)",e.shadowBlur=12*c,e.fillStyle="#ff6b6b",e.font=`700 ${Math.max(28,56*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText("Game Over!",b/2,I+60*c),e.shadowColor="transparent",e.shadowBlur=0,e.fillStyle="rgba(255, 255, 255, 0.9)",e.font=`600 ${Math.max(16,24*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.fillText(`Final Score: ${d.score.toLocaleString()}`,b/2,I+120*c);const N=b/2-110*c,P=I+180*c,_=220*c,E=56*c,H=14*c,C=e.createLinearGradient(N,P,N,P+E);C.addColorStop(0,"#ff6b6b"),C.addColorStop(1,"#ee5a6f"),e.save(),e.beginPath(),e.roundRect(N,P,_,E,H),e.fillStyle=C,e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=2*c,e.stroke(),e.restore(),e.shadowColor="rgba(255, 107, 107, 0.4)",e.shadowBlur=8*c,e.shadowOffsetX=0,e.shadowOffsetY=2*c,e.fillStyle="#ffffff",e.font=`600 ${Math.max(16,22*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText("Retry",b/2,P+E/2),e.shadowColor="transparent",e.shadowBlur=0}const ke=d.goals.every(v=>v.current>=v.target);if(d.isAnimating){const v=Ge(d.board),A=new Set;for(const F of v)for(const I of F.positions)A.add(`${I.row},${I.col}`);A.forEach(F=>{const[I,p]=F.split(","),N=Number(I),P=Number(p);if(!Number.isNaN(N)&&!Number.isNaN(P)&&N>=0&&N<Re&&P>=0&&P<ue){const _=q+P*w,E=U+N*w,H=Date.now()%1e3,C=.3+Math.sin(H/1e3*Math.PI*2)*.2;e.fillStyle=`rgba(255, 215, 61, ${C})`,e.strokeStyle="#ffd93d",e.lineWidth=Math.max(2,3*c),e.strokeRect(_,E,w,w),e.fillRect(_,E,w,w)}})}if(d.board&&d.board.length>0&&u.current){let v=!1;d.board.forEach((F,I)=>{F&&F.forEach((p,N)=>{if(p){const P=q+N*w,_=U+I*w;if(D.current&&W.current&&z.current&&V.current){const C=W.current,x=z.current,oe=V.current;if(I===C.row&&N===C.col)if(O.current){const le=O.current.x-oe.x,be=O.current.y-oe.y,Q=w,Se=Math.max(-Q,Math.min(Q,le)),Ne=Math.max(-Q,Math.min(Q,be));p.x=P+Se,p.y=_+Ne}else p.x=P,p.y=_;else if(I===x.row&&N===x.col)if(O.current){const le=O.current.x-oe.x,be=O.current.y-oe.y,Q=w,Se=Math.max(-Q,Math.min(Q,-le)),Ne=Math.max(-Q,Math.min(Q,-be));p.x=P+Se,p.y=_+Ne}else p.x=P,p.y=_;else p.x=P,p.y=_}else if(p.targetY!==void 0){v=!0;let C;p.targetY<100?C=U+p.targetY*w:C=p.targetY,(p.y===void 0||p.y===0)&&(p.y=_);const x=C-p.y,oe=.15;Math.abs(x)>1?(p.y+=x*oe,x>0&&(p.y+=1)):(p.y=C,p.targetY=void 0),p.x=P}else if(p.targetX!==void 0){const C=p.targetX-p.x,x=.2;Math.abs(C)>.1?p.x+=C*x:(p.x=p.targetX,p.targetX=void 0),p.y=_}else(p.x===0&&p.y===0&&p.targetX===void 0&&p.targetY===void 0||p.x!==P||p.y!==_)&&(p.x=P,p.y=_);d.selectedGem&&d.selectedGem.row===I&&d.selectedGem.col===N&&(e.fillStyle="rgba(255, 255, 255, 0.3)",e.strokeStyle="rgba(255, 255, 255, 0.8)",e.lineWidth=Math.max(2,3*c),e.strokeRect(P,_,w,w),e.fillRect(P,_,w,w)),me&&m.current&&(m.current.from.row===I&&m.current.from.col===N||m.current.to.row===I&&m.current.to.col===N)&&(e.fillStyle="rgba(255, 215, 61, 0.4)",e.strokeStyle="#ffd93d",e.lineWidth=Math.max(3,4*c),e.strokeRect(P,_,w,w),e.fillRect(P,_,w,w));let E=1,H=p.scale||1;if(p.isRemoving){let C=y.current.get(p.id);C||(C={alpha:1,scale:1},y.current.set(p.id,C)),C.alpha=Math.max(0,C.alpha-.08),C.scale=Math.max(0,C.scale-.08),E=C.alpha,H=C.scale,p.alpha=E,p.scale=H,y.current.set(p.id,C)}else p.alpha=1,p.scale=1;if(E>0){const C=ke&&!d.isAnimating?E*.3:E;u.current.render(p,C)}if(p.isRemoving&&E>.8&&E<.9&&f.current){const C=p.x+w/2,x=p.y+w/2;f.current.emit(C,x,p.color,15)}}})});const A=g.current;g.current=v,A&&!v&&d.isAnimating&&t==="game"&&!d.isGameOver&&!j.current&&setTimeout(()=>{d.isAnimating&&t==="game"&&!d.isGameOver&&!j.current&&(j.current=!0,Ae(),setTimeout(()=>{j.current=!1,Y.current=""},200))},100)}if(f.current&&(f.current.update(16),f.current.render()),ke&&!d.isAnimating&&!d.isGameOver){const v=ut(d);e.fillStyle="rgba(15, 15, 30, 0.92)",e.fillRect(0,0,b,G);const A=500*c,F=400*c,I=(b-A)/2,p=(G-F)/2,N=28*c;e.save(),e.globalAlpha=.96,e.fillStyle="rgba(26, 26, 46, 0.9)",e.beginPath(),e.roundRect(I,p,A,F,N),e.fill(),e.strokeStyle="rgba(78, 205, 196, 0.4)",e.lineWidth=2*c,e.stroke(),e.restore(),e.shadowColor="rgba(78, 205, 196, 0.5)",e.shadowBlur=12*c,e.shadowOffsetX=0,e.shadowOffsetY=0,e.fillStyle="#4ecdc4",e.font=`700 ${Math.max(32,64*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText("Stage Cleared!",b/2,p+80*c);const P=Math.max(24,48*c),_=P*1.8,E=b/2-_,H=p+160*c;for(let Se=0;Se<3;Se++){const Ne=E+Se*_;e.shadowColor=Se<v?"rgba(255, 217, 61, 0.6)":"transparent",e.shadowBlur=Se<v?12*c:0,e.fillStyle=Se<v?"#ffd93d":"rgba(102, 102, 102, 0.5)",e.font=`${P}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText("â˜…",Ne,H)}e.shadowColor="transparent",e.shadowBlur=0,e.fillStyle="rgba(255, 255, 255, 0.9)",e.font=`600 ${Math.max(18,28*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.fillText(`Score: ${d.score.toLocaleString()}`,b/2,p+220*c);const C=b/2-120*c,x=p+280*c,oe=240*c,le=60*c,be=16*c,Q=e.createLinearGradient(C,x,C,x+le);Q.addColorStop(0,"#667eea"),Q.addColorStop(1,"#764ba2"),e.save(),e.beginPath(),e.roundRect(C,x,oe,le,be),e.fillStyle=Q,e.fill(),e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=2*c,e.stroke(),e.restore(),e.shadowColor="rgba(102, 126, 234, 0.4)",e.shadowBlur=8*c,e.shadowOffsetX=0,e.shadowOffsetY=2*c,e.fillStyle="#ffffff",e.font=`600 ${Math.max(16,22*c)}px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText("Next Stage",b/2,x+le/2),e.shadowColor="transparent",e.shadowBlur=0}},[re,d,me]),Pe=S.useCallback(()=>{const e=r.current,b=i.current;if(!e||!b)return;const G=window.devicePixelRatio||1,R=e.width/G,c=e.height/G;R===0||c===0||(t==="stageSelect"?Qe(b,R,c):t==="game"?et(b,R,c):(b.fillStyle="#1a1a1a",b.fillRect(0,0,R,c)))},[t,Qe,et]);S.useEffect(()=>{let e=0;const G=1e3/60,R=()=>{const c=ne=>{ne-e>=G&&(Pe(),e=ne),h.current=requestAnimationFrame(c)};h.current=requestAnimationFrame(c)};return r.current&&i.current&&R(),()=>{h.current!==null&&(cancelAnimationFrame(h.current),h.current=null)}},[Pe]);const Ct=S.useCallback((e,b)=>{a.current||(a.current=!0,r.current=e,i.current=b,Pe())},[Pe]),Mt=S.useCallback((e,b)=>{r.current=e,i.current=b,Pe()},[Pe]);S.useEffect(()=>{if(r.current&&i.current){const e=setTimeout(()=>{Pe()},10);return()=>clearTimeout(e)}},[Pe,t,Ce,s,d]),S.useEffect(()=>{if(d.isAnimating&&t==="game"&&!d.isGameOver&&!j.current){const e=JSON.stringify(d.board);if(e!==Y.current)return j.current=!0,Y.current=e,T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{const G=()=>{g.current?setTimeout(G,50):(Ae(),setTimeout(()=>{j.current=!1,Y.current=""},200))};G()},300),()=>{T.current&&(clearTimeout(T.current),T.current=null)}}else d.isAnimating||(Y.current="",j.current=!1)},[d.isAnimating,d.board,Ae,t,d.isGameOver]),S.useEffect(()=>{if(t!=="game"){Oe.current=!1,Te.current=!1;return}const e=d.goals.every(b=>b.current>=b.target);if(!Oe.current&&d.isGameOver&&(console.log("Game Over!",d.score),de.playGameOver()),!Te.current&&e&&!d.isGameOver){console.log("Stage Cleared!",d.score),de.playStageClear();try{const b=ut(d),G=localStorage.getItem("chipPuzzleGame_progress");let R={highestStage:1,stageRecords:{}};if(G)try{R=JSON.parse(G)}catch(ue){console.error("Failed to parse progress",ue)}const c=d.currentStage;c>=R.highestStage&&(R.highestStage=c+1),R.stageRecords||(R.stageRecords={});const ne=c.toString(),w=R.stageRecords[ne];!w||d.score>w.bestScore?R.stageRecords[ne]={stageNumber:c,stars:Math.max((w==null?void 0:w.stars)||0,b),score:d.score,bestScore:d.score,completedAt:new Date().toISOString(),attempts:((w==null?void 0:w.attempts)||0)+1}:R.stageRecords[ne]={...w,stars:Math.max(w.stars,b),attempts:w.attempts+1},localStorage.setItem("chipPuzzleGame_progress",JSON.stringify(R))}catch(b){console.error("Failed to save progress",b)}}Oe.current=d.isGameOver,Te.current=e},[d.isGameOver,d.goals,d.score,d.currentStage,t]);const Xe=S.useCallback(e=>{if(ce.current){ce.current=!1;return}const b=r.current;if(!b)return;const G=b.getBoundingClientRect(),R=e.clientX-G.left,c=e.clientY-G.top,ne=window.devicePixelRatio||1,w=b.width/ne,ue=b.height/ne;if(t==="stageSelect"){if(!o)return;const M=w/1200,ge=120,q=40,U=20*M,K=Math.max(60,ge*M),ee=Math.max(24,q*M),ae=w-K-U,te=U;if(R>=ae&&R<=ae+K&&c>=te&&c<=te+ee){if(me)ve(!1),m.current=null;else{const x=ft(d.board);x&&(m.current=x,ve(!0),setTimeout(()=>{ve(!1),m.current=null},3e3))}return}const X=50,ie=1e3,J=Math.ceil(ie/X),fe=30*M,he=80*M,v=ue-60*M+20*M,A=10*M;if($>1){const x=w/2-he-A/2;if(R>=x&&R<=x+he&&c>=v&&c<=v+fe){se($-1),de.playClick();return}}if($<J){const x=w/2+A/2;if(R>=x&&R<=x+he&&c>=v&&c<=v+fe){se($+1),de.playClick();return}}const F=8,I=60,p=15,N=I*M,P=p*M,_=(w-(F*N+(F-1)*P))/2,E=100*M,H=Math.floor((R-_)/(N+P)),C=Math.floor((c-E)/(N+P));if(H>=0&&H<F&&C>=0){const oe=($-1)*X+1+C*F+H;oe<=Ce&&oe<=ie&&o(oe)}}else if(t==="game"){const M=w/1200;if(d.goals.every(C=>C.current>=C.target)&&!d.isAnimating&&!d.isGameOver){const C=w/2-100*M,x=ue/2+80*M,oe=200*M,le=50*M;if(R>=C&&R<=C+oe&&c>=x&&c<=x+le){if(o){const be=s+1;o(be)}de.playClick();return}return}if(d.isGameOver){const C=w/2-100*M,x=ue/2+100*M,oe=200*M,le=50*M;if(R>=C&&R<=C+oe&&c>=x&&c<=x+le){o&&o(s),de.playClick();return}return}if(d.isPaused){xe(),de.playClick();return}const q=120,U=40,K=20*M,ee=10*M,ae=Math.max(60,q*M),te=Math.max(24,U*M),X=Math.max(60,q*M),ie=Math.max(24,U*M),J=w-ae-K,fe=K,he=J-X-ee,ke=K;if(R>=he&&R<=he+X&&c>=ke&&c<=ke+ie){xe(),de.playClick();return}if(R>=J&&R<=J+ae&&c>=fe&&c<=fe+te){if(me)ve(!1),m.current=null;else{const C=ft(d.board);C&&(m.current=C,ve(!0),setTimeout(()=>{ve(!1),m.current=null},3e3))}de.playClick();return}if(d.isPaused)return;const A=(re.cellSize||50)*M,F=re.gridCols||9,I=re.gridRows||9,p=A*F,N=A*I,P=(w-p)/2,_=(ue-N)/2,E=Math.floor((R-P)/A),H=Math.floor((c-_)/A);E>=0&&E<F&&H>=0&&H<I&&d.board[H]&&d.board[H][E]&&(d.selectedGem?Ee(d.selectedGem,{row:H,col:E}):ye(H,E),de.playClick())}},[t,o,Ce,re,d,ye,Ee,me,xe]),He=S.useCallback(e=>{const b=r.current;if(!b||t!=="game"||d.isPaused)return;const G=b.getBoundingClientRect(),R=e.clientX-G.left,c=e.clientY-G.top,ne=window.devicePixelRatio||1,w=b.width/ne,ue=b.height/ne,M=w/1200,q=(re.cellSize||50)*M,U=re.gridCols||9,K=re.gridRows||9,ee=q*U,ae=q*K,te=(w-ee)/2,X=(ue-ae)/2,ie=Math.floor((R-te)/q),J=Math.floor((c-X)/q);ie>=0&&ie<U&&J>=0&&J<K&&d.board[J]&&d.board[J][ie]&&(W.current={row:J,col:ie},V.current={x:R,y:c},D.current=!0)},[t,re,d.board,d.isPaused]),Ue=S.useCallback(e=>{const b=r.current;if(!b||t!=="game"||d.isPaused||!D.current||!W.current||!V.current)return;const G=b.getBoundingClientRect(),R=e.clientX-G.left,c=e.clientY-G.top,ne=window.devicePixelRatio||1,Re=b.width/ne/1200,M=re.gridCols||9,ge=re.gridRows||9,q=V.current,U=R-q.x,K=c-q.y,ee=Math.sqrt(U*U+K*K),ae=10*Re;if(ee<ae){O.current={x:R,y:c},z.current=null;return}const te=W.current;let X={row:te.row,col:te.col};if(Math.abs(U)>Math.abs(K)?U>0?X.col+=1:X.col-=1:K>0?X.row+=1:X.row-=1,X.col<0||X.col>=M||X.row<0||X.row>=ge){D.current=!1,W.current=null,V.current=null,z.current=null,O.current=null;return}O.current={x:R,y:c},z.current=X},[t,re,d.isPaused]),Be=S.useCallback(()=>{if(D.current&&W.current&&z.current){const e=W.current,b=z.current,G=Math.abs(e.row-b.row),R=Math.abs(e.col-b.col);(G===1&&R===0||G===0&&R===1)&&(Ee(e,b),de.playClick(),ce.current=!0)}D.current=!1,W.current=null,V.current=null,z.current=null,O.current=null},[Ee]);return S.useEffect(()=>{const e=r.current;if(e)return e.addEventListener("click",Xe),()=>{e.removeEventListener("click",Xe)}},[Xe]),S.useEffect(()=>{const e=r.current;if(e)return e.addEventListener("pointerdown",He),e.addEventListener("pointermove",Ue),e.addEventListener("pointerup",Be),e.addEventListener("pointerleave",Be),e.addEventListener("pointercancel",Be),()=>{e.removeEventListener("pointerdown",He),e.removeEventListener("pointermove",Ue),e.removeEventListener("pointerup",Be),e.removeEventListener("pointerleave",Be),e.removeEventListener("pointercancel",Be)}},[He,Ue,Be]),k.jsx("div",{className:"game-board",children:k.jsx(io,{config:re,onReady:Ct,onResize:Mt})})};const Lo=()=>{const[s,t]=S.useState("stageSelect"),[n,o]=S.useState(null),a=i=>{t(i)},r=i=>{o(i),t("game")};return k.jsx(Kt,{children:k.jsxs("div",{className:"app-container",children:[k.jsx(no,{onNavigate:a,currentScreen:s}),k.jsx(ao,{children:k.jsx(xo,{stageNumber:n||1,currentScreen:s,onNavigate:a,onStartStage:r})}),k.jsx(ro,{})]})})};Je.createRoot(document.getElementById("root")).render(k.jsx(Ie.StrictMode,{children:k.jsx(je,{children:k.jsx(Lo,{})})}));
